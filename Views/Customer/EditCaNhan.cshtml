@model QuanLyRuiRoTinDung.Models.Entities.KhachHangCaNhan
@{
    ViewData["Title"] = "Cập nhật khách hàng cá nhân";
    Layout = "_DashboardLayout";
}

<div class="form-container">
    <div class="form-header">
        <div class="header-top">
            <a href="@Url.Action("DetailsCaNhan", "Customer", new { id = Model.MaKhachHang })" class="back-button" title="Quay lại">
                <img src="~/asset/image/icons8-back-arrow-80.png" alt="Quay lại" />
            </a>
            <div class="header-content">
                <h1 class="form-title">Cập nhật khách hàng cá nhân</h1>
                <p class="form-subtitle">Chỉnh sửa thông tin khách hàng cá nhân</p>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success success-notification">
            <div class="success-icon">✓</div>
            <div class="success-message">
                <strong>Thành công!</strong>
                <p>@TempData["SuccessMessage"]</p>
            </div>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger error-notification">
            <div class="error-icon">✕</div>
            <div class="error-message">
                <strong>Lỗi!</strong>
                <p>@TempData["ErrorMessage"]</p>
            </div>
        </div>
    }

    <form asp-action="EditCaNhan" method="post" enctype="multipart/form-data" class="customer-form">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="MaKhachHang" />
        <input type="hidden" asp-for="MaKhachHangCode" />
        <input type="hidden" asp-for="NguoiTao" />
        <input type="hidden" asp-for="NgayTao" />
        <input type="hidden" asp-for="TrangThaiHoatDong" />
        <input type="hidden" asp-for="DiemTinDung" />
        <input type="hidden" asp-for="XepHangTinDung" />
        
        @if (!ViewData.ModelState.IsValid)
        {
            <div asp-validation-summary="ModelOnly" class="text-danger validation-summary"></div>
        }

        <!-- Thông tin định danh (không thể sửa) -->
        <div class="form-section readonly-section">
            <h3 class="section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;margin-right:8px;">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                Thông tin định danh (không thể sửa)
            </h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Mã khách hàng</label>
                    <div class="readonly-value">@Model.MaKhachHangCode</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Họ và tên</label>
                    <div class="readonly-value">@Model.HoTen</div>
                    <input type="hidden" asp-for="HoTen" />
                </div>
                <div class="form-group">
                    <label class="form-label">Số CCCD/CMND</label>
                    <div class="readonly-value">@Model.SoCmnd</div>
                    <input type="hidden" asp-for="SoCmnd" />
                </div>
                <div class="form-group">
                    <label class="form-label">Ngày sinh</label>
                    <div class="readonly-value">@Model.NgaySinh?.ToString("dd/MM/yyyy")</div>
                    <input type="hidden" asp-for="NgaySinh" />
                </div>
                <div class="form-group">
                    <label class="form-label">Giới tính</label>
                    <div class="readonly-value">@Model.GioiTinh</div>
                    <input type="hidden" asp-for="GioiTinh" />
                </div>
                <div class="form-group">
                    <label class="form-label">Ngày cấp CCCD</label>
                    <div class="readonly-value">@(Model.NgayCapCmnd?.ToString("dd/MM/yyyy") ?? "-")</div>
                    <input type="hidden" asp-for="NgayCapCmnd" />
                </div>
                <div class="form-group">
                    <label class="form-label">Nơi cấp CCCD</label>
                    <div class="readonly-value">@(Model.NoiCapCmnd ?? "-")</div>
                    <input type="hidden" asp-for="NoiCapCmnd" />
                </div>
            </div>
        </div>

        <!-- Thông tin liên hệ -->
        <div class="form-section">
            <h3 class="section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;margin-right:8px;">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
                Thông tin liên hệ
            </h3>
            <div class="form-grid">
                <div class="form-group">
                    <label asp-for="SoDienThoai" class="form-label">Số điện thoại <span class="required">*</span></label>
                    <input asp-for="SoDienThoai" class="form-control" maxlength="10" pattern="[0-9]{10}" placeholder="Nhập 10 chữ số" required />
                    <span asp-validation-for="SoDienThoai" class="text-danger validation-error"></span>
                    <span id="phoneExistsError" class="warning-label" style="display:none;"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Email" class="form-label">Email <span class="required">*</span></label>
                    <input asp-for="Email" type="email" class="form-control" required />
                    <span asp-validation-for="Email" class="text-danger validation-error"></span>
                    <span id="emailExistsError" class="warning-label" style="display:none;"></span>
                </div>
            </div>
        </div>

        <!-- Địa chỉ -->
        <div class="form-section">
            <h3 class="section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;margin-right:8px;">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
                Địa chỉ
            </h3>
            <div class="form-grid">
                <div class="form-group full-width">
                    <label asp-for="DiaChi" class="form-label">Địa chỉ thường trú <span class="required">*</span></label>
                    <input asp-for="DiaChi" class="form-control" required />
                    <span asp-validation-for="DiaChi" class="text-danger validation-error"></span>
                </div>

                <div class="form-group">
                    <label asp-for="ThanhPho" class="form-label">Thành phố/Tỉnh <span class="required">*</span></label>
                    <input asp-for="ThanhPho" class="form-control" required />
                    <span asp-validation-for="ThanhPho" class="text-danger validation-error"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Quan" class="form-label">Quận/Huyện <span class="required">*</span></label>
                    <input asp-for="Quan" class="form-control" required />
                    <span asp-validation-for="Quan" class="text-danger validation-error"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Phuong" class="form-label">Phường/Xã <span class="required">*</span></label>
                    <input asp-for="Phuong" class="form-control" required />
                    <span asp-validation-for="Phuong" class="text-danger validation-error"></span>
                </div>
            </div>
        </div>

        <!-- Thông tin nghề nghiệp -->
        <div class="form-section">
            <h3 class="section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;margin-right:8px;">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                    <path d="M16 7V5c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2v2"></path>
                </svg>
                Thông tin nghề nghiệp
            </h3>
            <div class="form-grid">
                <div class="form-group">
                    <label asp-for="TinhTrangHonNhan" class="form-label">Tình trạng hôn nhân <span class="required">*</span></label>
                    <select asp-for="TinhTrangHonNhan" class="form-control" required>
                        <option value="">-- Chọn --</option>
                        <option value="Độc thân">Độc thân</option>
                        <option value="Đã kết hôn">Đã kết hôn</option>
                        <option value="Ly hôn">Ly hôn</option>
                    </select>
                    <span asp-validation-for="TinhTrangHonNhan" class="text-danger validation-error"></span>
                </div>

                <div class="form-group">
                    <label asp-for="NgheNghiep" class="form-label">Nghề nghiệp <span class="required">*</span></label>
                    <input asp-for="NgheNghiep" class="form-control" required />
                    <span asp-validation-for="NgheNghiep" class="text-danger validation-error"></span>
                </div>

                <div class="form-group">
                    <label asp-for="ThuNhapHangThang" class="form-label">Thu nhập hàng tháng (VNĐ) <span class="required">*</span></label>
                    <input type="text" class="form-control" id="thuNhapInput" placeholder="Nhập số tiền" required 
                           value="@(Model.ThuNhapHangThang?.ToString("N0").Replace(",", "."))" />
                    <small class="form-text text-muted">Số tiền sẽ được hiển thị với định dạng: 3.000.000</small>
                    <input type="hidden" asp-for="ThuNhapHangThang" id="thuNhapHidden" />
                    <span asp-validation-for="ThuNhapHangThang" class="text-danger validation-error"></span>
                </div>

                <div class="form-group">
                    <label asp-for="TenCongTy" class="form-label">Tên công ty</label>
                    <input asp-for="TenCongTy" class="form-control" />
                    <span asp-validation-for="TenCongTy" class="text-danger validation-error"></span>
                </div>

                <div class="form-group">
                    <label asp-for="SoNamLamViec" class="form-label">Số năm làm việc <span class="required">*</span></label>
                    <input asp-for="SoNamLamViec" type="number" class="form-control" required />
                    <span asp-validation-for="SoNamLamViec" class="text-danger validation-error"></span>
                </div>
            </div>
        </div>

        <!-- Tài liệu và ảnh -->
        <div class="form-section">
            <h3 class="section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;margin-right:8px;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                Tài liệu và ảnh
            </h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Ảnh mặt trước CCCD/CMND</label>
                    <input type="file" name="cccdTruocFile" accept="image/*,.pdf" class="form-control" />
                    <small class="form-text text-muted">Chấp nhận: JPG, PNG, PDF (để trống nếu không thay đổi)</small>
                    @if (!string.IsNullOrEmpty(Model.CccdTruoc))
                    {
                        <div class="image-preview">
                            <img src="@Model.CccdTruoc" alt="CCCD mặt trước" />
                            <span class="preview-label">Ảnh hiện tại</span>
                        </div>
                    }
                    <input type="hidden" name="existingCccdTruoc" value="@Model.CccdTruoc" />
                </div>

                <div class="form-group">
                    <label class="form-label">Ảnh mặt sau CCCD/CMND</label>
                    <input type="file" name="cccdSauFile" accept="image/*,.pdf" class="form-control" />
                    <small class="form-text text-muted">Chấp nhận: JPG, PNG, PDF (để trống nếu không thay đổi)</small>
                    @if (!string.IsNullOrEmpty(Model.CccdSau))
                    {
                        <div class="image-preview">
                            <img src="@Model.CccdSau" alt="CCCD mặt sau" />
                            <span class="preview-label">Ảnh hiện tại</span>
                        </div>
                    }
                    <input type="hidden" name="existingCccdSau" value="@Model.CccdSau" />
                </div>

                <div class="form-group">
                    <label class="form-label">Ảnh đại diện</label>
                    <input type="file" name="anhDaiDienFile" accept="image/*" class="form-control" />
                    <small class="form-text text-muted">Chấp nhận: JPG, PNG (để trống nếu không thay đổi)</small>
                    @if (!string.IsNullOrEmpty(Model.AnhDaiDien))
                    {
                        <div class="image-preview avatar-preview">
                            <img src="@Model.AnhDaiDien" alt="Ảnh đại diện" />
                            <span class="preview-label">Ảnh hiện tại</span>
                        </div>
                    }
                    <input type="hidden" name="existingAnhDaiDien" value="@Model.AnhDaiDien" />
                </div>
            </div>
        </div>

        <div class="form-actions">
            <a href="@Url.Action("DetailsCaNhan", "Customer", new { id = Model.MaKhachHang })" class="btn btn-secondary">Hủy</a>
            <button type="submit" class="btn btn-primary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;margin-right:6px;">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Lưu thay đổi
            </button>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            var checkPhoneUrl = '@Url.Action("CheckPhoneExists", "Customer")';
            var checkEmailUrl = '@Url.Action("CheckEmailExists", "Customer")';
            var currentCustomerId = @Model.MaKhachHang;

            // Format số tiền với dấu chấm
            const thuNhapInput = document.getElementById('thuNhapInput');
            const thuNhapHidden = document.getElementById('thuNhapHidden');
            
            if (thuNhapInput && thuNhapHidden) {
                // Set giá trị ban đầu
                let initialValue = '@Model.ThuNhapHangThang';
                if (initialValue && initialValue !== '') {
                    thuNhapHidden.value = parseFloat(initialValue).toString();
                }

                thuNhapInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\./g, '');
                    if (value && !isNaN(value)) {
                        let formatted = parseInt(value).toLocaleString('vi-VN').replace(/,/g, '.');
                        e.target.value = formatted;
                        thuNhapHidden.value = value;
                    } else {
                        thuNhapHidden.value = '';
                    }
                });

                document.querySelector('form')?.addEventListener('submit', function() {
                    if (thuNhapInput.value) {
                        let value = thuNhapInput.value.replace(/\./g, '');
                        thuNhapHidden.value = value;
                    }
                });
            }

            // Kiểm tra SĐT trùng
            const phoneInput = document.querySelector('[name="SoDienThoai"]');
            const phoneError = document.getElementById('phoneExistsError');
            
            if (phoneInput && phoneError) {
                phoneInput.addEventListener('blur', async function() {
                    const phone = this.value.trim();
                    if (phone.length === 10) {
                        try {
                            const response = await fetch(`${checkPhoneUrl}?phone=${encodeURIComponent(phone)}&excludeId=${currentCustomerId}&customerType=canhan`);
                            const data = await response.json();
                            if (data.exists) {
                                phoneError.innerHTML = '⚠ Số điện thoại này đã tồn tại trong hệ thống!';
                                phoneError.style.display = 'block';
                                phoneInput.classList.add('input-warning');
                            } else {
                                phoneError.style.display = 'none';
                                phoneInput.classList.remove('input-warning');
                            }
                        } catch (error) {
                            console.error('Error checking phone:', error);
                        }
                    }
                });
            }

            // Kiểm tra Email trùng
            const emailInput = document.querySelector('[name="Email"]');
            const emailError = document.getElementById('emailExistsError');
            
            if (emailInput && emailError) {
                emailInput.addEventListener('blur', async function() {
                    const email = this.value.trim();
                    if (email) {
                        try {
                            const response = await fetch(`${checkEmailUrl}?email=${encodeURIComponent(email)}&excludeId=${currentCustomerId}&customerType=canhan`);
                            const data = await response.json();
                            if (data.exists) {
                                emailError.innerHTML = '⚠ Email này đã tồn tại trong hệ thống!';
                                emailError.style.display = 'block';
                                emailInput.classList.add('input-warning');
                            } else {
                                emailError.style.display = 'none';
                                emailInput.classList.remove('input-warning');
                            }
                        } catch (error) {
                            console.error('Error checking email:', error);
                        }
                    }
                });
            }

            // Validation SĐT - chỉ giữ số
            if (phoneInput) {
                phoneInput.addEventListener('input', function (e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 10) value = value.substring(0, 10);
                    e.target.value = value;
                });
            }
        });
    </script>
}

<style>
.form-container {
    padding: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.form-header {
    margin-bottom: 2rem;
}

.header-top {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.back-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border-radius: 8px;
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    transition: all 0.2s;
    flex-shrink: 0;
    text-decoration: none;
}

.back-button:hover {
    background: #e5e7eb;
    transform: translateX(-2px);
}

.back-button img {
    width: 32px;
    height: 32px;
    object-fit: contain;
}

.header-content {
    flex: 1;
}

.form-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 0.5rem;
}

.form-subtitle {
    color: #666;
    font-size: 0.95rem;
}

.customer-form {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.form-section {
    margin-bottom: 2.5rem;
}

.readonly-section {
    background: #f8fafc;
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid #e2e8f0;
}

.section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
}

.readonly-section .section-title {
    color: #64748b;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
}

.required {
    color: #ef4444;
}

.readonly-value {
    padding: 0.75rem 1rem;
    background: #e5e7eb;
    border-radius: 8px;
    font-size: 0.9375rem;
    color: #4b5563;
    font-weight: 500;
}

.form-control {
    padding: 0.75rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.9375rem;
    transition: all 0.2s ease;
}

.form-control:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.input-warning {
    border-color: #f59e0b !important;
    background-color: #fffbeb !important;
}

.warning-label {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    color: #92400e;
    padding: 8px 12px;
    border-radius: 6px;
    margin-top: 8px;
    font-size: 13px;
}

.form-text {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.text-danger {
    color: #ef4444;
    font-size: 0.8125rem;
    margin-top: 0.25rem;
}

.validation-error {
    display: block;
}

.image-preview {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    position: relative;
}

.image-preview img {
    max-width: 200px;
    max-height: 150px;
    object-fit: cover;
    border-radius: 6px;
}

.avatar-preview img {
    border-radius: 50%;
    width: 100px;
    height: 100px;
}

.preview-label {
    display: block;
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.5rem;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
    margin-top: 1rem;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
}

.btn-secondary {
    background: white;
    color: #6b7280;
    border: 2px solid #e5e7eb;
}

.btn-secondary:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
    color: #374151;
}

.btn-primary {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: white;
    border: none;
    box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
}

.success-notification, .error-notification {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.success-notification {
    background: #ecfdf5;
    border: 1px solid #10b981;
}

.error-notification {
    background: #fef2f2;
    border: 1px solid #ef4444;
}

.success-icon {
    width: 32px;
    height: 32px;
    background: #10b981;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.error-icon {
    width: 32px;
    height: 32px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

@@media (max-width: 992px) {
    .form-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@@media (max-width: 576px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .form-group.full-width {
        grid-column: 1;
    }
}
</style>
