@model List<QuanLyRuiRoTinDung.Models.Entities.KhoanVay>
@{
    ViewData["Title"] = "Danh s√°ch h·ªì s∆° vay";
    Layout = "_DashboardLayout";
    var customerId = ViewBag.CustomerId as int? ?? 0;
    var customerType = ViewBag.CustomerType as string ?? "";
    var tenKhachHang = ViewBag.TenKhachHang as string ?? "";
    
    var hoSoNhap = Model.Where(k => k.TrangThaiKhoanVay == "Nh√°p").ToList();
    var hoSoDaGui = Model.Where(k => k.TrangThaiKhoanVay == "Ch·ªù duy·ªát" || k.TrangThaiKhoanVay == "ƒêang x·ª≠ l√Ω").ToList();
}

@Html.AntiForgeryToken()

<div class="loan-list-container">
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">Danh s√°ch h·ªì s∆° vay</h1>
            <p class="page-subtitle">Kh√°ch h√†ng: <strong>@tenKhachHang</strong></p>
        </div>
        <a href="@Url.Action("SelectCustomer", "Loan")" class="btn-back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Quay l·∫°i
        </a>
    </div>

    <!-- H·ªì s∆° nh√°p -->
    <div class="loan-section">
        <h2 class="section-title">
            <span class="title-icon">üìù</span>
            H·ªì s∆° nh√°p c·∫ßn ch·ªânh s·ª≠a (@hoSoNhap.Count)
        </h2>
        @if (hoSoNhap.Any())
        {
            <div class="loan-grid">
                @foreach (var loan in hoSoNhap)
                {
                    <div class="loan-card">
                        <div class="loan-header">
                            <div class="loan-code">@loan.MaKhoanVayCode</div>
                            <span class="status-badge status-draft">Nh√°p</span>
                        </div>
                        <div class="loan-info">
                            <div class="info-row">
                                <span class="info-label">Lo·∫°i vay:</span>
                                <span class="info-value">@(loan.MaLoaiVayNavigation?.TenLoaiVay ?? "N/A")</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">S·ªë ti·ªÅn vay:</span>
                                <span class="info-value">@loan.SoTienVay.ToString("N0") VNƒê</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">L√£i su·∫•t:</span>
                                <span class="info-value">@loan.LaiSuat%</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">K·ª≥ h·∫°n:</span>
                                <span class="info-value">@loan.KyHanVay th√°ng</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ng√†y t·∫°o:</span>
                                <span class="info-value">@(loan.NgayTao?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</span>
                            </div>
                            @{
                                // L·ªçc b·ªè ph·∫ßn ghi ch√∫ chuy√™n vi√™n c≈© (n·∫øu c√≥) - ch·ªâ l·∫•y ph·∫ßn ghi ch√∫ h·ªì s∆°
                                var ghiChuHoSo = loan.GhiChu ?? "";
                                var separatorIndex = ghiChuHoSo.IndexOf("--- Ghi ch√∫ c·ªßa chuy√™n vi√™n ---");
                                if (separatorIndex >= 0)
                                {
                                    ghiChuHoSo = ghiChuHoSo.Substring(0, separatorIndex).Trim();
                                }
                            }
                            <div class="info-row">
                                <span class="info-label">Ghi ch√∫:</span>
                                <span class="info-value ghi-chu-value">@(!string.IsNullOrEmpty(ghiChuHoSo) ? ghiChuHoSo : "Kh√¥ng c√≥")</span>
                            </div>
                        </div>
                        <div class="loan-actions">
                            <a href="@Url.Action("Edit", "Loan", new { loanId = loan.MaKhoanVay })" class="btn-edit">
                                Ch·ªânh s·ª≠a
                            </a>
                            <button onclick="showDeleteConfirmationModal(@loan.MaKhoanVay)" class="btn-delete">
                                X√≥a
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <p>Ch∆∞a c√≥ h·ªì s∆° nh√°p n√†o.</p>
            </div>
        }
    </div>

    <!-- H·ªì s∆° ƒë√£ g·ª≠i -->
    <div class="loan-section">
        <h2 class="section-title">
            <span class="title-icon">üì§</span>
            H·ªì s∆° ƒë√£ g·ª≠i (@hoSoDaGui.Count)
        </h2>
        @if (hoSoDaGui.Any())
        {
            <div class="loan-grid">
                @foreach (var loan in hoSoDaGui)
                {
                    <div class="loan-card">
                        <div class="loan-header">
                            <div class="loan-code">@loan.MaKhoanVayCode</div>
                            <span class="status-badge status-submitted">@loan.TrangThaiKhoanVay</span>
                        </div>
                        <div class="loan-info">
                            <div class="info-row">
                                <span class="info-label">Lo·∫°i vay:</span>
                                <span class="info-value">@(loan.MaLoaiVayNavigation?.TenLoaiVay ?? "N/A")</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">S·ªë ti·ªÅn vay:</span>
                                <span class="info-value">@loan.SoTienVay.ToString("N0") VNƒê</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">L√£i su·∫•t:</span>
                                <span class="info-value">@loan.LaiSuat%</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">K·ª≥ h·∫°n:</span>
                                <span class="info-value">@loan.KyHanVay th√°ng</span>
                            </div>
                            @if (!string.IsNullOrEmpty(loan.MucDoRuiRo))
                            {
                                <div class="info-row">
                                    <span class="info-label">ƒê√°nh gi√°:</span>
                                    <span class="info-value">@loan.MucDoRuiRo</span>
                                </div>
                            }
                            <div class="info-row">
                                <span class="info-label">Ng√†y g·ª≠i:</span>
                                <span class="info-value">@(loan.NgayNopHoSo?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ghi ch√∫:</span>
                                <span class="info-value ghi-chu-value">@(!string.IsNullOrEmpty(loan.GhiChuNhanVien) ? loan.GhiChuNhanVien : "Kh√¥ng c√≥")</span>
                            </div>
                        </div>
                        <div class="loan-actions">
                            <button onclick="cancelSubmission(@loan.MaKhoanVay)" class="btn-cancel-submission">
                                H·ªßy g·ª≠i
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <p>Ch∆∞a c√≥ h·ªì s∆° n√†o ƒë√£ g·ª≠i.</p>
            </div>
        }
    </div>
</div>

<!-- Modal x√°c nh·∫≠n h·ªßy g·ª≠i -->
<div id="cancelSubmissionModal" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal">
        <div class="modal-icon warning">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        </div>
        <h3 class="modal-title">X√°c nh·∫≠n h·ªßy g·ª≠i</h3>
        <p class="modal-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy g·ª≠i h·ªì s∆° n√†y kh√¥ng?<br>H·ªì s∆° s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v·ªÅ danh s√°ch nh√°p.</p>
        <div class="modal-buttons">
            <button type="button" class="btn-modal-cancel" onclick="closeCancelModal()">Kh√¥ng</button>
            <button type="button" class="btn-confirm-cancel" onclick="confirmCancelSubmission()">X√°c nh·∫≠n h·ªßy</button>
        </div>
    </div>
</div>

<!-- Modal k·∫øt qu·∫£ -->
<div id="resultModal" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal">
        <div id="resultIcon" class="result-icon success">‚úì</div>
        <h3 id="resultTitle" class="modal-title">Th√†nh c√¥ng!</h3>
        <p id="resultMessage" class="modal-message">ƒê√£ h·ªßy g·ª≠i h·ªì s∆° th√†nh c√¥ng!</p>
        <div class="modal-buttons">
            <button type="button" class="btn-modal-ok" onclick="closeResultModal()">ƒê√≥ng</button>
        </div>
    </div>
</div>

<style>
/* Modal styles */
.custom-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.2s ease;
}

@@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.custom-modal {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    max-width: 420px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease;
}

@@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
}

.modal-icon.warning {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
    color: #856404;
}

.modal-icon.warning svg {
    width: 32px;
    height: 32px;
}

.result-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    font-size: 2rem;
    font-weight: bold;
}

.result-icon.success {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
}

.result-icon.error {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1a1a2e;
    margin-bottom: 0.75rem;
}

.modal-message {
    font-size: 0.95rem;
    color: #6c757d;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.modal-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.btn-modal-cancel {
    padding: 0.75rem 1.5rem;
    border: 2px solid #dee2e6;
    background: white;
    color: #6c757d;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-modal-cancel:hover {
    background: #f8f9fa;
    border-color: #adb5bd;
}

.btn-confirm-cancel {
    padding: 0.75rem 1.5rem;
    border: none;
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    color: white;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-confirm-cancel:hover {
    background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
    transform: translateY(-1px);
}

.btn-confirm-cancel:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

.btn-modal-ok {
    padding: 0.75rem 2rem;
    border: none;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-modal-ok:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 0.8s linear infinite;
}

@@keyframes spin {
    to { transform: rotate(360deg); }
}

.loan-list-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
}

.header-content {
    flex: 1;
}

.page-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 0.5rem;
}

.page-subtitle {
    color: #666;
    font-size: 0.95rem;
}

.btn-back {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: #f3f4f6;
    color: #374151;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-back:hover {
    background: #e5e7eb;
}

.btn-back svg {
    width: 20px;
    height: 20px;
}

.loan-section {
    margin-bottom: 3rem;
}

.section-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 1.5rem;
}

.title-icon {
    font-size: 1.5rem;
}

.loan-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}

.loan-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.2s;
}

.loan-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15);
}

.loan-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.loan-code {
    font-weight: 600;
    color: #1a1a1a;
    font-size: 1.1rem;
}

.status-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-draft {
    background: #fef3c7;
    color: #92400e;
}

.status-submitted {
    background: #dbeafe;
    color: #1e40af;
}

.loan-info {
    margin-bottom: 1rem;
}

.info-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f3f4f6;
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    color: #666;
    font-size: 0.9rem;
}

.info-value {
    color: #1a1a1a;
    font-weight: 500;
    font-size: 0.9rem;
}

.loan-actions {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
}

.btn-edit {
    display: inline-block;
    width: 100%;
    padding: 0.75rem;
    background: #3b82f6;
    color: white;
    border-radius: 8px;
    text-decoration: none;
    text-align: center;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-edit:hover {
    background: #2563eb;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #666;
    background: #f9fafb;
    border-radius: 12px;
    border: 1px dashed #d1d5db;
}

.ghi-chu-value {
    color: #dc2626;
    font-weight: 500;
    font-style: italic;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.btn-delete {
    display: inline-block;
    width: 100%;
    margin-top: 0.5rem;
    padding: 0.75rem;
    background: #dc2626;
    color: white;
    border: none;
    border-radius: 8px;
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-delete:hover {
    background: #b91c1c;
}

.btn-cancel-submission {
    display: inline-block;
    width: 100%;
    padding: 0.75rem;
    background: #f59e0b;
    color: white;
    border: none;
    border-radius: 8px;
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-cancel-submission:hover {
    background: #d97706;
}

@@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}
</style>

<script>
    // H√†m hi·ªÉn th·ªã modal x√°c nh·∫≠n x√≥a
    function showDeleteConfirmationModal(loanId) {
        // X√≥a modal c≈© n·∫øu c√≥
        const existingModal = document.getElementById('deleteConfirmModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // T·∫°o modal overlay
        const overlay = document.createElement('div');
        overlay.id = 'deleteConfirmModal';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        `;
        
        // T·∫°o modal content
        const modal = document.createElement('div');
        modal.style.cssText = `
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        `;
        
        // Icon
        const icon = document.createElement('div');
        icon.style.cssText = `
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #fee2e2;
            color: #ef4444;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
        `;
        icon.innerHTML = '‚ö†';
        
        // Message
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            text-align: center;
            font-size: 1.1rem;
            color: #1a1a1a;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        `;
        messageDiv.textContent = 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªì s∆° nh√°p n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.';
        
        // Buttons
        const buttonsDiv = document.createElement('div');
        buttonsDiv.style.cssText = `
            display: flex;
            gap: 1rem;
            justify-content: center;
        `;
        
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'H·ªßy';
        cancelBtn.style.cssText = `
            padding: 0.75rem 2rem;
            background: #f3f4f6;
            color: #374151;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        `;
        cancelBtn.onmouseover = function() { this.style.background = '#e5e7eb'; };
        cancelBtn.onmouseout = function() { this.style.background = '#f3f4f6'; };
        cancelBtn.onclick = function() {
            overlay.remove();
        };
        
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'X√≥a';
        confirmBtn.style.cssText = `
            padding: 0.75rem 2rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        `;
        confirmBtn.onmouseover = function() { this.style.background = '#b91c1c'; };
        confirmBtn.onmouseout = function() { this.style.background = '#dc2626'; };
        confirmBtn.onclick = function() {
            overlay.remove();
            deleteLoan(loanId);
        };
        
        buttonsDiv.appendChild(cancelBtn);
        buttonsDiv.appendChild(confirmBtn);
        
        // Assemble modal
        modal.appendChild(icon);
        modal.appendChild(messageDiv);
        modal.appendChild(buttonsDiv);
        overlay.appendChild(modal);
        
        // Close on overlay click
        overlay.onclick = function(e) {
            if (e.target === overlay) {
                overlay.remove();
            }
        };
        
        document.body.appendChild(overlay);
    }
    
    async function deleteLoan(loanId) {
        console.log('deleteLoan called with loanId:', loanId);
        
        try {
            // G·ª≠i request v·ªõi query string (ƒë∆°n gi·∫£n h∆°n)
            const url = '@Url.Action("DeleteLoan", "Loan")' + '?loanId=' + encodeURIComponent(loanId);
            
            console.log('Delete URL:', url);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            console.log('Delete response status:', response.status);
            console.log('Delete response ok:', response.ok);
            
            // Ki·ªÉm tra content type
            const contentType = response.headers.get('content-type');
            console.log('Delete response content-type:', contentType);

            if (!response.ok) {
                let errorText = '';
                try {
                    errorText = await response.text();
                    console.error('Delete response error text:', errorText);
                    
                    // Th·ª≠ parse JSON n·∫øu c√≥ th·ªÉ
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.message || `HTTP error! status: ${response.status}`);
                    } catch {
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }
                } catch (parseError) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            }

            // Parse response
            let result;
            try {
                const responseText = await response.text();
                console.log('Delete response text:', responseText);
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error('Error parsing JSON response:', parseError);
                throw new Error('Kh√¥ng th·ªÉ parse response t·ª´ server. Vui l√≤ng th·ª≠ l·∫°i.');
            }
            
            console.log('Delete result:', result);
            
            if (result && result.success) {
                showNotification('ƒê√£ x√≥a h·ªì s∆° nh√°p th√†nh c√¥ng!', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showNotification(result?.message || 'C√≥ l·ªói x·∫£y ra khi x√≥a h·ªì s∆°.', 'error');
            }
        } catch (error) {
            console.error('Error deleting loan:', error);
            console.error('Error stack:', error.stack);
            showNotification('C√≥ l·ªói x·∫£y ra khi x√≥a h·ªì s∆°: ' + (error.message || 'Vui l√≤ng th·ª≠ l·∫°i.'), 'error');
        }
    }
    
    // H√†m hi·ªÉn th·ªã th√¥ng b√°o custom (gi·ªëng Create.cshtml)
    function showNotification(message, type = 'info') {
        // X√≥a notification c≈© n·∫øu c√≥
        const existingNotification = document.getElementById('customNotification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // T·∫°o modal overlay
        const overlay = document.createElement('div');
        overlay.id = 'customNotification';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.2s ease;
        `;
        
        // T·∫°o modal content
        const modal = document.createElement('div');
        modal.style.cssText = `
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        `;
        
        // Icon
        const icon = document.createElement('div');
        icon.style.cssText = `
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: ${type === 'success' ? '#d1fae5' : type === 'error' ? '#fee2e2' : '#dbeafe'};
            color: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
        `;
        icon.innerHTML = type === 'success' ? '‚úì' : type === 'error' ? '‚ö†' : '‚Ñπ';
        
        // Message
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            text-align: center;
            font-size: 1.1rem;
            color: #1a1a1a;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        `;
        messageDiv.textContent = message;
        
        // Button
        const button = document.createElement('button');
        button.textContent = 'ƒê√≥ng';
        button.style.cssText = `
            width: 100%;
            padding: 0.75rem;
            background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        `;
        button.onclick = function() {
            overlay.remove();
        };
        
        // Assemble modal
        modal.appendChild(icon);
        modal.appendChild(messageDiv);
        modal.appendChild(button);
        overlay.appendChild(modal);
        
        document.body.appendChild(overlay);
    }

    // Bi·∫øn l∆∞u loanId ƒëang x·ª≠ l√Ω
    let pendingCancelLoanId = null;

    // Hi·ªÉn th·ªã modal x√°c nh·∫≠n h·ªßy g·ª≠i
    function cancelSubmission(loanId) {
        pendingCancelLoanId = loanId;
        const modal = document.getElementById('cancelSubmissionModal');
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    // ƒê√≥ng modal h·ªßy g·ª≠i
    function closeCancelModal() {
        const modal = document.getElementById('cancelSubmissionModal');
        if (modal) {
            modal.style.display = 'none';
        }
        pendingCancelLoanId = null;
    }

    // X√°c nh·∫≠n h·ªßy g·ª≠i
    async function confirmCancelSubmission() {
        if (!pendingCancelLoanId) return;

        const confirmBtn = document.querySelector('#cancelSubmissionModal .btn-confirm-cancel');
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="spinner"></span> ƒêang x·ª≠ l√Ω...';
        }

        try {
            const response = await fetch('@Url.Action("CancelSubmission", "Loan")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({ loanId: pendingCancelLoanId })
            });

            const result = await response.json();
            
            closeCancelModal();
            
            if (result.success) {
                showResultModal('success', 'Th√†nh c√¥ng!', 'ƒê√£ h·ªßy g·ª≠i h·ªì s∆° th√†nh c√¥ng! H·ªì s∆° ƒë√£ ƒë∆∞·ª£c chuy·ªÉn v·ªÅ danh s√°ch nh√°p.');
            } else {
                showResultModal('error', 'L·ªói!', result.message || 'C√≥ l·ªói x·∫£y ra khi h·ªßy g·ª≠i h·ªì s∆°.');
            }
        } catch (error) {
            console.error('Error canceling submission:', error);
            closeCancelModal();
            showResultModal('error', 'L·ªói!', 'C√≥ l·ªói x·∫£y ra khi h·ªßy g·ª≠i h·ªì s∆°. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }

    // Hi·ªÉn th·ªã modal k·∫øt qu·∫£
    function showResultModal(type, title, message) {
        const modal = document.getElementById('resultModal');
        const iconEl = document.getElementById('resultIcon');
        const titleEl = document.getElementById('resultTitle');
        const messageEl = document.getElementById('resultMessage');
        
        if (modal && iconEl && titleEl && messageEl) {
            iconEl.className = 'result-icon ' + type;
            iconEl.innerHTML = type === 'success' ? '‚úì' : '‚úï';
            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.style.display = 'flex';
        }
    }

    // ƒê√≥ng modal k·∫øt qu·∫£ v√† reload trang
    function closeResultModal() {
        const modal = document.getElementById('resultModal');
        if (modal) {
            modal.style.display = 'none';
        }
        location.reload();
    }
</script>
