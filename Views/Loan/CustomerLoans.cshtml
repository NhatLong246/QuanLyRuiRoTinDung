@{
    ViewData["Title"] = "Danh s√°ch kho·∫£n vay";
    Layout = "_DashboardLayout";
    var loans = ViewBag.Loans as List<QuanLyRuiRoTinDung.Models.Entities.KhoanVay> ?? new List<QuanLyRuiRoTinDung.Models.Entities.KhoanVay>();
    var customerId = ViewBag.CustomerId as int? ?? 0;
    var customerType = ViewBag.CustomerType as string ?? "CaNhan";
    var tenKhachHang = ViewBag.TenKhachHang as string ?? "";
    var maKhachHangCode = ViewBag.MaKhachHangCode as string ?? "";
    var anhDaiDien = ViewBag.AnhDaiDien as string;
    var soDienThoai = ViewBag.SoDienThoai as string;
    var email = ViewBag.Email as string;
    var currentTrangThai = ViewBag.CurrentTrangThai as string ?? "all";
    var totalLoans = ViewBag.TotalLoans as int? ?? 0;
    var choGiaiNgan = ViewBag.ChoGiaiNgan as int? ?? 0;
    var dangVay = ViewBag.DangVay as int? ?? 0;
    var quaHan = ViewBag.QuaHan as int? ?? 0;
    var daThanhToan = ViewBag.DaThanhToan as int? ?? 0;
}

@Html.AntiForgeryToken()

<div class="customer-loans-container">
    <!-- Breadcrumb & Back -->
    <div class="breadcrumb-section">
        <a href="@Url.Action("Manage", "Loan")" class="back-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5"/>
                <polyline points="12 19 5 12 12 5"/>
            </svg>
            Quay l·∫°i danh s√°ch kh√°ch h√†ng
        </a>
    </div>

    <!-- Customer Info Header -->
    <div class="customer-header">
        <div class="customer-profile">
            <div class="customer-avatar @(customerType == "CaNhan" ? "avatar-personal" : "avatar-business")">
                @if (!string.IsNullOrEmpty(anhDaiDien))
                {
                    <img src="@anhDaiDien" alt="Avatar" />
                }
                else
                {
                    @(customerType == "CaNhan" ? "üë§" : "üè¢")
                }
            </div>
            <div class="customer-details">
                <h1 class="customer-name">@tenKhachHang</h1>
                <div class="customer-meta">
                    <span class="customer-code">@maKhachHangCode</span>
                    <span class="customer-type-badge @(customerType == "CaNhan" ? "type-personal" : "type-business")">
                        @(customerType == "CaNhan" ? "C√° nh√¢n" : "Doanh nghi·ªáp")
                    </span>
                </div>
                <div class="customer-contact-info">
                    @if (!string.IsNullOrEmpty(soDienThoai))
                    {
                        <span class="contact-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                            @soDienThoai
                        </span>
                    }
                    @if (!string.IsNullOrEmpty(email))
                    {
                        <span class="contact-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            @email
                        </span>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card stat-total">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z"/>
                    <path d="M14 2V8H20"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-number">@totalLoans</span>
                <span class="stat-label">T·ªïng kho·∫£n vay</span>
            </div>
        </div>

        <div class="stat-card stat-pending">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9 12l2 2 4-4"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-number">@choGiaiNgan</span>
                <span class="stat-label">Ch·ªù gi·∫£i ng√¢n</span>
            </div>
        </div>

        <div class="stat-card stat-active">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-number">@dangVay</span>
                <span class="stat-label">ƒêang vay</span>
            </div>
        </div>

        <div class="stat-card stat-overdue">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18C1.64 18.3 1.55 18.64 1.55 19C1.55 19.36 1.64 19.7 1.82 20C2 20.3 2.25 20.55 2.55 20.73C2.85 20.91 3.19 21 3.55 21H20.47C20.83 21 21.17 20.91 21.47 20.73C21.77 20.55 22.02 20.3 22.2 20C22.38 19.7 22.47 19.36 22.47 19C22.47 18.64 22.38 18.3 22.2 18L13.73 3.86C13.55 3.56 13.3 3.32 13 3.15C12.7 2.98 12.36 2.89 12.01 2.89C11.66 2.89 11.32 2.98 11.02 3.15C10.72 3.32 10.47 3.56 10.29 3.86Z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-number">@quaHan</span>
                <span class="stat-label">Qu√° h·∫°n</span>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-section">
        <div class="filter-tabs">
            <a href="?customerId=@customerId&customerType=@customerType&trangThai=all" class="filter-tab @(currentTrangThai == "all" ? "active" : "")">
                <span class="tab-icon">üìã</span>
                T·∫•t c·∫£
                <span class="tab-count">@totalLoans</span>
            </a>
            <a href="?customerId=@customerId&customerType=@customerType&trangThai=ChoGiaiNgan" class="filter-tab @(currentTrangThai == "ChoGiaiNgan" ? "active" : "")">
                <span class="tab-icon">‚úì</span>
                Ch·ªù gi·∫£i ng√¢n
                <span class="tab-count">@choGiaiNgan</span>
            </a>
            <a href="?customerId=@customerId&customerType=@customerType&trangThai=ƒêang vay" class="filter-tab @(currentTrangThai == "ƒêang vay" ? "active" : "")">
                <span class="tab-icon">‚è≥</span>
                ƒêang vay
                <span class="tab-count">@dangVay</span>
            </a>
            <a href="?customerId=@customerId&customerType=@customerType&trangThai=Qu√° h·∫°n" class="filter-tab tab-danger @(currentTrangThai == "Qu√° h·∫°n" ? "active" : "")">
                <span class="tab-icon">‚ö†Ô∏è</span>
                Qu√° h·∫°n
                <span class="tab-count">@quaHan</span>
            </a>
            <a href="?customerId=@customerId&customerType=@customerType&trangThai=ƒê√£ thanh to√°n" class="filter-tab @(currentTrangThai == "ƒê√£ thanh to√°n" ? "active" : "")">
                <span class="tab-icon">‚úÖ</span>
                ƒê√£ thanh to√°n
                <span class="tab-count">@daThanhToan</span>
            </a>
        </div>
    </div>

    <!-- Loans Table -->
    <div class="table-wrapper">
        <table class="loans-table">
            <thead>
                <tr>
                    <th class="col-code">M√£ kho·∫£n vay</th>
                    <th class="col-type">Lo·∫°i vay</th>
                    <th class="col-amount">S·ªë ti·ªÅn vay</th>
                    <th class="col-rate">L√£i su·∫•t</th>
                    <th class="col-term">K·ª≥ h·∫°n</th>
                    <th class="col-date">Ng√†y gi·∫£i ng√¢n</th>
                    <th class="col-date">Ng√†y ƒë√°o h·∫°n</th>
                    <th class="col-debt">D∆∞ n·ª£ c√≤n l·∫°i</th>
                    <th class="col-status">Tr·∫°ng th√°i</th>
                    <th class="col-action">Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                @if (loans.Any())
                {
                    foreach (var loan in loans)
                    {
                        var statusClass = loan.TrangThaiKhoanVay switch
                        {
                            "ƒê√£ duy·ªát" or "ƒê√£ ph√™ duy·ªát" => "badge-approved",
                            "ƒêang vay" => "badge-active",
                            "Qu√° h·∫°n" => "badge-overdue",
                            "ƒê√£ thanh to√°n" => "badge-completed",
                            _ => "badge-default"
                        };
                        var statusIcon = loan.TrangThaiKhoanVay switch
                        {
                            "ƒê√£ duy·ªát" or "ƒê√£ ph√™ duy·ªát" => "‚úì",
                            "ƒêang vay" => "‚óâ",
                            "Qu√° h·∫°n" => "‚ö†",
                            "ƒê√£ thanh to√°n" => "‚úî",
                            _ => "‚Ä¢"
                        };
                        var displayStatus = (loan.TrangThaiKhoanVay == "ƒê√£ ph√™ duy·ªát" || loan.TrangThaiKhoanVay == "ƒê√£ duy·ªát") ? "Ch·ªù gi·∫£i ng√¢n" : loan.TrangThaiKhoanVay;
                        
                        <tr class="loan-row">
                            <td>
                                <a href="@Url.Action("Details", "Loan", new { id = loan.MaKhoanVay })" class="loan-code-link">
                                    <span class="code-hash">#</span>@loan.MaKhoanVayCode
                                </a>
                            </td>
                            <td>
                                <span class="loan-type">@(loan.MaLoaiVayNavigation?.TenLoaiVay ?? "N/A")</span>
                            </td>
                            <td>
                                <div class="amount-cell">
                                    <span class="amount-value">@loan.SoTienVay.ToString("N0")</span>
                                    <span class="amount-currency">VNƒê</span>
                                </div>
                            </td>
                            <td>
                                <span class="rate-badge">@($"{loan.LaiSuat:N1}%")/nƒÉm</span>
                            </td>
                            <td>
                                <span class="term-value">@loan.KyHanVay <small>th√°ng</small></span>
                            </td>
                            <td>
                                <div class="date-cell">
                                    @if (loan.NgayGiaiNgan.HasValue)
                                    {
                                        <span class="date-value">@loan.NgayGiaiNgan.Value.ToString("dd/MM/yyyy")</span>
                                    }
                                    else
                                    {
                                        <span class="date-pending">Ch·ªù gi·∫£i ng√¢n</span>
                                    }
                                </div>
                            </td>
                            <td>
                                <div class="date-cell">
                                    @if (loan.NgayDaoHan.HasValue)
                                    {
                                        var daysLeft = (loan.NgayDaoHan.Value.ToDateTime(TimeOnly.MinValue) - DateTime.Now).Days;
                                        <span class="date-value">@loan.NgayDaoHan.Value.ToString("dd/MM/yyyy")</span>
                                        @if (daysLeft > 0 && daysLeft <= 30 && loan.TrangThaiKhoanVay == "ƒêang vay")
                                        {
                                            <span class="days-left warning">C√≤n @daysLeft ng√†y</span>
                                        }
                                        else if (daysLeft < 0 && loan.TrangThaiKhoanVay != "ƒê√£ thanh to√°n")
                                        {
                                            <span class="days-left danger">Qu√° @(-daysLeft) ng√†y</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="date-pending">--</span>
                                    }
                                </div>
                            </td>
                            <td>
                                <div class="debt-cell">
                                    <span class="debt-value @(loan.SoDuGocConLai > 0 ? "has-debt" : "")">
                                        @((loan.SoDuGocConLai ?? 0).ToString("N0"))
                                    </span>
                                    <span class="debt-currency">VNƒê</span>
                                </div>
                            </td>
                            <td>
                                <span class="status-badge @statusClass">
                                    <span class="status-icon">@statusIcon</span>
                                    @displayStatus
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="@Url.Action("Details", "Loan", new { id = loan.MaKhoanVay })" class="action-btn view-btn" title="Xem chi ti·∫øt">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                    </a>
                                    @if (loan.TrangThaiKhoanVay == "ƒê√£ duy·ªát" || loan.TrangThaiKhoanVay == "ƒê√£ ph√™ duy·ªát")
                                    {
                                        <button class="action-btn disburse-btn" title="Gi·∫£i ng√¢n kho·∫£n vay" onclick="showDisbursementModal(@loan.MaKhoanVay, '@loan.MaKhoanVayCode', @loan.SoTienVay, '@tenKhachHang')">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                                                <polyline points="17 6 23 6 23 12"/>
                                            </svg>
                                        </button>
                                    }
                                    @if (loan.TrangThaiKhoanVay == "ƒêang vay")
                                    {
                                        <a href="@Url.Action("LichSuTraNo", "Loan", new { id = loan.MaKhoanVay })" class="action-btn history-btn" title="Xem l·ªãch s·ª≠ tr·∫£ n·ª£">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <polyline points="12 6 12 12 16 14"/>
                                            </svg>
                                        </a>
                                        <button class="action-btn payment-btn" title="Ghi nh·∫≠n thanh to√°n" onclick="recordPayment(@loan.MaKhoanVay)">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                                <line x1="1" y1="10" x2="23" y2="10"/>
                                            </svg>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="10">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z"/>
                                        <path d="M14 2V8H20"/>
                                    </svg>
                                </div>
                                <h3>Kh√¥ng c√≥ kho·∫£n vay n√†o</h3>
                                <p>Kh√°ch h√†ng n√†y ch∆∞a c√≥ kho·∫£n vay n√†o trong danh m·ª•c n√†y</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    .customer-loans-container {
        padding: 0;
        min-height: 100vh;
    }

    /* Breadcrumb */
    .breadcrumb-section {
        margin-bottom: 24px;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #64748b;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .back-link:hover {
        background: #f1f5f9;
        color: #3b82f6;
    }

    .back-link svg {
        width: 18px;
        height: 18px;
    }

    /* Customer Header */
    .customer-header {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        border: 1px solid #f1f5f9;
    }

    .customer-profile {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .customer-avatar {
        width: 80px;
        height: 80px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        overflow: hidden;
    }

    .customer-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .customer-avatar.avatar-personal {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
    }

    .customer-avatar.avatar-business {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }

    .customer-details {
        flex: 1;
    }

    .customer-name {
        font-size: 24px;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 8px 0;
    }

    .customer-meta {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .customer-code {
        font-size: 14px;
        color: #64748b;
    }

    .customer-type-badge {
        font-size: 12px;
        padding: 4px 12px;
        border-radius: 8px;
        font-weight: 500;
    }

    .customer-type-badge.type-personal {
        background: #ede9fe;
        color: #7c3aed;
    }

    .customer-type-badge.type-business {
        background: #fef3c7;
        color: #d97706;
    }

    .customer-contact-info {
        display: flex;
        gap: 20px;
    }

    .contact-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #64748b;
    }

    .contact-item svg {
        width: 14px;
        height: 14px;
    }

    /* Statistics Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 20px 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        border: 1px solid #f1f5f9;
    }

    .stat-icon {
        width: 52px;
        height: 52px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .stat-icon svg {
        width: 26px;
        height: 26px;
    }

    .stat-total .stat-icon {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        color: #4f46e5;
    }

    .stat-pending .stat-icon {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #059669;
    }

    .stat-active .stat-icon {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #2563eb;
    }

    .stat-overdue .stat-icon {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #dc2626;
    }

    .stat-content {
        display: flex;
        flex-direction: column;
    }

    .stat-number {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        line-height: 1;
    }

    .stat-label {
        font-size: 13px;
        color: #64748b;
        margin-top: 4px;
    }

    /* Filter Section */
    .filter-section {
        margin-bottom: 20px;
    }

    .filter-tabs {
        display: flex;
        gap: 8px;
        background: white;
        padding: 8px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        overflow-x: auto;
    }

    .filter-tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        background: #f8fafc;
        border-radius: 8px;
        color: #64748b;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.2s;
    }

    .filter-tab:hover {
        background: #f1f5f9;
        color: #334155;
    }

    .filter-tab.active {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .filter-tab.tab-danger.active {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .tab-icon {
        font-size: 14px;
    }

    .tab-count {
        background: rgba(255,255,255,0.2);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 600;
    }

    .filter-tab:not(.active) .tab-count {
        background: #e2e8f0;
        color: #64748b;
    }

    /* Table Styles */
    .table-wrapper {
        background: white;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .loans-table {
        width: 100%;
        border-collapse: collapse;
    }

    .loans-table thead {
        background: #f8fafc;
    }

    .loans-table th {
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        color: #475569;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid #e2e8f0;
    }

    .loans-table td {
        padding: 16px 20px;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
    }

    .loan-row:hover {
        background: #f8fafc;
    }

    .loan-code-link {
        color: #3b82f6;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
    }

    .loan-code-link:hover {
        text-decoration: underline;
    }

    .code-hash {
        color: #94a3b8;
    }

    .loan-type {
        font-size: 13px;
        color: #475569;
    }

    .amount-cell, .debt-cell {
        display: flex;
        flex-direction: column;
    }

    .amount-value, .debt-value {
        font-weight: 600;
        color: #1e293b;
        font-size: 14px;
    }

    .debt-value.has-debt {
        color: #ef4444;
    }

    .amount-currency, .debt-currency {
        font-size: 11px;
        color: #94a3b8;
    }

    .rate-badge {
        background: #dbeafe;
        color: #1d4ed8;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
    }

    .term-value {
        font-weight: 500;
        color: #475569;
    }

    .term-value small {
        color: #94a3b8;
        font-weight: 400;
    }

    .date-cell {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .date-value {
        font-size: 14px;
        color: #1e293b;
    }

    .date-pending {
        font-size: 13px;
        color: #94a3b8;
        font-style: italic;
    }

    .days-left {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 4px;
    }

    .days-left.warning {
        background: #fef3c7;
        color: #d97706;
    }

    .days-left.danger {
        background: #fee2e2;
        color: #dc2626;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
    }

    .badge-approved {
        background: #d1fae5;
        color: #059669;
    }

    .badge-active {
        background: #dbeafe;
        color: #2563eb;
    }

    .badge-overdue {
        background: #fee2e2;
        color: #dc2626;
    }

    .badge-completed {
        background: #e0e7ff;
        color: #4f46e5;
    }

    .badge-default {
        background: #f1f5f9;
        color: #64748b;
    }

    .status-icon {
        font-size: 10px;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .action-btn svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        flex-shrink: 0;
    }

    .view-btn {
        background: #f1f5f9;
        color: #64748b;
        text-decoration: none;
    }

    .view-btn:hover {
        background: #e2e8f0;
        color: #334155;
    }

    .view-btn svg {
        stroke: #64748b;
    }

    .view-btn:hover svg {
        stroke: #334155;
    }

    .disburse-btn {
        background: #d1fae5;
        color: #059669;
    }

    .disburse-btn:hover {
        background: #a7f3d0;
        color: #047857;
    }

    .disburse-btn svg {
        stroke: #059669;
    }

    .disburse-btn:hover svg {
        stroke: #047857;
    }

    .history-btn {
        background: #dbeafe;
        color: #2563eb;
        text-decoration: none;
    }

    .history-btn:hover {
        background: #bfdbfe;
        color: #1d4ed8;
    }

    .history-btn svg {
        stroke: #2563eb;
    }

    .history-btn:hover svg {
        stroke: #1d4ed8;
    }

    .payment-btn {
        background: #fef3c7;
        color: #d97706;
    }

    .payment-btn:hover {
        background: #fde68a;
        color: #b45309;
    }

    .payment-btn svg {
        stroke: #d97706;
    }

    .payment-btn:hover svg {
        stroke: #b45309;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        background: #f1f5f9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .empty-icon svg {
        width: 40px;
        height: 40px;
        color: #94a3b8;
    }

    .empty-state h3 {
        font-size: 18px;
        color: #475569;
        margin: 0 0 8px 0;
    }

    .empty-state p {
        font-size: 14px;
        color: #94a3b8;
        margin: 0;
    }

    @@media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .filter-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        .customer-profile {
            flex-direction: column;
            text-align: center;
        }

        .customer-contact-info {
            justify-content: center;
            flex-wrap: wrap;
        }
    }
</style>

<script>
    function recordPayment(loanId) {
        // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang l·ªãch s·ª≠ tr·∫£ n·ª£ ƒë·ªÉ ghi nh·∫≠n thanh to√°n
        window.location.href = '@Url.Action("LichSuTraNo", "Loan")/' + loanId;
    }

    let currentDisbursementLoanId = null;

    function showDisbursementModal(loanId, loanCode, amount, customerName) {
        currentDisbursementLoanId = loanId;
        document.getElementById('disburseLoanCode').textContent = '#' + loanCode;
        document.getElementById('disburseCustomerName').textContent = customerName;
        document.getElementById('disburseAmount').textContent = formatCurrency(amount) + ' VNƒê';
        document.getElementById('disburseDate').textContent = new Date().toLocaleDateString('vi-VN');
        document.getElementById('disbursementModal').classList.add('active');
    }

    function closeDisbursementModal() {
        document.getElementById('disbursementModal').classList.remove('active');
        currentDisbursementLoanId = null;
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount);
    }

    async function confirmDisbursement() {
        if (!currentDisbursementLoanId) return;
        
        const confirmBtn = document.getElementById('confirmDisbursementBtn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'ƒêang x·ª≠ l√Ω...';

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            const response = await fetch('@Url.Action("GiaiNgan", "Loan")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({
                    LoanId: currentDisbursementLoanId
                })
            });

            const result = await response.json();
            
            if (result.success) {
                closeDisbursementModal();
                showSuccessToast('Gi·∫£i ng√¢n th√†nh c√¥ng! Kho·∫£n vay ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t.');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showErrorToast(result.message || 'C√≥ l·ªói x·∫£y ra khi gi·∫£i ng√¢n');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'X√°c nh·∫≠n gi·∫£i ng√¢n';
            }
        } catch (error) {
            console.error('Error:', error);
            showErrorToast('C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi v·ªõi m√°y ch·ªß');
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'X√°c nh·∫≠n gi·∫£i ng√¢n';
        }
    }

    function showSuccessToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast toast-success';
        toast.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9 12l2 2 4-4"/>
            </svg>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function showErrorToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast toast-error';
        toast.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    document.getElementById('disbursementModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeDisbursementModal();
        }
    });
</script>

<!-- Disbursement Modal -->
<div id="disbursementModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üí∞ X√°c nh·∫≠n gi·∫£i ng√¢n</h3>
            <p>Vui l√≤ng ki·ªÉm tra th√¥ng tin tr∆∞·ªõc khi gi·∫£i ng√¢n</p>
        </div>
        <div class="modal-body">
            <div class="disbursement-info">
                <div class="disbursement-info-row">
                    <span class="disbursement-info-label">M√£ kho·∫£n vay</span>
                    <span class="disbursement-info-value" id="disburseLoanCode">--</span>
                </div>
                <div class="disbursement-info-row">
                    <span class="disbursement-info-label">Kh√°ch h√†ng</span>
                    <span class="disbursement-info-value" id="disburseCustomerName">--</span>
                </div>
                <div class="disbursement-info-row">
                    <span class="disbursement-info-label">S·ªë ti·ªÅn gi·∫£i ng√¢n</span>
                    <span class="disbursement-info-value" id="disburseAmount">--</span>
                </div>
                <div class="disbursement-info-row">
                    <span class="disbursement-info-label">Ng√†y gi·∫£i ng√¢n</span>
                    <span class="disbursement-info-value" id="disburseDate">--</span>
                </div>
            </div>
            <div class="disbursement-warning">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18C1.64 18.3 1.55 18.64 1.55 19C1.55 19.36 1.64 19.7 1.82 20C2 20.3 2.25 20.55 2.55 20.73C2.85 20.91 3.19 21 3.55 21H20.47C20.83 21 21.17 20.91 21.47 20.73C21.77 20.55 22.02 20.3 22.2 20C22.38 19.7 22.47 19.36 22.47 19C22.47 18.64 22.38 18.3 22.2 18L13.73 3.86C13.55 3.56 13.3 3.32 13 3.15C12.7 2.98 12.36 2.89 12.01 2.89C11.66 2.89 11.32 2.98 11.02 3.15C10.72 3.32 10.47 3.56 10.29 3.86Z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <div>
                    <strong>L∆∞u √Ω quan tr·ªçng:</strong><br/>
                    - Sau khi gi·∫£i ng√¢n, kho·∫£n vay s·∫Ω chuy·ªÉn sang tr·∫°ng th√°i "ƒêang vay"<br/>
                    - L·ªãch tr·∫£ n·ª£ s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông (tr·∫£ v√†o ng√†y 5 h√†ng th√°ng)<br/>
                    - H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-cancel" onclick="closeDisbursementModal()">H·ªßy b·ªè</button>
            <button class="modal-btn modal-btn-confirm" id="confirmDisbursementBtn" onclick="confirmDisbursement()">X√°c nh·∫≠n gi·∫£i ng√¢n</button>
        </div>
    </div>
</div>

<style>
    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background: white;
        border-radius: 20px;
        width: 100%;
        max-width: 480px;
        transform: translateY(-20px);
        transition: all 0.3s;
        box-shadow: 0 25px 50px rgba(0,0,0,0.25);
    }

    .modal-overlay.active .modal-content {
        transform: translateY(0);
    }

    .modal-header {
        padding: 24px 24px 16px;
        text-align: center;
    }

    .modal-header h3 {
        font-size: 20px;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 8px 0;
    }

    .modal-header p {
        font-size: 14px;
        color: #64748b;
        margin: 0;
    }

    .modal-body {
        padding: 0 24px 24px;
    }

    .disbursement-info {
        background: #f8fafc;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
    }

    .disbursement-info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .disbursement-info-row:last-child {
        border-bottom: none;
    }

    .disbursement-info-label {
        font-size: 14px;
        color: #64748b;
    }

    .disbursement-info-value {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
    }

    .disbursement-warning {
        display: flex;
        gap: 12px;
        padding: 16px;
        background: #fef3c7;
        border-radius: 12px;
        color: #92400e;
        font-size: 13px;
        line-height: 1.5;
    }

    .disbursement-warning svg {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
        color: #d97706;
    }

    .modal-footer {
        padding: 16px 24px 24px;
        display: flex;
        gap: 12px;
    }

    .modal-btn {
        flex: 1;
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .modal-btn-cancel {
        background: #f1f5f9;
        color: #475569;
    }

    .modal-btn-cancel:hover {
        background: #e2e8f0;
    }

    .modal-btn-confirm {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .modal-btn-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .modal-btn-confirm:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Toast */
    .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        z-index: 2000;
        transform: translateX(120%);
        transition: transform 0.3s ease;
    }

    .toast.show {
        transform: translateX(0);
    }

    .toast svg {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
    }

    .toast-success {
        background: #10b981;
        color: white;
    }

    .toast-error {
        background: #ef4444;
        color: white;
    }
</style>
