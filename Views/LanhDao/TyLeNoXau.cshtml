@model dynamic

@{
    ViewData["Title"] = "Tỷ lệ Nợ xấu - Quản lý Lãnh đạo";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2">
                <i class="fas fa-chart-line me-2"></i>
                Theo dõi Tỷ lệ Nợ xấu
            </h1>
            <p class="text-muted">Phân tích chi tiết tỷ lệ nợ xấu và xu hướng</p>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-left-danger">
                <div class="card-body">
                    <div class="text-danger font-weight-bold text-uppercase mb-1">Tỷ Lệ Nợ Xấu</div>
                    <div class="h3 mb-0">@Model.BadDebtRatio%</div>
                    <small class="text-muted">@Model.BadDebtLoans/@Model.TotalLoans khoản</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-left-danger">
                <div class="card-body">
                    <div class="text-danger font-weight-bold text-uppercase mb-1">Tỷ Lệ Vốn Nợ Xấu</div>
                    <div class="h3 mb-0">@Model.BadDebtAmountRatio%</div>
                    <small class="text-muted">@Model.BadDebtAmount.ToString("N0")/@Model.TotalLoanAmount.ToString("N0") VND</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-left-warning">
                <div class="card-body">
                    <div class="text-warning font-weight-bold text-uppercase mb-1">Tổng Danh Mục</div>
                    <div class="h5 mb-0">@Model.TotalLoans khoản</div>
                    <small class="text-muted">@Model.TotalLoanAmount.ToString("N0") VND</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">Phân bố nợ xấu theo loại</h6>
                </div>
                <div class="card-body">
                    <canvas id="badDebtTypeChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">Tỷ lệ nợ xấu so với tổng danh mục</h6>
                </div>
                <div class="card-body">
                    <canvas id="ratioChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Trend Chart -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h6 class="card-title mb-0">Xu hướng nợ xấu (12 tháng gần đây)</h6>
        </div>
        <div class="card-body">
            <canvas id="trendChart" height="300"></canvas>
        </div>
    </div>

    <!-- Classification Table -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h6 class="card-title mb-0">Phân loại nợ xấu</h6>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Phân loại</th>
                        <th>Số lượng</th>
                        <th>Tỷ lệ</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.BadDebtByType != null && Model.BadDebtByType.Any())
                    {
                        @foreach (var type in Model.BadDebtByType)
                        {
                            var percentage = Model.BadDebtLoans > 0 
                                ? (type.Count * 100 / Model.BadDebtLoans) 
                                : 0;

                            <tr>
                                <td><strong>@type.Type</strong></td>
                                <td class="text-center">@type.Count</td>
                                <td>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-danger" role="progressbar" 
                                             style="width: @percentage%">
                                            @percentage%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @{
                                        var statusBadge = type.Type switch
                                        {
                                            "Nhóm 5" => "bg-danger",
                                            "Nhóm 4" => "bg-danger",
                                            "Nhóm 3" => "bg-warning",
                                            _ => "bg-secondary"
                                        };
                                    }
                                    <span class="badge @statusBadge">Rủi ro cao</span>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4" class="text-center text-muted py-3">Không có dữ liệu</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Bad Debts -->
    <div class="card">
        <div class="card-header bg-light">
            <h6 class="card-title mb-0">Nợ xấu gần đây</h6>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Mã khoản vay</th>
                        <th>Khách hàng</th>
                        <th>Số tiền nợ</th>
                        <th>Phân loại</th>
                        <th>Ngày phân loại</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.RecentBadDebts != null && Model.RecentBadDebts.Any())
                    {
                        @foreach (var badDebt in Model.RecentBadDebts.Take(10))
                        {
                            <tr>
                                <td>
                                    <span class="badge bg-danger">@badDebt.MaKhoanVayNavigation?.MaKhoanVayCode</span>
                                </td>
                                <td>@badDebt.MaKhoanVayNavigation?.MaKhachHang</td>
                                <td class="text-end">
                                    <strong>@((badDebt.SoDuNo ?? 0).ToString("N0")) VND</strong>
                                </td>
                                <td>
                                    <small>@badDebt.MaPhanLoaiNavigation?.TenPhanLoai</small>
                                </td>
                                <td>@badDebt.NgayPhanLoai.ToString(@"dd/MM/yyyy")</td>
                                <td>
                                    <a href="@Url.Action("TheoDoiNoXau")" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted py-3">Không có nợ xấu gần đây</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Analysis Section -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">Phân tích rủi ro</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Nhận xét</h6>
                        <p>
                            Tỷ lệ nợ xấu hiện tại ở mức <strong>@Model.BadDebtRatio%</strong>, 
                            nằm trong mức kiểm soát. Tuy nhiên cần theo dõi kỹ các khoản vay 
                            quá hạn trên 90 ngày.
                        </p>
                    </div>
                    <hr>
                    <div>
                        <h6>Khuyến nghị</h6>
                        <ul class="mb-0">
                            <li>Tăng cường theo dõi các khoản vay có dấu hiệu rủi ro</li>
                            <li>Đẩy nhanh quá trình xử lý nợ xấu</li>
                            <li>Tăng cường đánh giá rủi ro trước khi giải ngân</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">Benchmark</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td>Tỷ lệ nợ xấu mục tiêu</td>
                                    <td><strong>2-3%</strong></td>
                                </tr>
                                <tr>
                                    <td>Tỷ lệ hiện tại</td>
                                    <td><strong class="text-danger">@Model.BadDebtRatio%</strong></td>
                                </tr>
                                <tr class="@(Model.BadDebtRatio > 3 ? "table-danger" : "table-success")">
                                    <td>Trạng thái</td>
                                    <td>
                                        @if (Model.BadDebtRatio > 3)
                                        {
                                            <strong><i class="fas fa-exclamation-triangle me-2"></i>Cảnh báo</strong>
                                        }
                                        else
                                        {
                                            <strong><i class="fas fa-check-circle me-2"></i>Bình thường</strong>
                                        }
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Bad Debt Type Chart
            const badDebtTypes = @Html.Raw(Json.Serialize(Model.BadDebtByType ?? new List<dynamic>()));
            const ctx1 = document.getElementById('badDebtTypeChart').getContext('2d');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: badDebtTypes.map(x => x.type),
                    datasets: [{
                        label: 'Số lượng',
                        data: badDebtTypes.map(x => x.count),
                        backgroundColor: '#dc3545'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Ratio Chart
            const ratioData = [
                @Model.TotalLoans - @Model.BadDebtLoans,
                @Model.BadDebtLoans
            ];
            const ctx2 = document.getElementById('ratioChart').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Bình thường', 'Nợ xấu'],
                    datasets: [{
                        data: ratioData,
                        backgroundColor: ['#198754', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Trend Chart
            fetch('@Url.Action("GetChartData", new { type = "badDebtTrend" })')
                .then(response => response.json())
                .then(data => {
                    const ctx3 = document.getElementById('trendChart').getContext('2d');
                    new Chart(ctx3, {
                        type: 'line',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: 'Nợ xấu phát sinh',
                                data: data.data,
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 4,
                                pointBackgroundColor: '#dc3545'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                });
        });
    </script>
}

<style>
    /* Enhanced bad debt ratio view styles */
    .card-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .h2 {
        color: #1e293b;
        font-weight: 700;
    }

    .h3 {
        font-weight: 800;
        color: #1e293b;
    }

    .h5 {
        font-weight: 700;
        color: #1e293b;
    }

    canvas {
        border-radius: 8px;
    }

    .table th {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .progress {
        border-radius: 12px;
    }

    .table-danger {
        background-color: rgba(239, 68, 68, 0.1) !important;
    }

    .table-success {
        background-color: rgba(16, 185, 129, 0.1) !important;
    }
</style>
