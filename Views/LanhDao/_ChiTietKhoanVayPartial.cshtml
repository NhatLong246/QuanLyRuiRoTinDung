@using QuanLyRuiRoTinDung.Models.Entities
@using System.Linq
@using System.IO
@model KhoanVay

<div class="row">
    <!-- Loan Information -->
    <div class="col-lg-8">
        <!-- Customer Information -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">Thông tin khách hàng</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2"><strong class="text-muted">Mã khoản vay:</strong> <span>@Model.MaKhoanVayCode</span></p>
                        <p class="mb-2"><strong class="text-muted">Tên khách hàng:</strong> <span>@(ViewBag.TenKhachHang as string ?? $"KH-{Model.MaKhachHang}")</span></p>
                        <p class="mb-2"><strong class="text-muted">Loại khách hàng:</strong> <span>@Model.LoaiKhachHang</span></p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong class="text-muted">Mục đích vay:</strong> <span>@Model.MucDichVay</span></p>
                        <p class="mb-2"><strong class="text-muted">Ngày nộp hồ sơ:</strong> <span>@Model.NgayNopHoSo?.ToString("dd/MM/yyyy")</span></p>
                        <p class="mb-2"><strong class="text-muted">Trạng thái:</strong> <span class="badge bg-info">@Model.TrangThaiKhoanVay</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Details -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">Chi tiết khoản vay</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2"><strong class="text-muted">Số tiền vay:</strong> <span class="text-success fw-bold">@Model.SoTienVay.ToString("N0") VND</span></p>
                        <p class="mb-2"><strong class="text-muted">Lãi suất hàng năm:</strong> <span>@Model.LaiSuat%</span></p>
                        <p class="mb-2"><strong class="text-muted">Kỳ hạn vay:</strong> <span>@Model.KyHanVay tháng</span></p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong class="text-muted">Hình thức trả nợ:</strong> <span>@Model.HinhThucTraNo</span></p>
                        <p class="mb-2"><strong class="text-muted">Nhân viên tín dụng:</strong> <span>@Model.MaNhanVienTinDungNavigation?.HoTen</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Assessment Information -->
        @{
            var danhGiaRuiRosList = Model.DanhGiaRuiRos?.OrderByDescending(d => d.NgayDanhGia ?? DateTime.MinValue).ToList() ?? new List<DanhGiaRuiRo>();
            var hasDanhGia = danhGiaRuiRosList.Count > 0;
        }
        <div class="card mb-3">
            <div class="card-header bg-gradient-primary text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Thông tin đánh giá mức độ rủi ro
                </h6>
            </div>
            <div class="card-body">
                @if (hasDanhGia)
                {
                    @foreach (var danhGia in danhGiaRuiRosList)
                    {
                        <div class="card border mb-3 @(danhGia != danhGiaRuiRosList.First() ? "border-secondary" : "")">
                            <div class="card-body">
                                @if (danhGia == danhGiaRuiRosList.First())
                                {
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="badge bg-success">
                                            <i class="fas fa-star me-1"></i>Đánh giá mới nhất
                                        </span>
                                        @if (danhGia.NgayDanhGia.HasValue)
                                        {
                                            <small class="text-muted">
                                                <i class="fas fa-calendar me-1"></i>
                                                Ngày đánh giá: @danhGia.NgayDanhGia.Value.ToString("dd/MM/yyyy HH:mm")
                                            </small>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="d-flex justify-content-end mb-3">
                                        @if (danhGia.NgayDanhGia.HasValue)
                                        {
                                            <small class="text-muted">
                                                <i class="fas fa-calendar me-1"></i>
                                                Ngày đánh giá: @danhGia.NgayDanhGia.Value.ToString("dd/MM/yyyy HH:mm")
                                            </small>
                                        }
                                    </div>
                                }
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong class="text-muted"><i class="fas fa-user me-1"></i>Người đánh giá:</strong> <span>@(danhGia.NguoiDanhGiaNavigation?.HoTen ?? $"ID: {danhGia.NguoiDanhGia}")</span></p>
                                        <p class="mb-2">
                                            <strong class="text-muted"><i class="fas fa-calculator me-1"></i>Tổng điểm:</strong> 
                                            <span class="@(danhGia.TongDiem.HasValue && danhGia.TongDiem.Value >= 70 ? "text-success" : danhGia.TongDiem.HasValue && danhGia.TongDiem.Value >= 50 ? "text-warning" : "text-danger") fw-bold">
                                                @(danhGia.TongDiem?.ToString("N2") ?? "N/A")
                                            </span>
                                        </p>
                                        <p class="mb-2">
                                            <strong class="text-muted"><i class="fas fa-exclamation-triangle me-1"></i>Mức độ rủi ro:</strong> 
                                            @{
                                                var riskBadgeClass = "bg-secondary";
                                                if (!string.IsNullOrEmpty(danhGia.MucDoRuiRo))
                                                {
                                                    riskBadgeClass = danhGia.MucDoRuiRo switch
                                                    {
                                                        "Thấp" => "bg-success",
                                                        "Trung bình" => "bg-warning",
                                                        "Cao" => "bg-danger",
                                                        "Rất cao" => "bg-danger",
                                                        _ => "bg-secondary"
                                                    };
                                                }
                                            }
                                            <span class="badge @riskBadgeClass">@(danhGia.MucDoRuiRo ?? "Chưa xác định")</span>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong class="text-muted"><i class="fas fa-trophy me-1"></i>Xếp hạng rủi ro:</strong> <span>@(danhGia.XepHangRuiRo ?? "N/A")</span></p>
                                        <p class="mb-2"><strong class="text-muted"><i class="fas fa-lightbulb me-1"></i>Kiến nghị:</strong> <span>@(danhGia.KienNghi ?? "N/A")</span></p>
                                        @if (!string.IsNullOrEmpty(danhGia.TrangThai))
                                        {
                                            <p class="mb-2"><strong class="text-muted"><i class="fas fa-info-circle me-1"></i>Trạng thái:</strong> <span class="badge bg-info">@danhGia.TrangThai</span></p>
                                        }
                                    </div>
                                </div>
                                
                                @if (!string.IsNullOrEmpty(danhGia.NhanXet))
                                {
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <p class="mb-2"><strong class="text-muted"><i class="fas fa-comment-alt me-1"></i>Nhận xét:</strong></p>
                                            <div class="alert alert-light py-2 mb-0">
                                                <p class="mb-0">@danhGia.NhanXet</p>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Chưa có đánh giá rủi ro</strong>
                        <p class="mb-0 small mt-2">Khoản vay này chưa được đánh giá mức độ rủi ro.</p>
                    </div>
                }
            </div>
        </div>

        <!-- Collateral Information -->
        @{
            var taiSanList = Model.KhoanVayTaiSans?.ToList() ?? new List<KhoanVayTaiSan>();
            var hasTaiSan = taiSanList.Count > 0;
        }
        @if (hasTaiSan)
        {
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-home me-2"></i>Tài sản thế chấp
                    </h6>
                </div>
                <div class="card-body">
                    @foreach (var asset in taiSanList)
                    {
                        var taiSan = asset.MaTaiSanNavigation;
                        var loaiTaiSan = taiSan?.MaLoaiTaiSanNavigation;
                        var giaTriHienThi = asset.GiaTriDinhGiaTaiThoiDiemVay ?? taiSan?.GiaTriDinhGia ?? 0;
                        
                        <div class="card border mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-3">
                                            <i class="fas fa-tag me-2"></i>@taiSan?.TenGoi
                                        </h6>
                                        <p class="mb-2"><strong class="text-muted">Mã tài sản:</strong> <span>@taiSan?.MaTaiSanCode</span></p>
                                        <p class="mb-2"><strong class="text-muted">Loại tài sản:</strong> <span class="badge bg-info">@loaiTaiSan?.TenLoaiTaiSan</span></p>
                                        @if (!string.IsNullOrEmpty(taiSan?.MoTaChiTiet))
                                        {
                                            <p class="mb-2"><strong class="text-muted">Mô tả:</strong> <span>@taiSan.MoTaChiTiet</span></p>
                                        }
                                        @if (!string.IsNullOrEmpty(taiSan?.DiaChi))
                                        {
                                            <p class="mb-2">
                                                <strong class="text-muted">Địa chỉ:</strong> 
                                                <span>@taiSan.DiaChi@(string.IsNullOrEmpty(taiSan.Quan) && string.IsNullOrEmpty(taiSan.ThanhPho) ? "" : $", {taiSan.Quan}, {taiSan.ThanhPho}")</span>
                                            </p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2">
                                            <strong class="text-muted">Giá trị định giá:</strong> 
                                            <span class="text-success fw-bold">@giaTriHienThi.ToString("N0") VNĐ</span>
                                            @if (asset.GiaTriDinhGiaTaiThoiDiemVay.HasValue && taiSan?.GiaTriDinhGia.HasValue == true)
                                            {
                                                <small class="text-muted">(Giá trị tại thời điểm vay)</small>
                                            }
                                        </p>
                                        @if (asset.TyLeTheChap.HasValue)
                                        {
                                            <p class="mb-2"><strong class="text-muted">Tỷ lệ thế chấp:</strong> <span>@asset.TyLeTheChap%</span></p>
                                        }
                                        @if (asset.NgayTheChap.HasValue)
                                        {
                                            <p class="mb-2"><strong class="text-muted">Ngày thế chấp:</strong> <span>@asset.NgayTheChap.Value.ToString("dd/MM/yyyy")</span></p>
                                        }
                                        @if (!string.IsNullOrEmpty(taiSan?.SoGiayTo))
                                        {
                                            <p class="mb-2"><strong class="text-muted">Số giấy tờ:</strong> <span>@taiSan.SoGiayTo</span></p>
                                        }
                                        @if (taiSan?.NgayCap.HasValue == true)
                                        {
                                            <p class="mb-2"><strong class="text-muted">Ngày cấp:</strong> <span>@taiSan.NgayCap.Value.ToString("dd/MM/yyyy")</span></p>
                                        }
                                        @if (!string.IsNullOrEmpty(taiSan?.ChuSoHuu))
                                        {
                                            <p class="mb-2"><strong class="text-muted">Chủ sở hữu:</strong> <span>@taiSan.ChuSoHuu</span></p>
                                        }
                                        @if (taiSan?.DienTich.HasValue == true)
                                        {
                                            <p class="mb-2"><strong class="text-muted">Diện tích:</strong> <span>@taiSan.DienTich.Value.ToString("N2") m²</span></p>
                                        }
                                        @if (taiSan?.NamSanXuat.HasValue == true)
                                        {
                                            <p class="mb-2"><strong class="text-muted">Năm sản xuất:</strong> <span>@taiSan.NamSanXuat</span></p>
                                        }
                                        @if (!string.IsNullOrEmpty(taiSan?.TinhTrang))
                                        {
                                            <p class="mb-2"><strong class="text-muted">Tình trạng:</strong> <span>@taiSan.TinhTrang</span></p>
                                        }
                                        <p class="mb-2"><strong class="text-muted">Trạng thái:</strong> <span class="badge bg-success">@asset.TrangThai</span></p>
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(asset.GhiChu))
                                {
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <p class="mb-2"><strong class="text-muted">Ghi chú:</strong></p>
                                            <div class="alert alert-light py-2 mb-0">
                                                <p class="mb-0">@asset.GhiChu</p>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-home me-2"></i>Tài sản thế chấp
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Khoản vay này chưa có tài sản thế chấp.
                    </div>
                </div>
            </div>
        }

        <!-- File đính kèm -->
        @{
            var files = ViewBag.Files as List<HoSoVayFileDinhKem> ?? new List<HoSoVayFileDinhKem>();
            var hasFiles = files.Any();
        }
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">
                    <i class="fas fa-paperclip me-2"></i>Hồ sơ File đính kèm
                </h6>
            </div>
            <div class="card-body">
                @if (hasFiles)
                {
                    <div class="row g-3">
                        @foreach (var file in files)
                        {
                            var fileUrl = file.DuongDan;
                            if (!string.IsNullOrEmpty(fileUrl) && !fileUrl.StartsWith("/") && !fileUrl.StartsWith("http"))
                            {
                                fileUrl = "/" + fileUrl.TrimStart('/');
                            }
                            
                            var fileExtension = file.DinhDang?.ToLower() ?? "";
                            if (string.IsNullOrEmpty(fileExtension) && !string.IsNullOrEmpty(file.TenFile))
                            {
                                var lastDotIndex = file.TenFile.LastIndexOf('.');
                                if (lastDotIndex >= 0 && lastDotIndex < file.TenFile.Length - 1)
                                {
                                    fileExtension = file.TenFile.Substring(lastDotIndex + 1).ToLower();
                                }
                            }
                            var isImage = fileExtension == "jpg" || fileExtension == "jpeg" || fileExtension == "png" || fileExtension == "gif";
                            var isPdf = fileExtension == "pdf";
                            var canPreview = isImage || isPdf;
                            
                            var fileSize = file.KichThuoc.HasValue 
                                ? (file.KichThuoc.Value < 1024 
                                    ? $"{file.KichThuoc.Value} B"
                                    : file.KichThuoc.Value < 1024 * 1024
                                        ? $"{file.KichThuoc.Value / 1024.0:F1} KB"
                                        : $"{file.KichThuoc.Value / (1024.0 * 1024.0):F1} MB")
                                : "N/A";
                            
                            var displayFileName = file.TenFile.Length > 30 ? file.TenFile.Substring(0, 30) + "..." : file.TenFile;
                            
                            <div class="col-md-6 col-lg-4 col-xl-3">
                                <div class="file-card h-100" data-file-url="@fileUrl" data-file-name="@file.TenFile" data-file-type="@fileExtension" data-can-preview="@canPreview.ToString().ToLower()">
                                    <div class="file-preview-container">
                                        @if (isImage)
                                        {
                                            <div class="file-preview-image" style="background-image: url('@fileUrl'); background-size: cover; background-position: center; cursor: pointer;" onclick="openFilePreview('@fileUrl', '@file.TenFile', 'image')">
                                                <div class="file-preview-overlay">
                                                    <i class="fas fa-eye fa-2x text-white"></i>
                                                </div>
                                            </div>
                                        }
                                        else if (isPdf)
                                        {
                                            <div class="file-preview-pdf" onclick="openFilePreview('@fileUrl', '@file.TenFile', 'pdf')" style="cursor: pointer;">
                                                <i class="fas fa-file-pdf fa-4x text-danger"></i>
                                                <div class="file-preview-overlay">
                                                    <i class="fas fa-eye fa-2x text-white"></i>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="file-preview-other" onclick="openFilePreview('@fileUrl', '@file.TenFile', '@fileExtension')" style="cursor: pointer;">
                                                @{
                                                    var fileIcon = fileExtension switch
                                                    {
                                                        "doc" or "docx" => "fa-file-word text-primary",
                                                        "xls" or "xlsx" => "fa-file-excel text-success",
                                                        "txt" => "fa-file-alt text-secondary",
                                                        _ => "fa-file text-secondary"
                                                    };
                                                }
                                                <i class="fas @fileIcon fa-4x"></i>
                                                <div class="file-preview-overlay">
                                                    <i class="fas fa-external-link-alt fa-2x text-white"></i>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    <div class="file-info p-2">
                                        <h6 class="file-name mb-1" title="@file.TenFile" style="font-size: 0.9rem; font-weight: 500;">
                                            @displayFileName
                                        </h6>
                                        <small class="text-muted d-block mb-2">
                                            @fileSize
                                            @if (file.NgayTao.HasValue)
                                            {
                                                <span> • @file.NgayTao.Value.ToString("d/M/yyyy")</span>
                                            }
                                        </small>
                                        <a href="@fileUrl" 
                                           target="_blank" 
                                           class="btn btn-sm btn-primary w-100"
                                           download="@file.TenFile"
                                           onclick="event.stopPropagation();">
                                            <i class="fas fa-download me-1"></i>Tải xuống
                                        </a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Khoản vay này chưa có file đính kèm.
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Decision Panel -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-gavel me-2"></i>Quyết định
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Thông tin:</strong><br>
                    <small>Vui lòng xem xét kỹ thông tin khoản vay trước khi đưa ra quyết định</small>
                </div>

                @if (Model.TrangThaiKhoanVay != "Đã phê duyệt" && Model.TrangThaiKhoanVay != "Từ chối" && Model.TrangThaiKhoanVay != "Đã giải ngân" && Model.TrangThaiKhoanVay != "Đã thanh toán")
                {
                    <form method="post" action="@Url.Action("PheDuyetKhoanVay")" id="decisionForm_@Model.MaKhoanVay" data-loan-code="@Model.MaKhoanVayCode">
                        <input type="hidden" name="id" value="@Model.MaKhoanVay">
                        
                        <div class="d-grid gap-2">
                            <button type="button" name="decision" value="approve" class="btn btn-success btn-lg decision-btn btn-approve">
                                <i class="fas fa-check-circle me-2"></i>Chấp nhận
                            </button>
                            <button type="button" name="decision" value="reject" class="btn btn-danger btn-lg decision-btn btn-reject">
                                <i class="fas fa-times-circle me-2"></i>Từ chối
                            </button>
                        </div>
                    </form>
                }
                else
                {
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Khoản vay này đã được xử lý:</strong><br>
                        Trạng thái: <strong>@Model.TrangThaiKhoanVay</strong>
                        @if (Model.NgayPheDuyet.HasValue)
                        {
                            <text>
                                <br>Ngày quyết định: <strong>@Model.NgayPheDuyet.Value.ToString("dd/MM/yyyy HH:mm")</strong>
                            </text>
                        }
                        @if (!string.IsNullOrEmpty(Model.LyDoTuChoi))
                        {
                            <text>
                                <br><br><strong>Ghi chú:</strong><br>
                                <small>@Model.LyDoTuChoi</small>
                            </text>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .decision-btn {
        transition: all 0.3s ease;
        font-weight: 600;
        border-radius: 8px;
        padding: 12px;
        font-size: 1.1rem;
    }

    .decision-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .btn-success.decision-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
    }

    .btn-danger.decision-btn {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border: none;
    }
</style>

<!-- Modal Xác nhận Quyết định -->
<div class="modal fade" id="confirmDecisionModal_@Model.MaKhoanVay" tabindex="-1" aria-labelledby="confirmDecisionModalLabel_@Model.MaKhoanVay" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" id="confirmModalHeader_@Model.MaKhoanVay">
                <h5 class="modal-title" id="confirmDecisionModalLabel_@Model.MaKhoanVay">
                    <i class="fas fa-question-circle me-2"></i>Xác nhận Quyết định
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert mb-3" id="confirmAlert_@Model.MaKhoanVay">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="confirmMessage_@Model.MaKhoanVay"></span>
                </div>
                
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="fas fa-file-invoice-dollar me-2"></i>Thông tin Khoản vay
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <small class="text-muted">Mã khoản vay:</small>
                                <p class="mb-0"><strong id="confirmLoanCode_@Model.MaKhoanVay">-</strong></p>
                            </div>
                            <div class="col-md-6 mb-2">
                                <small class="text-muted">Mã khách hàng:</small>
                                <p class="mb-0"><strong id="confirmCustomerId_@Model.MaKhoanVay">-</strong></p>
                            </div>
                            <div class="col-md-6 mb-2">
                                <small class="text-muted">Loại khách hàng:</small>
                                <p class="mb-0"><strong id="confirmCustomerType_@Model.MaKhoanVay">-</strong></p>
                            </div>
                            <div class="col-md-6 mb-2">
                                <small class="text-muted">Số tiền vay:</small>
                                <p class="mb-0"><strong class="text-success" id="confirmLoanAmount_@Model.MaKhoanVay">-</strong></p>
                            </div>
                            <div class="col-md-6 mb-2">
                                <small class="text-muted">Mục đích vay:</small>
                                <p class="mb-0"><strong id="confirmLoanPurpose_@Model.MaKhoanVay">-</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="rejectReasonSection_@Model.MaKhoanVay" class="mt-3" style="display: none;">
                    <label for="rejectReasonTextarea_@Model.MaKhoanVay" class="form-label">
                        <strong>Lý do từ chối <span class="text-danger">*</span>:</strong>
                    </label>
                    <textarea class="form-control" 
                              id="rejectReasonTextarea_@Model.MaKhoanVay" 
                              rows="4" 
                              placeholder="Nhập lý do từ chối (bắt buộc)..."></textarea>
                    <div class="invalid-feedback d-none" id="rejectReasonError_@Model.MaKhoanVay">
                        <i class="fas fa-exclamation-circle me-1"></i>Vui lòng nhập lý do từ chối!
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Hủy
                </button>
                <button type="button" class="btn" id="confirmSubmitBtn_@Model.MaKhoanVay">
                    <i class="fas fa-check me-2"></i>Xác nhận
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        const formId = 'decisionForm_@Model.MaKhoanVay';
        const loanCode = '@Model.MaKhoanVayCode';
        // Sử dụng modal chung từ file chính
        const modalId = 'confirmDecisionModal';
        
        // Đảm bảo object global tồn tại
        if (!window.loanDecisionData) {
            window.loanDecisionData = {
                pendingForm: null,
                pendingDecision: null
            };
        }
        
        // Hàm lấy thông tin khoản vay
        function getLoanInfo() {
            @{
                var latestDanhGia = Model.DanhGiaRuiRos?.OrderByDescending(d => d.NgayDanhGia ?? DateTime.MinValue).FirstOrDefault();
                var riskLevel = latestDanhGia?.MucDoRuiRo ?? Model.MucDoRuiRo ?? "Chưa xác định";
            }
            return {
                loanCode: '@Model.MaKhoanVayCode',
                customerId: '@Model.MaKhachHang',
                customerType: '@Model.LoaiKhachHang',
                loanAmount: '@Model.SoTienVay.ToString("N0") VND',
                loanPurpose: '@Model.MucDichVay',
                riskLevel: '@riskLevel'
            };
        }
        
        // Hàm hiển thị modal xác nhận - sử dụng modal chung từ file chính
        function showConfirmModal(decision, loanInfo) {
            const confirmModalEl = document.getElementById(modalId);
            if (!confirmModalEl) {
                console.error('Modal xác nhận không tồn tại!', modalId);
                return;
            }
            
            const confirmModal = bootstrap.Modal.getOrCreateInstance(confirmModalEl);
            const confirmHeader = document.getElementById('confirmModalHeader');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmSubmitBtn = document.getElementById('confirmSubmitBtn');
            const rejectReasonSection = document.getElementById('rejectReasonSection');
            const confirmAlert = document.getElementById('confirmAlert');
            
            if (!confirmHeader || !confirmMessage || !confirmSubmitBtn || !confirmAlert) {
                console.error('Không tìm thấy các phần tử trong modal xác nhận!');
                return;
            }
            
            // Điền thông tin khoản vay
            document.getElementById('confirmLoanCode').textContent = loanInfo.loanCode || '-';
            document.getElementById('confirmCustomerId').textContent = loanInfo.customerId || '-';
            document.getElementById('confirmCustomerType').textContent = loanInfo.customerType || '-';
            document.getElementById('confirmLoanAmount').textContent = loanInfo.loanAmount || '-';
            document.getElementById('confirmLoanPurpose').textContent = loanInfo.loanPurpose || '-';
            
            if (decision === 'approve') {
                // Chấp nhận
                confirmHeader.className = 'modal-header bg-success text-white';
                confirmMessage.textContent = 'Bạn có chắc chắn muốn CHẤP NHẬN khoản vay này không?';
                confirmAlert.className = 'alert alert-info mb-3';
                confirmSubmitBtn.className = 'btn btn-success';
                confirmSubmitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Xác nhận Chấp nhận';
                if (rejectReasonSection) {
                    rejectReasonSection.style.display = 'none';
                }
            } else {
                // Từ chối
                const form = document.getElementById(formId);
                const notesId = 'notes_' + formId.replace('decisionForm_', '');
                const notes = document.getElementById(notesId);
                const rejectReason = notes ? notes.value.trim() : '';
                
                confirmHeader.className = 'modal-header bg-danger text-white';
                confirmMessage.textContent = 'Bạn có chắc chắn muốn TỪ CHỐI khoản vay này không?';
                confirmAlert.className = 'alert alert-danger mb-3';
                confirmSubmitBtn.className = 'btn btn-danger';
                confirmSubmitBtn.innerHTML = '<i class="fas fa-times me-2"></i>Xác nhận Từ chối';
                if (rejectReasonSection) {
                    const confirmRejectReason = document.getElementById('confirmRejectReason');
                    if (confirmRejectReason) {
                        confirmRejectReason.textContent = rejectReason || 'Không có lý do';
                    }
                    rejectReasonSection.style.display = 'block';
                }
            }
            
            // Lưu form và decision vào object global
            const form = document.getElementById(formId);
            if (form) {
                window.loanDecisionData.pendingForm = form;
                window.loanDecisionData.pendingDecision = decision;
            }
            
            // Hiển thị modal
            confirmModal.show();
        }
        
        function initDecisionButtons() {
            const form = document.getElementById(formId);
            
            if (!form) {
                setTimeout(initDecisionButtons, 100);
                return;
            }
            
            const approveBtn = form.querySelector('.btn-approve');
            const rejectBtn = form.querySelector('.btn-reject');
            
            // Xử lý nút Chấp nhận
            if (approveBtn) {
                const newApproveBtn = approveBtn.cloneNode(true);
                approveBtn.parentNode.replaceChild(newApproveBtn, approveBtn);
                
                newApproveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const loanInfo = getLoanInfo();
                    showConfirmModal('approve', loanInfo);
                });
            }
            
            // Xử lý nút Từ chối
            if (rejectBtn) {
                const newRejectBtn = rejectBtn.cloneNode(true);
                rejectBtn.parentNode.replaceChild(newRejectBtn, rejectBtn);
                
                newRejectBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const loanInfo = getLoanInfo();
                    showConfirmModal('reject', loanInfo);
                });
            }
            
            // Không cần xử lý nút xác nhận ở đây nữa vì đã được xử lý trong file chính
            // Event listener trong file chính sẽ tự động xử lý khi nút được click
        }
        
        // Chạy ngay lập tức
        initDecisionButtons();
    })();
</script>

<!-- Modal Preview File -->
<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="filePreviewModalLabel">
                    <i class="fas fa-file me-2"></i><span id="filePreviewTitle">Xem file</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" style="min-height: 500px;">
                <div id="filePreviewContent" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="filePreviewDownload" href="#" class="btn btn-primary" download>
                    <i class="fas fa-download me-2"></i>Tải xuống
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<style>
    .file-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        background: white;
    }

    .file-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .file-preview-container {
        position: relative;
        width: 100%;
        height: 200px;
        background: #f8f9fa;
        overflow: hidden;
    }

    .file-preview-image {
        width: 100%;
        height: 100%;
        position: relative;
    }

    .file-preview-pdf,
    .file-preview-other {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    .file-preview-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .file-card:hover .file-preview-overlay {
        opacity: 1;
    }

    .file-info {
        background: white;
    }

    .file-name {
        word-break: break-word;
        line-height: 1.4;
    }

    #filePreviewContent {
        min-height: 500px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #filePreviewContent img {
        max-width: 100%;
        max-height: 70vh;
        object-fit: contain;
    }

    #filePreviewContent iframe {
        width: 100%;
        height: 70vh;
        border: none;
    }
</style>

<script>
    function openFilePreview(fileUrl, fileName, fileType) {
        const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
        const modalTitle = document.getElementById('filePreviewTitle');
        const modalContent = document.getElementById('filePreviewContent');
        const downloadLink = document.getElementById('filePreviewDownload');
        
        modalTitle.textContent = fileName;
        downloadLink.href = fileUrl;
        downloadLink.download = fileName;
        
        // Hiển thị loading
        modalContent.innerHTML = `
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Đang tải...</span>
            </div>
            <p class="mt-3 text-muted">Đang tải file...</p>
        `;
        
        modal.show();
        
        // Load nội dung file
        if (fileType === 'image' || fileType === 'jpg' || fileType === 'jpeg' || fileType === 'png' || fileType === 'gif') {
            // Hiển thị hình ảnh
            const img = document.createElement('img');
            img.src = fileUrl;
            img.onload = function() {
                modalContent.innerHTML = '';
                modalContent.appendChild(img);
            };
            img.onerror = function() {
                modalContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Không thể tải hình ảnh. Vui lòng thử tải xuống.
                    </div>
                `;
            };
        } else if (fileType === 'pdf') {
            // Hiển thị PDF
            const iframe = document.createElement('iframe');
            iframe.src = fileUrl + '#toolbar=1';
            iframe.onload = function() {
                modalContent.innerHTML = '';
                modalContent.appendChild(iframe);
            };
            iframe.onerror = function() {
                modalContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Không thể tải PDF. Vui lòng thử tải xuống.
                    </div>
                `;
            };
        } else {
            // Mở trong tab mới cho các file khác
            window.open(fileUrl, '_blank');
            modal.hide();
        }
    }
</script>

