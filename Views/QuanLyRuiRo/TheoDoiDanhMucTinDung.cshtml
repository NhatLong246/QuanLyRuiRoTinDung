@{
    Layout = "_QuanLyRuiRoLayout";
    ViewData["Title"] = "Theo dõi Danh mục Tín dụng";
}

<div class="page-header">
    <div class="header-content">
        <div>
            <h1 class="page-title">Theo dõi Danh mục Tín dụng</h1>
            <p class="page-subtitle">Giám sát tổng thể danh mục tín dụng, tỷ lệ nợ xấu và xu hướng rủi ro</p>
        </div>
        <a href="@Url.Action("Index", "QuanLyRuiRo")" class="btn-back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19L5 12L12 5"/>
            </svg>
            Quay lại
        </a>
    </div>
</div>

<!-- Summary Cards -->
<div class="summary-grid">
    <div class="summary-card">
        <div class="summary-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                <path d="M2 17L12 22L22 17"/>
                <path d="M2 12L12 17L22 12"/>
            </svg>
        </div>
        <div class="summary-content">
            <div class="summary-label">Tổng số khoản vay</div>
            <div class="summary-value" id="tongSoKhoanVay">--</div>
            <div class="summary-change positive" id="soKhoanVayMoiThang">+0 tháng này</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22S22 17.52 22 12S17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"/>
            </svg>
        </div>
        <div class="summary-content">
            <div class="summary-label">Tổng dư nợ</div>
            <div class="summary-value" id="tongDuNo">--</div>
            <div class="summary-change" id="tyLeTangDuNo">+0%</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18A2 2 0 0 0 3.71 21H20.29A2 2 0 0 0 22.18 18L13.71 3.86A2 2 0 0 0 10.29 3.86Z"/>
                <path d="M12 9V13"/>
                <path d="M12 17H12.01"/>
            </svg>
        </div>
        <div class="summary-content">
            <div class="summary-label">Tỷ lệ nợ xấu</div>
            <div class="summary-value" id="tyLeNoXau">--%</div>
            <div class="summary-change" id="thayDoiTyLeNoXau">0%</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                <path d="M2 17L12 22L22 17"/>
                <path d="M2 12L12 17L22 12"/>
            </svg>
        </div>
        <div class="summary-content">
            <div class="summary-label">Điểm rủi ro TB</div>
            <div class="summary-value" id="diemRuiRoTB">--</div>
            <div class="summary-change" id="thayDoiDiemRuiRo">0</div>
        </div>
    </div>
</div>

<div class="content-section">
    <!-- Risk Distribution Chart -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Phân bố Rủi ro</h3>
            <select class="form-control form-control-sm" id="filterKyThoiGian" onchange="loadDanhMucList()">
                <option value="thang">Tháng này</option>
                <option value="quy">Quý này</option>
                <option value="nam">Năm nay</option>
            </select>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <div class="risk-distribution">
                    <div class="risk-item">
                        <div class="risk-bar-container">
                            <div class="risk-bar risk-low" id="barRuiRoThap" style="width: 0%;">
                                <span class="risk-bar-label" id="labelRuiRoThap">0%</span>
                            </div>
                        </div>
                        <div class="risk-info">
                            <span class="risk-name">Rủi ro Thấp</span>
                            <span class="risk-count" id="countRuiRoThap">0 khoản</span>
                        </div>
                    </div>
                    <div class="risk-item">
                        <div class="risk-bar-container">
                            <div class="risk-bar risk-medium" id="barRuiRoTB" style="width: 0%;">
                                <span class="risk-bar-label" id="labelRuiRoTB">0%</span>
                            </div>
                        </div>
                        <div class="risk-info">
                            <span class="risk-name">Rủi ro Trung bình</span>
                            <span class="risk-count" id="countRuiRoTB">0 khoản</span>
                        </div>
                    </div>
                    <div class="risk-item">
                        <div class="risk-bar-container">
                            <div class="risk-bar risk-high" id="barRuiRoCao" style="width: 0%;">
                                <span class="risk-bar-label" id="labelRuiRoCao">0%</span>
                            </div>
                        </div>
                        <div class="risk-info">
                            <span class="risk-name">Rủi ro Cao</span>
                            <span class="risk-count" id="countRuiRoCao">0 khoản</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Details -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Chi tiết Danh mục</h3>
            <div class="header-actions">
                <button class="btn btn-outline-primary btn-sm me-2" onclick="capNhatDanhMuc()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M23 4v6h-6"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Cập nhật
                </button>
                <button class="btn btn-primary btn-sm" onclick="xuatBaoCao()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3V21H21"/>
                        <path d="M7 16L12 11L16 15L21 10"/>
                        <path d="M21 10H16V15" stroke-linecap="round"/>
                    </svg>
                    Xuất báo cáo
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ngày danh mục</th>
                            <th>Tổng số khoản vay</th>
                            <th>Tổng số tiền vay</th>
                            <th>Tổng dư nợ</th>
                            <th>Tỷ lệ nợ xấu</th>
                            <th>Điểm rủi ro TB</th>
                            <th>Rủi ro Thấp</th>
                            <th>Rủi ro TB</th>
                            <th>Rủi ro Cao</th>
                        </tr>
                    </thead>
                    <tbody id="tableDanhMuc">
                        <tr>
                            <td colspan="9" class="text-center">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/quanlyruiro.css" asp-append-version="true" />
    <style>
        .btn-outline-primary {
            border: 1px solid #667eea;
            color: #667eea;
            background: transparent;
        }
        .btn-outline-primary:hover {
            background: #667eea;
            color: white;
        }
        .me-2 {
            margin-right: 0.5rem;
        }
    </style>
}

@section Scripts {
    <script src="~/js/quanlyruiro.js" asp-append-version="true"></script>
    <script>
        // Hàm format số tiền
        function formatCurrency(value) {
            if (!value && value !== 0) return '--';
            const ty = value / 1000000000000; // Chuyển sang tỷ
            if (ty >= 1) {
                return ty.toLocaleString('vi-VN', { maximumFractionDigits: 0 }) + ' tỷ';
            }
            const trieu = value / 1000000;
            if (trieu >= 1) {
                return trieu.toLocaleString('vi-VN', { maximumFractionDigits: 0 }) + ' triệu';
            }
            return value.toLocaleString('vi-VN') + ' đ';
        }

        // Hàm format ngày
        function formatDate(dateString) {
            if (!dateString) return '--';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        // Load tổng quan danh mục tín dụng
        async function loadTongQuan() {
            try {
                const response = await fetch('/QuanLyRuiRo/GetDanhMucTinDungTongQuat');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    
                    // Cập nhật summary cards
                    document.getElementById('tongSoKhoanVay').textContent = data.tongSoKhoanVay.toLocaleString('vi-VN');
                    document.getElementById('soKhoanVayMoiThang').textContent = `+${data.soKhoanVayMoiThang} tháng này`;
                    document.getElementById('soKhoanVayMoiThang').className = 'summary-change positive';
                    
                    document.getElementById('tongDuNo').textContent = formatCurrency(data.tongDuNo);
                    const tyLeTangEl = document.getElementById('tyLeTangDuNo');
                    tyLeTangEl.textContent = (data.tyLeTangDuNo >= 0 ? '+' : '') + data.tyLeTangDuNo + '%';
                    tyLeTangEl.className = 'summary-change ' + (data.tyLeTangDuNo >= 0 ? 'positive' : 'negative');
                    
                    document.getElementById('tyLeNoXau').textContent = data.tyLeNoXau + '%';
                    const thayDoiNoXauEl = document.getElementById('thayDoiTyLeNoXau');
                    thayDoiNoXauEl.textContent = (data.thayDoiTyLeNoXau >= 0 ? '+' : '') + data.thayDoiTyLeNoXau + '%';
                    thayDoiNoXauEl.className = 'summary-change ' + (data.thayDoiTyLeNoXau <= 0 ? 'positive' : 'negative');
                    
                    document.getElementById('diemRuiRoTB').textContent = data.diemRuiRoTrungBinh.toFixed(1);
                    const thayDoiDiemEl = document.getElementById('thayDoiDiemRuiRo');
                    thayDoiDiemEl.textContent = (data.thayDoiDiemRuiRo >= 0 ? '+' : '') + data.thayDoiDiemRuiRo;
                    thayDoiDiemEl.className = 'summary-change ' + (data.thayDoiDiemRuiRo <= 0 ? 'positive' : 'negative');
                    
                    // Cập nhật phân bố rủi ro
                    const tongSo = data.soKhoanVayRuiRoThap + data.soKhoanVayRuiRoTrungBinh + data.soKhoanVayRuiRoCao;
                    if (tongSo > 0) {
                        const tyLeThap = (data.soKhoanVayRuiRoThap / tongSo * 100).toFixed(1);
                        const tyLeTB = (data.soKhoanVayRuiRoTrungBinh / tongSo * 100).toFixed(1);
                        const tyLeCao = (data.soKhoanVayRuiRoCao / tongSo * 100).toFixed(1);
                        
                        document.getElementById('barRuiRoThap').style.width = tyLeThap + '%';
                        document.getElementById('labelRuiRoThap').textContent = tyLeThap + '%';
                        document.getElementById('countRuiRoThap').textContent = data.soKhoanVayRuiRoThap + ' khoản';
                        
                        document.getElementById('barRuiRoTB').style.width = tyLeTB + '%';
                        document.getElementById('labelRuiRoTB').textContent = tyLeTB + '%';
                        document.getElementById('countRuiRoTB').textContent = data.soKhoanVayRuiRoTrungBinh + ' khoản';
                        
                        document.getElementById('barRuiRoCao').style.width = tyLeCao + '%';
                        document.getElementById('labelRuiRoCao').textContent = tyLeCao + '%';
                        document.getElementById('countRuiRoCao').textContent = data.soKhoanVayRuiRoCao + ' khoản';
                    }
                }
            } catch (error) {
                console.error('Lỗi khi tải tổng quan:', error);
            }
        }

        // Load danh sách danh mục tín dụng
        async function loadDanhMucList() {
            const kyThoiGian = document.getElementById('filterKyThoiGian').value;
            
            try {
                const response = await fetch(`/QuanLyRuiRo/GetDanhMucTinDungList?kyThoiGian=${kyThoiGian}`);
                const result = await response.json();
                
                const tbody = document.getElementById('tableDanhMuc');
                
                if (result.success && result.data && result.data.length > 0) {
                    tbody.innerHTML = result.data.map(item => `
                        <tr>
                            <td>${formatDate(item.ngayDanhMuc)}</td>
                            <td>${(item.tongSoKhoanVay || 0).toLocaleString('vi-VN')}</td>
                            <td>${formatCurrency(item.tongSoTienVay || 0)}</td>
                            <td>${formatCurrency(item.tongDuNo || 0)}</td>
                            <td><span class="badge ${getBadgeClass(item.tyLeNoXau)}">${(item.tyLeNoXau || 0).toFixed(2)}%</span></td>
                            <td>${(item.diemRuiRoTrungBinh || 0).toFixed(1)}</td>
                            <td>${item.soKhoanVayRuiRoThap || 0}</td>
                            <td>${item.soKhoanVayRuiRoTrungBinh || 0}</td>
                            <td>${item.soKhoanVayRuiRoCao || 0}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center">Không có dữ liệu. Nhấn nút "Cập nhật" để tạo báo cáo mới.</td></tr>';
                }
            } catch (error) {
                console.error('Lỗi khi tải danh sách:', error);
                document.getElementById('tableDanhMuc').innerHTML = '<tr><td colspan="9" class="text-center text-danger">Lỗi khi tải dữ liệu</td></tr>';
            }
        }

        // Hàm lấy class badge theo tỷ lệ nợ xấu
        function getBadgeClass(tyLe) {
            if (!tyLe) return 'badge-success';
            if (tyLe <= 2) return 'badge-success';
            if (tyLe <= 3) return 'badge-warning';
            return 'badge-danger';
        }

        // Cập nhật danh mục tín dụng
        async function capNhatDanhMuc() {
            try {
                const response = await fetch('/QuanLyRuiRo/CapNhatDanhMucTinDung', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('Cập nhật danh mục tín dụng thành công!');
                    loadTongQuan();
                    loadDanhMucList();
                } else {
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi khi cập nhật:', error);
                alert('Có lỗi xảy ra khi cập nhật danh mục');
            }
        }

        // Xuất báo cáo Excel
        function xuatBaoCao() {
            const kyThoiGian = document.getElementById('filterKyThoiGian').value;
            window.location.href = `/QuanLyRuiRo/XuatBaoCaoDanhMucTinDung?kyThoiGian=${kyThoiGian}`;
        }

        // Khởi tạo khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            loadTongQuan();
            loadDanhMucList();
        });
    </script>
}