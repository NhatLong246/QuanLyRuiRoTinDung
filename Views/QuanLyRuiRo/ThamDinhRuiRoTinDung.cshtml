@{
    Layout = "_QuanLyRuiRoLayout";
    ViewData["Title"] = "Th·∫©m ƒë·ªãnh R·ªßi ro T√≠n d·ª•ng";
}

<div class="page-header">
    <div class="header-content">
        <div>
            <h1 class="page-title">Th·∫©m ƒë·ªãnh R·ªßi ro T√≠n d·ª•ng</h1>
            <p class="page-subtitle">ƒê√°nh gi√° v√† ph√¢n t√≠ch r·ªßi ro t√≠n d·ª•ng cho c√°c kho·∫£n vay</p>
        </div>
        <a href="@Url.Action("Index", "QuanLyRuiRo")" class="btn-back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19L5 12L12 5"/>
            </svg>
            Quay l·∫°i
        </a>
    </div>
</div>

<div class="content-section">
    <!-- Filter Section -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">T√¨m ki·∫øm v√† L·ªçc</h3>
        </div>
        <div class="card-body">
            <div class="filter-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>M√£ kho·∫£n vay</label>
                        <input type="text" id="filterMaKhoanVay" class="form-control" placeholder="Nh·∫≠p m√£ kho·∫£n vay..." />
                    </div>
                    <div class="form-group">
                        <label>Tr·∫°ng th√°i</label>
                        <select id="filterTrangThai" class="form-control">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="Ch∆∞a ƒë√°nh gi√°">Ch∆∞a ƒë√°nh gi√°</option>
                            <option value="ƒêang ƒë√°nh gi√°">ƒêang ƒë√°nh gi√°</option>
                            <option value="ƒê√£ ƒë√°nh gi√°">ƒê√£ ƒë√°nh gi√°</option>
                            <option value="ƒê√£ ph√™ duy·ªát">ƒê√£ ph√™ duy·ªát</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>M·ª©c ƒë·ªô r·ªßi ro</label>
                        <select id="filterMucDoRuiRo" class="form-control">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="Th·∫•p">Th·∫•p</option>
                            <option value="Trung b√¨nh">Trung b√¨nh</option>
                            <option value="Cao">Cao</option>
                            <option value="R·∫•t cao">R·∫•t cao</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button id="btnSearch" class="btn btn-primary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21L16.65 16.65"/>
                            </svg>
                            T√¨m ki·∫øm
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assessment List -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Danh s√°ch Th·∫©m ƒë·ªãnh</h3>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>M√£ kho·∫£n vay</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>S·ªë ti·ªÅn vay</th>
                            <th>Ng√†y ƒë√°nh gi√°</th>
                            <th>ƒêi·ªÉm r·ªßi ro</th>
                            <th>M·ª©c ƒë·ªô</th>
                            <th>X·∫øp h·∫°ng</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="9" class="text-center">
                                <div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal ƒê√°nh gi√° chi ti·∫øt -->
<div id="assessmentModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 class="modal-title">ƒê√°nh gi√° R·ªßi ro Kho·∫£n vay</h2>
            <button class="btn-close-modal" onclick="closeAssessmentModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6L18 18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="loading-container" id="modalLoading">
                <div class="spinner"></div>
                <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
            <div id="modalContent" style="display: none;">
                <!-- Th√¥ng tin kho·∫£n vay -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">Th√¥ng tin Kho·∫£n vay</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>M√£ kho·∫£n vay:</label>
                                <span id="detailMaKhoanVay" class="code-badge"></span>
                            </div>
                            <div class="info-item">
                                <label>Lo·∫°i vay:</label>
                                <span id="detailLoaiVay"></span>
                            </div>
                            <div class="info-item">
                                <label>S·ªë ti·ªÅn vay:</label>
                                <span id="detailSoTienVay" class="text-primary font-weight-bold"></span>
                            </div>
                            <div class="info-item">
                                <label>L√£i su·∫•t:</label>
                                <span id="detailLaiSuat"></span>
                            </div>
                            <div class="info-item">
                                <label>K·ª≥ h·∫°n:</label>
                                <span id="detailKyHan"></span>
                            </div>
                            <div class="info-item">
                                <label>Ng√†y n·ªôp h·ªì s∆°:</label>
                                <span id="detailNgayNopHoSo"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Th√¥ng tin kh√°ch h√†ng -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">Th√¥ng tin Kh√°ch h√†ng</h3>
                    </div>
                    <div class="card-body">
                        <div id="khachHangCaNhan" style="display: none;">
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>H·ªç t√™n:</label>
                                    <span id="detailHoTen"></span>
                                </div>
                                <div class="info-item">
                                    <label>Ng√†y sinh:</label>
                                    <span id="detailNgaySinh"></span>
                                </div>
                                <div class="info-item">
                                    <label>CMND/CCCD:</label>
                                    <span id="detailCMND"></span>
                                </div>
                                <div class="info-item">
                                    <label>ƒêi·ªán tho·∫°i:</label>
                                    <span id="detailDienThoai"></span>
                                </div>
                                <div class="info-item">
                                    <label>Email:</label>
                                    <span id="detailEmail"></span>
                                </div>
                                <div class="info-item">
                                    <label>Ngh·ªÅ nghi·ªáp:</label>
                                    <span id="detailNgheNghiep"></span>
                                </div>
                                <div class="info-item">
                                    <label>Thu nh·∫≠p h√†ng th√°ng:</label>
                                    <span id="detailThuNhap"></span>
                                </div>
                                <div class="info-item full-width">
                                    <label>ƒê·ªãa ch·ªâ:</label>
                                    <span id="detailDiaChi"></span>
                                </div>
                            </div>
                        </div>
                        <div id="khachHangDoanhNghiep" style="display: none;">
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>T√™n c√¥ng ty:</label>
                                    <span id="detailTenCongTy"></span>
                                </div>
                                <div class="info-item">
                                    <label>M√£ s·ªë thu·∫ø:</label>
                                    <span id="detailMaSoThue"></span>
                                </div>
                                <div class="info-item">
                                    <label>Ng∆∞·ªùi ƒë·∫°i di·ªán:</label>
                                    <span id="detailNguoiDaiDien"></span>
                                </div>
                                <div class="info-item">
                                    <label>ƒêi·ªán tho·∫°i:</label>
                                    <span id="detailDienThoaiDN"></span>
                                </div>
                                <div class="info-item">
                                    <label>Email:</label>
                                    <span id="detailEmailDN"></span>
                                </div>
                                <div class="info-item">
                                    <label>Lƒ©nh v·ª±c:</label>
                                    <span id="detailLinhVuc"></span>
                                </div>
                                <div class="info-item">
                                    <label>V·ªën ƒëi·ªÅu l·ªá:</label>
                                    <span id="detailVonDieuLe"></span>
                                </div>
                                <div class="info-item">
                                    <label>Doanh thu nƒÉm:</label>
                                    <span id="detailDoanhThu"></span>
                                </div>
                                <div class="info-item full-width">
                                    <label>ƒê·ªãa ch·ªâ:</label>
                                    <span id="detailDiaChiDN"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- H·ªì s∆° file ƒë√≠nh k√®m -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">H·ªì s∆° File ƒë√≠nh k√®m</h3>
                    </div>
                    <div class="card-body">
                        <div id="danhSachFile">
                            <!-- Danh s√°ch file s·∫Ω ƒë∆∞·ª£c load t·ª´ JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Th√¥ng tin t√†i s·∫£n ƒë·∫£m b·∫£o -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">T√†i s·∫£n ƒê·∫£m b·∫£o & Th·∫©m ƒë·ªãnh</h3>
                    </div>
                    <div class="card-body">
                        <div id="danhSachTaiSan">
                            <!-- Danh s√°ch t√†i s·∫£n s·∫Ω ƒë∆∞·ª£c load t·ª´ JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Form ƒë√°nh gi√° -->
                <div class="card mb-3">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="card-title">ƒê√°nh gi√° R·ªßi ro</h3>
                        <button type="button" class="btn btn-info btn-sm" onclick="xemThongTinCIC()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; margin-right: 4px;">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            Xem CIC
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Th√¥ng tin CIC (·∫©n m·∫∑c ƒë·ªãnh) -->
                        <div id="cicInfoSection" class="mb-3" style="display: none;">
                            <div class="alert alert-info">
                                <h5 style="margin-bottom: 10px;">üìä Th√¥ng tin CIC (Trung t√¢m Th√¥ng tin T√≠n d·ª•ng)</h5>
                                <div id="cicInfoContent">
                                    <!-- N·ªôi dung CIC s·∫Ω ƒë∆∞·ª£c load t·ª´ JS -->
                                </div>
                            </div>
                        </div>
                        
                        <form id="formDanhGia">
                            <input type="hidden" id="assessMaKhoanVay" />
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>T·ªïng ƒëi·ªÉm r·ªßi ro <span class="text-danger">*</span></label>
                                    <input type="number" id="assessTongDiem" class="form-control" step="0.1" min="0" max="100" required />
                                </div>
                                <div class="form-group">
                                    <label>M·ª©c ƒë·ªô r·ªßi ro <span class="text-danger">*</span></label>
                                    <select id="assessMucDoRuiRo" class="form-control" required>
                                        <option value="">-- Ch·ªçn m·ª©c ƒë·ªô --</option>
                                        <option value="Th·∫•p">Th·∫•p</option>
                                        <option value="Trung b√¨nh">Trung b√¨nh</option>
                                        <option value="Cao">Cao</option>
                                        <option value="R·∫•t cao">R·∫•t cao</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>X·∫øp h·∫°ng <span class="text-danger">*</span></label>
                                    <select id="assessXepHang" class="form-control" required>
                                        <option value="">-- Ch·ªçn x·∫øp h·∫°ng --</option>
                                        <option value="AAA">AAA - Xu·∫•t s·∫Øc</option>
                                        <option value="AA">AA - R·∫•t t·ªët</option>
                                        <option value="A">A - T·ªët</option>
                                        <option value="BBB">BBB - Kh√°</option>
                                        <option value="BB">BB - Trung b√¨nh</option>
                                        <option value="B">B - Y·∫øu</option>
                                        <option value="C">C - K√©m</option>
                                        <option value="D">D - R·∫•t k√©m</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ki·∫øn ngh·ªã <span class="text-danger">*</span></label>
                                    <select id="assessKienNghi" class="form-control" required>
                                        <option value="">-- Ch·ªçn ki·∫øn ngh·ªã --</option>
                                        <option value="Ch·∫•p thu·∫≠n">Ch·∫•p thu·∫≠n</option>
                                        <option value="C√¢n nh·∫Øc">C√¢n nh·∫Øc</option>
                                        <option value="T·ª´ ch·ªëi">T·ª´ ch·ªëi</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Nh·∫≠n x√©t chi ti·∫øt</label>
                                <textarea id="assessNhanXet" class="form-control" rows="8" style="min-height: 200px; font-family: monospace; font-size: 13px;" placeholder="Nh·∫≠p nh·∫≠n x√©t chi ti·∫øt v·ªÅ kho·∫£n vay..."></textarea>
                                <small class="form-text text-muted">T·ªëi ƒëa 1000 k√Ω t·ª±</small>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeAssessmentModal()">H·ªßy</button>
                                <button type="button" class="btn btn-primary" onclick="saveDraftAssessment()">L∆∞u nh√°p</button>
                                <button type="submit" class="btn btn-success">Ho√†n th√†nh ƒë√°nh gi√°</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/quanlyruiro.css" asp-append-version="true" />
    <style>
        .loading {
            padding: 20px;
            color: #666;
        }
        .text-center {
            text-align: center;
        }
        .no-data {
            padding: 20px;
            color: #999;
            font-style: italic;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-large {
            max-width: 1200px;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .btn-close-modal {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            color: #6b7280;
            transition: color 0.2s;
        }

        .btn-close-modal:hover {
            color: #1f2937;
        }

        .btn-close-modal svg {
            width: 24px;
            height: 24px;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 0 0 0;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @@keyframes spin {
            to { transform: rotate(360deg); }
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-item.full-width {
            grid-column: 1 / -1;
        }

        .info-item label {
            font-weight: 600;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .info-item span {
            color: #1f2937;
            font-size: 1rem;
        }

        .mb-3 {
            margin-bottom: 1.5rem;
        }

        .text-primary {
            color: #3b82f6 !important;
        }

        .font-weight-bold {
            font-weight: 700;
        }

        .text-danger {
            color: #ef4444;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #1f2937;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-info {
            background: #0ea5e9;
            color: white;
        }

        .btn-info:hover {
            background: #0284c7;
        }

        /* Tai san styles */
        .tai-san-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f9fafb;
        }

        .tai-san-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .tai-san-header h4 {
            margin: 0;
            color: #1f2937;
            font-size: 1.125rem;
        }

        .tai-san-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .info-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 8px;
        }

        .info-row .label {
            font-weight: 600;
            color: #6b7280;
            min-width: 180px;
        }

        .info-row .value {
            color: #1f2937;
            flex: 1;
        }

        .info-row .value.editable {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .info-row .value.editable:hover {
            background-color: #f3f4f6;
        }

        .btn-icon.btn-edit {
            margin-left: 8px;
            width: 24px;
            height: 24px;
            padding: 2px;
            opacity: 0.6;
            transition: opacity 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            color: #3b82f6;
        }
        
        .btn-icon.btn-edit:hover {
            opacity: 1;
        }
        
        .btn-icon.btn-edit svg {
            width: 16px;
            height: 16px;
        }

        .tham-dinh-result {
            margin-top: 1rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid;
        }

        .alert-info {
            background: #dbeafe;
            border-color: #93c5fd;
            color: #1e40af;
        }

        .alert-success {
            background: #d1fae5;
            border-color: #6ee7b7;
            color: #065f46;
        }

        .alert h4, .alert h5 {
            margin-top: 0;
            margin-bottom: 0.75rem;
        }

        .alert ul {
            list-style-type: none;
            padding-left: 0;
        }

        .alert ul li {
            padding: 0.25rem 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .table-sm {
            font-size: 0.875rem;
        }

        .table-sm th,
        .table-sm td {
            padding: 0.5rem;
        }
        
        @@keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* CIC Info Styles */
        #cicInfoSection .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        #cicInfoSection .rating-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            background: #e0e7ff;
            color: #3730a3;
            font-weight: 600;
        }
        
        #cicInfoSection .code-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            background: #dbeafe;
            color: #1e40af;
            font-family: monospace;
            font-weight: 600;
        }
        
        .col-md-6, .col-12 {
            padding: 0 10px;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .text-right {
            text-align: right;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
    </style>
}

@section Scripts {
    <script src="~/js/quanlyruiro.js" asp-append-version="true"></script>
    <script>
        // H√†m format ti·ªÅn t·ªá
        function formatCurrency(amount) {
            if (!amount && amount !== 0) return 'N/A';
            return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
        }

        // Load d·ªØ li·ªáu khi trang ƒë∆∞·ª£c t·∫£i
        $(document).ready(function() {
            // Hi·ªÉn th·ªã th√¥ng b√°o t·ª´ TempData (n·∫øu c√≥ - khi fallback form submit)
            @if(TempData["SuccessMessage"] != null) {
                <text>
                showNotification('@TempData["SuccessMessage"]', 'success');
                </text>
            }
            @if(TempData["ErrorMessage"] != null) {
                <text>
                showNotification('@TempData["ErrorMessage"]', 'error');
                </text>
            }
            
            loadKhoanVayData();

            // X·ª≠ l√Ω s·ª± ki·ªán t√¨m ki·∫øm
            $('#btnSearch').click(function() {
                loadKhoanVayData();
            });

            // T√¨m ki·∫øm khi nh·∫•n Enter
            $('#filterMaKhoanVay').keypress(function(e) {
                if (e.which === 13) {
                    loadKhoanVayData();
                }
            });
        });

        function loadKhoanVayData() {
            const maKhoanVay = $('#filterMaKhoanVay').val();
            const trangThai = $('#filterTrangThai').val();
            const mucDoRuiRo = $('#filterMucDoRuiRo').val();

            console.log('Loading data with filters:', { maKhoanVay, trangThai, mucDoRuiRo });

            $('#tableBody').html('<tr><td colspan="9" class="text-center"><div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div></td></tr>');

            $.ajax({
                url: '@Url.Action("GetKhoanVayCanThamDinh", "QuanLyRuiRo")',
                type: 'GET',
                data: {
                    maKhoanVay: maKhoanVay,
                    trangThai: trangThai,
                    mucDoRuiRo: mucDoRuiRo
                },
                success: function(response) {
                    console.log('API Response:', response);
                    if (response.success) {
                        displayKhoanVayData(response.data);
                    } else {
                        console.error('API Error:', response.message);
                        $('#tableBody').html('<tr><td colspan="9" class="text-center"><div class="no-data">L·ªói: ' + (response.message || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu') + '</div></td></tr>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', { xhr, status, error });
                    console.error('Response Text:', xhr.responseText);
                    let errorMsg = 'L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error;
                    if (xhr.responseText) {
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            errorMsg = 'L·ªói: ' + (errorData.message || errorData.title || error);
                        } catch (e) {
                            errorMsg += ' (Chi ti·∫øt: ' + xhr.responseText.substring(0, 100) + '...)';
                        }
                    }
                    $('#tableBody').html('<tr><td colspan="9" class="text-center"><div class="no-data">' + errorMsg + '</div></td></tr>');
                }
            });
        }

        function displayKhoanVayData(data) {
            if (!data || data.length === 0) {
                $('#tableBody').html('<tr><td colspan="9" class="text-center"><div class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu</div></td></tr>');
                return;
            }

            let html = '';
            data.forEach(function(item) {
                // Format s·ªë ti·ªÅn
                const soTienVay = new Intl.NumberFormat('vi-VN').format(item.soTienVay) + ' VNƒê';
                
                // Format ng√†y
                const ngayDanhGia = item.ngayDanhGia ? new Date(item.ngayDanhGia).toLocaleDateString('vi-VN') : 
                                   (item.ngayNopHoSo ? new Date(item.ngayNopHoSo).toLocaleDateString('vi-VN') : 'N/A');
                
                // ƒêi·ªÉm r·ªßi ro
                const diemRuiRo = item.diemRuiRo ? item.diemRuiRo.toFixed(1) : 'N/A';
                const diemClass = item.diemRuiRo >= 70 ? 'score-high' : (item.diemRuiRo >= 40 ? 'score-medium' : 'score-low');
                
                // M·ª©c ƒë·ªô r·ªßi ro
                const mucDoRuiRo = item.mucDoRuiRo || 'Ch∆∞a x√°c ƒë·ªãnh';
                const riskClass = getMucDoRuiRoClass(mucDoRuiRo);
                
                // X·∫øp h·∫°ng
                const xepHang = item.xepHangRuiRo || 'N/A';
                
                // Tr·∫°ng th√°i
                const trangThai = item.trangThaiDanhGia || 'Ch∆∞a ƒë√°nh gi√°';
                const statusClass = getStatusClass(trangThai);

                html += `
                    <tr>
                        <td><span class="code-badge">${item.maKhoanVayCode}</span></td>
                        <td>${item.tenKhachHang}</td>
                        <td>${soTienVay}</td>
                        <td>${ngayDanhGia}</td>
                        <td><span class="score-badge ${diemClass}">${diemRuiRo}</span></td>
                        <td><span class="risk-badge ${riskClass}">${mucDoRuiRo}</span></td>
                        <td><span class="rating-badge">${xepHang}</span></td>
                        <td><span class="status-badge ${statusClass}">${trangThai}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" title="Xem chi ti·∫øt" onclick="viewDetail(${item.maKhoanVay})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                                <button class="btn-icon" title="ƒê√°nh gi√°" onclick="editAssessment(${item.maKhoanVay})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13"/>
                                        <path d="M18.5 2.5C18.8978 2.10218 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10218 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10218 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            $('#tableBody').html(html);
        }

        function getMucDoRuiRoClass(mucDo) {
            switch(mucDo) {
                case 'Th·∫•p': return 'risk-low';
                case 'Trung b√¨nh': return 'risk-medium';
                case 'Cao': return 'risk-high';
                case 'R·∫•t cao': return 'risk-very-high';
                default: return '';
            }
        }

        function getStatusClass(trangThai) {
            switch(trangThai) {
                case 'Ch∆∞a ƒë√°nh gi√°': return 'status-new';
                case 'ƒêang ƒë√°nh gi√°': return 'status-pending';
                case 'ƒê√£ ƒë√°nh gi√°': return 'status-reviewed';
                case 'ƒê√£ ph√™ duy·ªát': return 'status-approved';
                default: return '';
            }
        }

        function viewDetail(maKhoanVay) {
            // TODO: Implement view detail
            showNotification('Xem chi ti·∫øt kho·∫£n vay: ' + maKhoanVay, 'info');
        }

        function editAssessment(maKhoanVay) {
            console.log('B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu cho kho·∫£n vay:', maKhoanVay);
            
            // Reset th√¥ng tin CIC
            window.currentCicInfo = null;
            $('#cicInfoSection').hide();
            
            // Hi·ªÉn th·ªã modal
            $('#assessmentModal').fadeIn(300);
            $('#modalLoading').show();
            $('#modalContent').hide();

            // Load d·ªØ li·ªáu chi ti·∫øt
            $.ajax({
                url: '@Url.Action("GetKhoanVayFullDetail", "QuanLyRuiRo")',
                type: 'GET',
                data: { maKhoanVay: maKhoanVay },
                success: function(response) {
                    console.log('Response nh·∫≠n ƒë∆∞·ª£c:', response);
                    if (response.success) {
                        displayAssessmentDetail(response.data);
                        $('#modalLoading').hide();
                        $('#modalContent').fadeIn(300);
                    } else {
                        console.error('L·ªói t·ª´ server:', response.message);
                        showNotification('L·ªói: ' + response.message, 'error');
                        closeAssessmentModal();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('L·ªói AJAX:', {xhr: xhr, status: status, error: error});
                    console.error('Response text:', xhr.responseText);
                    showNotification('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error, 'error');
                    closeAssessmentModal();
                }
            });
        }

        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u th√¥ng tin kho·∫£n vay hi·ªán t·∫°i
        window.currentLoanInfo = null;

        function displayAssessmentDetail(data) {
            const khoanVay = data.khoanVay;
            
            // L∆∞u th√¥ng tin kho·∫£n vay v√†o bi·∫øn to√†n c·ª•c
            window.currentLoanInfo = {
                loaiVay: data.loaiVay ? data.loaiVay.tenLoaiVay : null,
                maLoaiVay: khoanVay.maLoaiVay,
                coTaiSanDamBao: data.taiSanDamBaos && data.taiSanDamBaos.length > 0,
                soTienVay: khoanVay.soTienVay,
                kyHanVay: khoanVay.kyHanVay
            };
            
            // Th√¥ng tin kho·∫£n vay
            $('#detailMaKhoanVay').text(khoanVay.maKhoanVayCode);
            $('#detailLoaiVay').text(data.loaiVay ? data.loaiVay.tenLoaiVay : 'N/A');
            $('#detailSoTienVay').text(new Intl.NumberFormat('vi-VN').format(khoanVay.soTienVay) + ' VNƒê');
            $('#detailLaiSuat').text(khoanVay.laiSuat + '%/nƒÉm');
            $('#detailKyHan').text(khoanVay.kyHanVay + ' th√°ng');
            $('#detailNgayNopHoSo').text(khoanVay.ngayNopHoSo ? new Date(khoanVay.ngayNopHoSo).toLocaleDateString('vi-VN') : 'N/A');

            // Th√¥ng tin kh√°ch h√†ng
            if (khoanVay.loaiKhachHang === 'CaNhan' && data.khachHangCaNhan) {
                const kh = data.khachHangCaNhan;
                $('#khachHangCaNhan').show();
                $('#khachHangDoanhNghiep').hide();
                
                $('#detailHoTen').text(kh.hoTen);
                $('#detailNgaySinh').text(kh.ngaySinh ? new Date(kh.ngaySinh).toLocaleDateString('vi-VN') : 'N/A');
                $('#detailCMND').text(kh.soCmnd || 'N/A');
                $('#detailDienThoai').text(kh.soDienThoai || 'N/A');
                $('#detailEmail').text(kh.email || 'N/A');
                $('#detailNgheNghiep').text(kh.ngheNghiep || 'N/A');
                $('#detailThuNhap').text(kh.thuNhapHangThang ? new Intl.NumberFormat('vi-VN').format(kh.thuNhapHangThang) + ' VNƒê' : 'N/A');
                $('#detailDiaChi').text(kh.diaChi || 'N/A');
            } else if (khoanVay.loaiKhachHang === 'DoanhNghiep' && data.khachHangDoanhNghiep) {
                const kh = data.khachHangDoanhNghiep;
                $('#khachHangCaNhan').hide();
                $('#khachHangDoanhNghiep').show();
                
                $('#detailTenCongTy').text(kh.tenCongTy);
                $('#detailMaSoThue').text(kh.maSoThue);
                $('#detailNguoiDaiDien').text(kh.nguoiDaiDienPhapLuat || 'N/A');
                $('#detailDienThoaiDN').text(kh.soDienThoai || 'N/A');
                $('#detailEmailDN').text(kh.email || 'N/A');
                $('#detailLinhVuc').text(kh.linhVucKinhDoanh || 'N/A');
                $('#detailVonDieuLe').text(kh.vonDieuLe ? new Intl.NumberFormat('vi-VN').format(kh.vonDieuLe) + ' VNƒê' : 'N/A');
                $('#detailDoanhThu').text(kh.doanhThuHangNam ? new Intl.NumberFormat('vi-VN').format(kh.doanhThuHangNam) + ' VNƒê' : 'N/A');
                $('#detailDiaChiDN').text(kh.diaChi || 'N/A');
            }

            // Load danh s√°ch t√†i s·∫£n
            displayTaiSanList(data.taiSanDamBaos || []);

            // Load danh s√°ch file ƒë√≠nh k√®m
            loadFileDinhKem(khoanVay.maKhoanVay);

            // Load d·ªØ li·ªáu ƒë√°nh gi√° hi·ªán t·∫°i (n·∫øu c√≥)
            $('#assessMaKhoanVay').val(khoanVay.maKhoanVay);
            if (data.danhGiaRuiRo) {
                const dg = data.danhGiaRuiRo;
                $('#assessTongDiem').val(dg.tongDiem);
                $('#assessMucDoRuiRo').val(dg.mucDoRuiRo);
                $('#assessXepHang').val(dg.xepHangRuiRo);
                $('#assessKienNghi').val(dg.kienNghi);
                $('#assessNhanXet').val(dg.nhanXet);
            } else {
                // Reset form
                $('#formDanhGia')[0].reset();
                $('#assessMaKhoanVay').val(khoanVay.maKhoanVay);
            }
        }

        async function loadFileDinhKem(maKhoanVay) {
            try {
                const response = await fetch(`/QuanLyRuiRo/GetFileDinhKem?maKhoanVay=${maKhoanVay}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    displayFileDinhKem(result.data);
                } else {
                    $('#danhSachFile').html('<p class="no-data">Kh√¥ng c√≥ file ƒë√≠nh k√®m</p>');
                }
            } catch (error) {
                console.error('L·ªói khi load file ƒë√≠nh k√®m:', error);
                $('#danhSachFile').html('<p class="no-data text-danger">L·ªói khi t·∫£i file ƒë√≠nh k√®m</p>');
            }
        }

        function displayFileDinhKem(files) {
            const container = $('#danhSachFile');
            
            if (!files || files.length === 0) {
                container.html('<p class="no-data">Kh√¥ng c√≥ file ƒë√≠nh k√®m</p>');
                return;
            }

            let html = '<div class="file-list row">';
            files.forEach((file, index) => {
                const ext = file.tenFile.split('.').pop().toLowerCase();
                const isImage = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext);
                const icon = getFileIcon(file.tenFile);
                const fileSize = formatFileSize(file.kichThuoc);
                
                if (isImage) {
                    // Hi·ªÉn th·ªã ·∫£nh v·ªõi thumbnail v√† preview
                    html += `
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="file-item image-file">
                                <div class="image-preview" onclick="viewImageFullscreen('${file.duongDan}', '${file.tenFile}')">
                                    <img src="${file.duongDan}" alt="${file.tenFile}" 
                                         class="img-thumbnail" 
                                         style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;"
                                         onerror="this.src='/asset/no-image.png'">
                                </div>
                                <div class="file-info p-2">
                                    <div class="file-name text-truncate" title="${file.tenFile}">${file.tenFile}</div>
                                    <div class="file-meta small text-muted">
                                        <span class="file-size">${fileSize}</span> ‚Ä¢ 
                                        <span class="file-date">${new Date(file.ngayTao).toLocaleDateString('vi-VN')}</span>
                                    </div>
                                    <a href="${file.duongDan}" target="_blank" class="btn btn-sm btn-info btn-block mt-1" download>
                                        T·∫£i xu·ªëng
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Hi·ªÉn th·ªã file th√¥ng th∆∞·ªùng v·ªõi icon
                    html += `
                        <div class="col-md-4 col-sm-6 mb-3">
                            <div class="file-item">
                                <div class="d-flex align-items-center">
                                    <div class="file-icon mr-2" style="font-size: 2rem;">${icon}</div>
                                    <div class="file-info flex-grow-1">
                                        <div class="file-name font-weight-bold text-truncate" title="${file.tenFile}">${file.tenFile}</div>
                                        <div class="file-meta small text-muted">
                                            <span class="file-size">${fileSize}</span> ‚Ä¢ 
                                            <span class="file-date">${new Date(file.ngayTao).toLocaleDateString('vi-VN')}</span>
                                        </div>
                                    </div>
                                    <a href="${file.duongDan}" target="_blank" class="btn btn-sm btn-info ml-2" download>
                                        T·∫£i xu·ªëng
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            html += '</div>';
            
            container.html(html);
        }

        function viewImageFullscreen(imagePath, fileName) {
            const modalHtml = `
                <div id="imageViewerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                     background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
                    <div style="max-width: 90%; max-height: 90%; position: relative;">
                        <button onclick="closeImageViewer()" 
                                style="position: absolute; top: -40px; right: 0; background: white; border: none; 
                                       padding: 10px 20px; font-size: 20px; cursor: pointer; border-radius: 5px;">
                            ‚úñ ƒê√≥ng
                        </button>
                        <img src="${imagePath}" alt="${fileName}" 
                             style="max-width: 100%; max-height: 90vh; display: block; margin: auto;">
                        <div style="color: white; text-align: center; margin-top: 10px; font-size: 18px;">
                            ${fileName}
                        </div>
                    </div>
                </div>
            `;
            
            $('body').append(modalHtml);
            $('#imageViewerModal').css('display', 'flex').hide().fadeIn(300);
        }

        function closeImageViewer() {
            $('#imageViewerModal').fadeOut(300, function() {
                $(this).remove();
            });
        }

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'üìÑ',
                'doc': 'üìù',
                'docx': 'üìù',
                'xls': 'üìä',
                'xlsx': 'üìä',
                'jpg': 'üñºÔ∏è',
                'jpeg': 'üñºÔ∏è',
                'png': 'üñºÔ∏è',
                'zip': 'üì¶',
                'rar': 'üì¶'
            };
            return icons[ext] || 'üìé';
        }

        function formatFileSize(bytes) {
            if (!bytes) return 'N/A';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function displayTaiSanList(taiSans) {
            const container = $('#danhSachTaiSan');
            
            if (!taiSans || taiSans.length === 0) {
                container.html('<p class="no-data">Kh√¥ng c√≥ t√†i s·∫£n ƒë·∫£m b·∫£o</p>');
                return;
            }

            let html = '';
            taiSans.forEach((ts, index) => {
                // T√™n t√†i s·∫£n: ∆∞u ti√™n TenGoi, n·∫øu kh√¥ng c√≥ th√¨ d√πng TenTaiSanKhac
                const tenTaiSan = ts.tenGoi || ts.tenTaiSanKhac || 'Ch∆∞a x√°c ƒë·ªãnh';
                const loaiTaiSan = ts.tenLoaiTaiSan || 'N/A';
                
                // Gi√° tr·ªã: ∆∞u ti√™n gi√° tr·ªã ƒë·ªãnh gi√° t·∫°i th·ªùi ƒëi·ªÉm vay, sau ƒë√≥ l√† gi√° tr·ªã ƒë·ªãnh gi√° g·ªëc
                const giaTriDinhGia = ts.giaTriDinhGiaTaiThoiDiemVay || ts.giaTriDinhGia;
                const tyLeTheChap = ts.tyLeTheChap;
                const ngayTheChap = ts.ngayTheChap ? new Date(ts.ngayTheChap).toLocaleDateString('vi-VN') : 'Ch∆∞a c√≥';
                
                html += `
                    <div class="tai-san-item" data-ma-tai-san="${ts.maTaiSan}" data-ma-lien-ket="${ts.maLienKet}">
                        <div class="tai-san-header">
                            <h4>T√†i s·∫£n ${index + 1}: ${tenTaiSan}</h4>
                            <button type="button" class="btn btn-sm btn-primary" onclick="thamDinhTaiSan(${ts.maTaiSan}, ${ts.maLienKet})">
                                Th·∫©m ƒë·ªãnh
                            </button>
                        </div>
                        <div class="tai-san-info">
                            <div class="info-row">
                                <span class="label">Lo·∫°i t√†i s·∫£n:</span>
                                <span class="value">${loaiTaiSan}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Gi√° tr·ªã ƒë·ªãnh gi√° (VNƒê):</span>
                                <span class="value editable" data-field="giaTriDinhGia" data-ma-lien-ket="${ts.maLienKet}">
                                    ${giaTriDinhGia ? formatCurrency(giaTriDinhGia) : 'N/A'}
                                </span>
                                <button class="btn-icon btn-edit" onclick="editField(${ts.maLienKet}, 'giaTriDinhGia', ${giaTriDinhGia || 0})" title="Ch·ªânh s·ª≠a">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13"/>
                                        <path d="M18.5 2.5C18.8978 2.10218 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10218 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10218 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="info-row">
                                <span class="label">T·ª∑ l·ªá th·∫ø ch·∫•p (%):</span>
                                <span class="value editable" data-field="tyLeTheChap" data-ma-lien-ket="${ts.maLienKet}">
                                    ${tyLeTheChap ? tyLeTheChap + '%' : 'N/A'}
                                </span>
                                <button class="btn-icon btn-edit" onclick="editField(${ts.maLienKet}, 'tyLeTheChap', ${tyLeTheChap || 0})" title="Ch·ªânh s·ª≠a">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13"/>
                                        <path d="M18.5 2.5C18.8978 2.10218 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10218 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10218 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="info-row">
                                <span class="label">Ng√†y th·∫ø ch·∫•p:</span>
                                <span class="value editable" data-field="ngayTheChap" data-ma-lien-ket="${ts.maLienKet}">
                                    ${ngayTheChap}
                                </span>
                                <button class="btn-icon btn-edit" onclick="editFieldDate(${ts.maLienKet}, 'ngayTheChap', '${ts.ngayTheChap || ''}')" title="Ch·ªânh s·ª≠a">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13"/>
                                        <path d="M18.5 2.5C18.8978 2.10218 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10218 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10218 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z"/>
                                    </svg>
                                </button>
                            </div>
                            ${ts.moTaChiTiet ? `
                            <div class="info-row">
                                <span class="label">M√¥ t·∫£:</span>
                                <span class="value">${ts.moTaChiTiet}</span>
                            </div>
                            ` : ''}
                            ${ts.soGiayTo ? `
                            <div class="info-row">
                                <span class="label">S·ªë gi·∫•y t·ªù:</span>
                                <span class="value">${ts.soGiayTo}</span>
                            </div>
                            ` : ''}
                            ${ts.diaChi ? `
                            <div class="info-row">
                                <span class="label">ƒê·ªãa ch·ªâ:</span>
                                <span class="value">${ts.diaChi}${ts.quan ? ', ' + ts.quan : ''}</span>
                            </div>
                            ` : ''}
                            ${ts.dienTich ? `
                            <div class="info-row">
                                <span class="label">Di·ªán t√≠ch:</span>
                                <span class="value">${ts.dienTich} m¬≤</span>
                            </div>
                            ` : ''}
                            ${ts.hangXe || ts.dongXe || ts.namSanXuat ? `
                            <div class="info-row">
                                <span class="label">Th√¥ng tin xe:</span>
                                <span class="value">${ts.hangXe || ''} ${ts.dongXe || ''} ${ts.namSanXuat ? '(' + ts.namSanXuat + ')' : ''}</span>
                            </div>
                            ` : ''}
                            ${ts.trongLuong ? `
                            <div class="info-row">
                                <span class="label">Tr·ªçng l∆∞·ª£ng:</span>
                                <span class="value">${ts.trongLuong} ch·ªâ</span>
                            </div>
                            ` : ''}
                            ${ts.ghiChu ? `
                            <div class="info-row">
                                <span class="label">Ghi ch√∫:</span>
                                <span class="value">${ts.ghiChu}</span>
                            </div>
                            ` : ''}
                            <div id="thamDinhResult_${ts.maTaiSan}" class="tham-dinh-result"></div>
                        </div>
                    </div>
                `;
            });

            container.html(html);
        }

        async function thamDinhTaiSan(maTaiSan, maLienKet) {
            try {
                // L·∫•y th√¥ng tin t√†i s·∫£n t·ª´ DOM
                const taiSanItem = $(`.tai-san-item[data-ma-tai-san="${maTaiSan}"]`);
                
                // L·∫•y gi√° tr·ªã ƒë·ªãnh gi√° ban ƒë·∫ßu (gi√° tr·ªã khai b√°o)
                const giaTriDinhGiaStr = taiSanItem.find('[data-field="giaTriDinhGia"]').text().trim();
                const giaTriKhaiBao = parseFloat(giaTriDinhGiaStr.replace(/[^0-9]/g, '')) || 0;
                
                // L·∫•y th√¥ng tin t√†i s·∫£n t·ª´ server
                const taiSanResponse = await fetch(`/QuanLyRuiRo/GetTaiSanDetail?maTaiSan=${maTaiSan}`);
                const taiSanData = await taiSanResponse.json();
                
                if (!taiSanData.success) {
                    showNotification('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin t√†i s·∫£n!', 'error');
                    return;
                }
                
                const loaiTaiSan = taiSanData.data.tenLoaiTaiSan || '';
                const isDat = loaiTaiSan.toLowerCase().includes('ƒë·∫•t') || loaiTaiSan.toLowerCase().includes('dat');
                const isXe = loaiTaiSan.toLowerCase().includes('xe') || loaiTaiSan.toLowerCase().includes('xecop') || loaiTaiSan.toLowerCase().includes('xe c·ªô');
                
                // Hi·ªÉn th·ªã modal th·∫©m ƒë·ªãnh
                const modalHtml = `
                    <div class="modal" id="thamDinhModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Th·∫©m ƒë·ªãnh T√†i s·∫£n</h2>
                                <button class="btn-close-modal" onclick="closeThamDinhModal()">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="formThamDinh">
                                    <input type="hidden" id="thamDinhMaTaiSan" value="${maTaiSan}" />
                                    <input type="hidden" id="thamDinhMaLienKet" value="${maLienKet}" />
                                    
                                    <div class="form-group">
                                        <label>Lo·∫°i t√†i s·∫£n</label>
                                        <input type="text" id="thamDinhLoaiTaiSan" class="form-control" value="${loaiTaiSan}" readonly style="background-color: #f0f0f0;" />
                                        <input type="hidden" id="thamDinhIsDat" value="${isDat}" />
                                        <input type="hidden" id="thamDinhIsXe" value="${isXe}" />
                                        <small class="form-text text-muted">Lo·∫°i t√†i s·∫£n ƒë∆∞·ª£c l·∫•y t·ª´ h·ªì s∆° trong database</small>
                                    </div>

                                    <div id="optionsDat" style="display: ${isDat ? 'block' : 'none'};">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>Qu·∫≠n/Huy·ªán</label>
                                                <select id="thamDinhQuan" class="form-control">
                                                    <option value="">-- Ch·ªçn qu·∫≠n --</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label>Di·ªán t√≠ch (m¬≤) *</label>
                                                <input type="number" id="thamDinhDienTich" class="form-control" step="0.01" value="${taiSanData.data.dienTich || ''}" ${isDat ? 'required' : ''} />
                                            </div>
                                        </div>
                                    </div>

                                    <div id="optionsXe" style="display: ${isXe ? 'block' : 'none'};">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>H√£ng xe *</label>
                                                <select id="thamDinhHangXe" class="form-control" onchange="loadDongXeOptions()" ${isXe ? 'required' : ''}>
                                                    <option value="">-- Ch·ªçn h√£ng --</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label>D√≤ng xe *</label>
                                                <select id="thamDinhDongXe" class="form-control" ${isXe ? 'required' : ''}>
                                                    <option value="">-- Ch·ªçn d√≤ng --</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label>NƒÉm s·∫£n xu·∫•t *</label>
                                                <input type="number" id="thamDinhNamSanXuat" class="form-control" min="1990" max="2026" value="${taiSanData.data.namSanXuat || ''}" ${isXe ? 'required' : ''} />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label>Gi√° tr·ªã khai b√°o (gi√° tr·ªã ƒë·ªãnh gi√° ban ƒë·∫ßu)</label>
                                        <input type="text" id="thamDinhGiaTriKhaiBao" class="form-control" value="${giaTriKhaiBao.toLocaleString('vi-VN')}" readonly style="background-color: #f0f0f0;" />
                                        <input type="hidden" id="thamDinhGiaTriKhaiBaoValue" value="${giaTriKhaiBao}" />
                                        <small class="form-text text-muted">ƒê√¢y l√† gi√° tr·ªã ƒë·ªãnh gi√° m√† nh√¢n vi√™n ƒë√£ nh·∫≠p ban ƒë·∫ßu</small>
                                    </div>

                                    <div id="ketQuaThamChieu" class="alert alert-info" style="display: none;">
                                        <h4>K·∫øt qu·∫£ tra c·ª©u gi√° tham chi·∫øu:</h4>
                                        <div id="thongTinThamChieu"></div>
                                    </div>

                                    <hr />
                                    <h4 class="mb-3">Th√¥ng tin chi ti·∫øt t√†i s·∫£n</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>S·ªë gi·∫•y t·ªù *</label>
                                            <input type="text" id="thamDinhSoGiayTo" class="form-control" placeholder="Nh·∫≠p s·ªë gi·∫•y t·ªù..." value="${taiSanData.data.soGiayTo || ''}" />
                                        </div>
                                        <div class="form-group">
                                            <label>Ng√†y c·∫•p</label>
                                            <input type="date" id="thamDinhNgayCap" class="form-control" value="${taiSanData.data.ngayCap || ''}" />
                                        </div>
                                        <div class="form-group">
                                            <label>N∆°i c·∫•p</label>
                                            <input type="text" id="thamDinhNoiCap" class="form-control" placeholder="Nh·∫≠p n∆°i c·∫•p..." value="${taiSanData.data.noiCap || ''}" />
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Ch·ªß s·ªü h·ªØu *</label>
                                            <input type="text" id="thamDinhChuSoHuu" class="form-control" placeholder="Nh·∫≠p t√™n ch·ªß s·ªü h·ªØu..." value="${taiSanData.data.chuSoHuu || ''}" />
                                        </div>
                                        ${!isDat ? `
                                        <div class="form-group" id="divTinhTrang">
                                            <label>T√¨nh tr·∫°ng ${isXe ? '*' : ''}</label>
                                            <select id="thamDinhTinhTrang" class="form-control" ${isXe ? 'required' : ''}>
                                                <option value="">-- Ch·ªçn t√¨nh tr·∫°ng --</option>
                                                <option value="M·ªõi" ${taiSanData.data.tinhTrang === 'M·ªõi' ? 'selected' : ''}>M·ªõi</option>
                                                <option value="ƒê√£ qua s·ª≠ d·ª•ng" ${taiSanData.data.tinhTrang === 'ƒê√£ qua s·ª≠ d·ª•ng' ? 'selected' : ''}>ƒê√£ qua s·ª≠ d·ª•ng</option>
                                                <option value="C≈©" ${taiSanData.data.tinhTrang === 'C≈©' ? 'selected' : ''}>C≈©</option>
                                                <option value="H∆∞ h·ªèng" ${taiSanData.data.tinhTrang === 'H∆∞ h·ªèng' ? 'selected' : ''}>H∆∞ h·ªèng</option>
                                            </select>
                                        </div>
                                        ` : ''}
                                    </div>
                                    ${isDat ? `
                                    <div class="form-group">
                                        <label>ƒê·ªãa ch·ªâ *</label>
                                        <input type="text" id="thamDinhDiaChi" class="form-control" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt..." value="${taiSanData.data.diaChi || ''}" required />
                                    </div>
                                    ` : ''}
                                    ${isDat ? `
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Th√†nh ph·ªë/T·ªânh</label>
                                            <input type="text" id="thamDinhThanhPho" class="form-control" placeholder="Nh·∫≠p th√†nh ph·ªë..." value="${taiSanData.data.thanhPho || 'H·ªì Ch√≠ Minh'}" />
                                        </div>
                                        <div class="form-group">
                                            <label>Qu·∫≠n/Huy·ªán</label>
                                            <input type="text" id="thamDinhQuanHuyen" class="form-control" placeholder="Nh·∫≠p qu·∫≠n/huy·ªán..." value="${taiSanData.data.quan || ''}" />
                                        </div>
                                    </div>
                                    ` : ''}

                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" onclick="closeThamDinhModal()">H·ªßy</button>
                                        <button type="button" class="btn btn-info" onclick="traCuuGiaThamChieu()">Tra c·ª©u gi√° tham chi·∫øu</button>
                                        <button type="button" class="btn btn-success" onclick="luuKetQuaThamDinh()">L∆∞u k·∫øt qu·∫£</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                
$('body').append(modalHtml);
                $('#thamDinhModal').fadeIn(300);
                
                // Load danh s√°ch d·ª±a tr√™n lo·∫°i t√†i s·∫£n
                if (isDat) {
                    await loadQuanOptions();
                } else if (isXe) {
                    await loadHangXeOptions();
                }
            } catch (error) {
                console.error('L·ªói khi th·∫©m ƒë·ªãnh t√†i s·∫£n:', error);
                showNotification('C√≥ l·ªói x·∫£y ra khi m·ªü form th·∫©m ƒë·ªãnh: ' + error.message, 'error');
            }
        }

        async function loadQuanOptions() {
            try {
                const response = await fetch('/QuanLyRuiRo/GetGiaTriThamChieu?loaiTaiSan=ƒê·∫•t');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const select = $('#thamDinhQuan');
                    const quans = [...new Set(result.data.map(item => item.quan))];
                    quans.forEach(quan => {
                        select.append(`<option value="${quan}">${quan}</option>`);
                    });
                }
            } catch (error) {
                console.error('L·ªói khi load danh s√°ch qu·∫≠n:', error);
            }
        }

        async function loadHangXeOptions() {
            try {
                const response = await fetch('/QuanLyRuiRo/GetGiaTriThamChieu?loaiTaiSan=Xe');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const select = $('#thamDinhHangXe');
                    const hangs = [...new Set(result.data.map(item => item.hangXe))];
                    hangs.forEach(hang => {
                        select.append(`<option value="${hang}">${hang}</option>`);
                    });
                }
            } catch (error) {
                console.error('L·ªói khi load danh s√°ch h√£ng xe:', error);
            }
        }

        async function loadDongXeOptions() {
            const hangXe = $('#thamDinhHangXe').val();
            if (!hangXe) return;
            
            try {
                const response = await fetch(`/QuanLyRuiRo/GetGiaTriThamChieu?loaiTaiSan=Xe&keyword=${hangXe}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const select = $('#thamDinhDongXe');
                    select.empty().append('<option value="">-- Ch·ªçn d√≤ng --</option>');
                    const dongs = [...new Set(result.data.map(item => item.dongXe))];
                    dongs.forEach(dong => {
                        select.append(`<option value="${dong}">${dong}</option>`);
                    });
                }
            } catch (error) {
                console.error('L·ªói khi load danh s√°ch d√≤ng xe:', error);
            }
        }

        // H√†m ƒë√£ ƒë∆∞·ª£c x√≥a v√¨ lo·∫°i t√†i s·∫£n l·∫•y t·ª´ database v√† hi·ªÉn th·ªã ƒë·ªông

        async function traCuuGiaThamChieu() {
            const loaiTaiSan = $('#thamDinhLoaiTaiSan').val().trim();
            const isDat = $('#thamDinhIsDat').val() === 'true';
            if (!loaiTaiSan) {
                showNotification('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c lo·∫°i t√†i s·∫£n!', 'warning');
                return;
            }

            try {
                let requestData = { loaiTaiSan: loaiTaiSan };
                
                if (isDat) {
                    requestData.quan = $('#thamDinhQuan').val();
                } else if (loaiTaiSan.toLowerCase().includes('xe')) {
                    requestData.hangXe = $('#thamDinhHangXe').val();
                    requestData.dongXe = $('#thamDinhDongXe').val();
                    requestData.namSanXuat = parseInt($('#thamDinhNamSanXuat').val()) || null;
                }

                const response = await fetch('/QuanLyRuiRo/TimGiaTriThamChieu', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                console.log('Response t·ª´ API TimGiaTriThamChieu:', result);
                
                if (result.success && result.data) {
                    const data = result.data;
                    let html = '<table class="table table-sm table-bordered"><tbody>';
                    
                    if (isDat) {
                        const dienTich = parseFloat($('#thamDinhDienTich').val()) || 1;
                        const giaTriThamChieu = data.giaTriThamChieu * dienTich;
                        const giaTriThamDinh = giaTriThamChieu * (data.tyLeThamDinh / 100);
                        
                        html += `
                            <tr><th width="40%">Qu·∫≠n:</th><td>${data.quan || 'N/A'}</td></tr>
                            <tr><th>Gi√° tham chi·∫øu (VNƒê/m¬≤):</th><td><strong>${formatCurrency(data.giaTriThamChieu)}</strong></td></tr>
                            <tr><th>Di·ªán t√≠ch (m¬≤):</th><td>${dienTich}</td></tr>
                            <tr class="bg-light"><th>T·ªïng gi√° tr·ªã tham chi·∫øu:</th><td class="text-primary"><strong>${formatCurrency(giaTriThamChieu)}</strong></td></tr>
                            <tr><th>T·ª∑ l·ªá th·∫©m ƒë·ªãnh:</th><td>${data.tyLeThamDinh}%</td></tr>
                            <tr class="table-success"><th>Gi√° tr·ªã th·∫©m ƒë·ªãnh:</th><td class="text-success"><strong>${formatCurrency(giaTriThamDinh)}</strong></td></tr>
                        `;
                    } else if (loaiTaiSan.toLowerCase().includes('xe')) {
                        const giaTriThamDinh = data.giaTriThamChieu * (data.tyLeThamDinh / 100);
                        
                        html += `
                            <tr><th width="40%">H√£ng xe:</th><td>${data.hangXe || 'N/A'}</td></tr>
                            <tr><th>D√≤ng xe:</th><td>${data.dongXe || 'N/A'}</td></tr>
                            <tr><th>NƒÉm s·∫£n xu·∫•t:</th><td>${data.namSanXuat || 'N/A'}</td></tr>
                            <tr class="bg-light"><th>Gi√° tham chi·∫øu:</th><td class="text-primary"><strong>${formatCurrency(data.giaTriThamChieu)}</strong></td></tr>
                            <tr><th>T·ª∑ l·ªá th·∫©m ƒë·ªãnh:</th><td>${data.tyLeThamDinh}%</td></tr>
                            <tr class="table-success"><th>Gi√° tr·ªã th·∫©m ƒë·ªãnh:</th><td class="text-success"><strong>${formatCurrency(giaTriThamDinh)}</strong></td></tr>
                        `;
                    }
                    
                    html += '</tbody></table>';
                    
                    $('#thongTinThamChieu').html(html);
                    $('#ketQuaThamChieu').show();
                    
                    // L∆∞u d·ªØ li·ªáu tham chi·∫øu v√†o form
                    $('#formThamDinh').data('thamChieu', data);
                    
                } else {
                    const errorMsg = result.message || 'Kh√¥ng t√¨m th·∫•y gi√° tr·ªã tham chi·∫øu ph√π h·ª£p!';
                    showNotification(errorMsg, 'warning');
                    console.error('L·ªói API:', errorMsg);
                    $('#ketQuaThamChieu').hide();
                }
            } catch (error) {
                console.error('L·ªói khi tra c·ª©u gi√° tham chi·∫øu:', error);
                showNotification('C√≥ l·ªói x·∫£y ra khi tra c·ª©u gi√° tham chi·∫øu: ' + error.message, 'error');
            }
        }

        async function luuKetQuaThamDinh() {
            const maTaiSan = $('#thamDinhMaTaiSan').val();
            const maLienKet = $('#thamDinhMaLienKet').val();
            const thamChieu = $('#formThamDinh').data('thamChieu');
            const giaTriKhaiBao = parseFloat($('#thamDinhGiaTriKhaiBaoValue').val()) || 0;
            const isDat = $('#thamDinhIsDat').val() === 'true';
            const isXe = $('#thamDinhIsXe').val() === 'true';
            
            if (!thamChieu) {
                showNotification('Vui l√≤ng tra c·ª©u gi√° tham chi·∫øu tr∆∞·ªõc!', 'warning');
                return;
            }

            if (!maLienKet) {
                showNotification('Kh√¥ng t√¨m th·∫•y m√£ li√™n k·∫øt t√†i s·∫£n!', 'error');
                return;
            }

            // T√≠nh gi√° tr·ªã th·∫©m ƒë·ªãnh
            let giaTriThamChieuTotal = 0;
            let giaTriThamDinh = 0;
            const loaiTaiSan = $('#thamDinhLoaiTaiSan').val();
            let dienTich = null;
            
            if (isDat) {
                const dienTich = parseFloat($('#thamDinhDienTich').val()) || 1;
                giaTriThamChieuTotal = thamChieu.giaTriThamChieu * dienTich;
                giaTriThamDinh = giaTriThamChieuTotal * (thamChieu.tyLeThamDinh / 100);
            } else if (isXe) {
                // Ki·ªÉm tra th√¥ng tin xe b·∫Øt bu·ªôc
                const hangXe = $('#thamDinhHangXe').val();
                const dongXe = $('#thamDinhDongXe').val();
                const namSanXuat = $('#thamDinhNamSanXuat').val();
                const tinhTrang = $('#thamDinhTinhTrang').val();
                
                if (!hangXe || !dongXe || !namSanXuat || !tinhTrang) {
                    showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin xe: H√£ng xe, D√≤ng xe, NƒÉm s·∫£n xu·∫•t, T√¨nh tr·∫°ng!', 'warning');
                    return;
                }
                
                giaTriThamChieuTotal = thamChieu.giaTriThamChieu;
                giaTriThamDinh = giaTriThamChieuTotal * (thamChieu.tyLeThamDinh / 100);
            } else {
                giaTriThamChieuTotal = thamChieu.giaTriThamChieu;
                giaTriThamDinh = thamChieu.giaTriThamChieu * (thamChieu.tyLeThamDinh / 100);
            }

            // Ghi ch√∫ th·∫©m ƒë·ªãnh (kh√¥ng c·∫ßn t√≠nh ch√™nh l·ªách v·ªõi gi√° khai b√°o)
            let ghiChu = `Lo·∫°i t√†i s·∫£n: ${loaiTaiSan}. `;
            if (isDat) {
                const quan = $('#thamDinhQuan').val();
                const dienTich = $('#thamDinhDienTich').val();
                ghiChu += `Qu·∫≠n: ${quan}, Di·ªán t√≠ch: ${dienTich}m¬≤. `;
            } else if (isXe) {
                const hangXe = $('#thamDinhHangXe').val();
                const dongXe = $('#thamDinhDongXe').val();
                const namSX = $('#thamDinhNamSanXuat').val();
                const tinhTrang = $('#thamDinhTinhTrang').val();
                ghiChu += `${hangXe} ${dongXe} nƒÉm ${namSX}, t√¨nh tr·∫°ng: ${tinhTrang}. `;
            }
            ghiChu += `Gi√° tham chi·∫øu: ${formatCurrency(giaTriThamChieuTotal)}. Gi√° tr·ªã ƒë·ªãnh gi√°: ${formatCurrency(giaTriThamDinh)} (${thamChieu.tyLeThamDinh}%).`;

            // Validate c√°c tr∆∞·ªùng b·∫Øt bu·ªôc
            const soGiayTo = $('#thamDinhSoGiayTo').val();
            const chuSoHuu = $('#thamDinhChuSoHuu').val();
            const diaChi = isDat ? $('#thamDinhDiaChi').val() : null;
            
            if (!soGiayTo || !chuSoHuu) {
                showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc: S·ªë gi·∫•y t·ªù, Ch·ªß s·ªü h·ªØu!', 'warning');
                return;
            }
            
            if (isDat && !diaChi) {
                showNotification('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ cho lo·∫°i t√†i s·∫£n ƒë·∫•t!', 'warning');
                return;
            }

            try {
                // B∆∞·ªõc 1: L∆∞u k·∫øt qu·∫£ th·∫©m ƒë·ªãnh v√†o TaiSanDamBao
                const thamDinhResponse = await fetch('/QuanLyRuiRo/LuuKetQuaThamDinh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        maTaiSan: parseInt(maTaiSan),
                        giaTriThamChieu: giaTriThamChieuTotal,
                        giaTriThamDinh: giaTriThamDinh,
                        tyLeThamDinh: thamChieu.tyLeThamDinh,
                        ghiChu: ghiChu,
                        soGiayTo: soGiayTo,
                        ngayCap: $('#thamDinhNgayCap').val() || null,
                        noiCap: $('#thamDinhNoiCap').val() || null,
                        chuSoHuu: chuSoHuu,
                        diaChi: diaChi,
                        thanhPho: isDat ? $('#thamDinhThanhPho').val() : null,
                        quan: isDat ? $('#thamDinhQuanHuyen').val() : null,
                        tinhTrang: !isDat ? ($('#thamDinhTinhTrang').val() || null) : null,
                        dienTich: dienTich
                    })
                });

                const thamDinhResult = await thamDinhResponse.json();
                
                if (!thamDinhResult.success) {
                    showNotification('L·ªói khi l∆∞u th·∫©m ƒë·ªãnh: ' + (thamDinhResult.message || 'Kh√¥ng th·ªÉ l∆∞u'), 'error');
                    return;
                }

                // B∆∞·ªõc 2: C·∫≠p nh·∫≠t gi√° tr·ªã v√†o KhoanVay_TaiSan (ƒë·ªÉ hi·ªÉn th·ªã b√™n ngo√†i)
                const updateResponse = await fetch('/QuanLyRuiRo/UpdateTaiSanThamDinh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        maLienKet: parseInt(maLienKet),
                        giaTriDinhGia: giaTriThamDinh,
                        tyLeTheChap: thamChieu.tyLeThamDinh,
                        ngayTheChap: new Date().toISOString().split('T')[0],
                        ghiChu: ghiChu
                    })
                });

                const updateResult = await updateResponse.json();
                
                if (updateResult.success) {
                    // B∆∞·ªõc 3: C·∫≠p nh·∫≠t hi·ªÉn th·ªã b√™n ngo√†i
                    $(`.value.editable[data-field="giaTriDinhGia"][data-ma-lien-ket="${maLienKet}"]`).text(formatCurrency(giaTriThamDinh));
                    $(`.value.editable[data-field="tyLeTheChap"][data-ma-lien-ket="${maLienKet}"]`).text(thamChieu.tyLeThamDinh + '%');
                    $(`.value.editable[data-field="ngayTheChap"][data-ma-lien-ket="${maLienKet}"]`).text(new Date().toLocaleDateString('vi-VN'));
                    
                    // Hi·ªÉn th·ªã k·∫øt qu·∫£ trong danh s√°ch t√†i s·∫£n
                    const resultHtml = `
                        <div class="alert alert-success mt-3">
                            <h5>‚úÖ ƒê√£ l∆∞u k·∫øt qu·∫£ th·∫©m ƒë·ªãnh!</h5>
                            <ul class="mb-0">
                                <li>Gi√° tr·ªã tham chi·∫øu: <strong>${formatCurrency(giaTriThamChieuTotal)}</strong></li>
                                <li>Gi√° tr·ªã ƒë·ªãnh gi√° (Th·∫©m ƒë·ªãnh): <strong>${formatCurrency(giaTriThamDinh)}</strong> (${thamChieu.tyLeThamDinh}%)</li>
                            </ul>
                        </div>
                    `;

                    $(`#thamDinhResult_${maTaiSan}`).html(resultHtml);
                    
                    // B∆∞·ªõc 4: T·ª± ƒë·ªông t√≠nh to√°n v√† ƒëi·ªÅn ƒë·ªÅ xu·∫•t v√†o form ƒê√°nh gi√° R·ªßi ro
                    await tinhToanVaDienDanhGiaRuiRo(giaTriThamDinh);
                    
                    showNotification('ƒê√£ l∆∞u k·∫øt qu·∫£ th·∫©m ƒë·ªãnh v√† c·∫≠p nh·∫≠t gi√° tr·ªã!', 'success');
                    
                    setTimeout(() => {
                        closeThamDinhModal();
                    }, 2000);
                } else {
                    showNotification('L·ªói khi c·∫≠p nh·∫≠t gi√° tr·ªã: ' + (updateResult.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t'), 'error');
                }
            } catch (error) {
                console.error('L·ªói khi l∆∞u th·∫©m ƒë·ªãnh:', error);
                showNotification('C√≥ l·ªói x·∫£y ra khi l∆∞u th·∫©m ƒë·ªãnh: ' + error.message, 'error');
            }
        }

        // H√†m t√≠nh to√°n v√† ƒëi·ªÅn t·ª± ƒë·ªông v√†o form ƒê√°nh gi√° R·ªßi ro
        async function tinhToanVaDienDanhGiaRuiRo(giaTriTaiSanThamDinh) {
            try {
                // L·∫•y th√¥ng tin kho·∫£n vay
                const soTienVay = parseFloat($('#detailSoTienVay').text().replace(/[^\d]/g, '')) || 0;
                const maKhoanVay = parseInt($('#assessMaKhoanVay').val());
                
                // L·∫•y th√¥ng tin thu nh·∫≠p t·ª´ server
                let thuNhap = 0;
                try {
                    const response = await fetch(`/QuanLyRuiRo/GetKhoanVayFullDetail?maKhoanVay=${maKhoanVay}`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        thuNhap = result.data.khachHangCaNhan?.thuNhapHangThang || 
                                 result.data.khachHangDoanhNghiep?.doanhThuNam / 12 || 0;
                    }
                } catch (err) {
                    console.warn('Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin thu nh·∫≠p:', err);
                }
                
                // L·∫•y th√¥ng tin CIC (n·∫øu c√≥)
                let cicInfo = window.currentCicInfo || null;
                if (!cicInfo) {
                    try {
                        const cicResponse = await fetch(`/QuanLyRuiRo/GetThongTinCic?maKhoanVay=${maKhoanVay}`);
                        const cicResult = await cicResponse.json();
                        if (cicResult.success && cicResult.data) {
                            cicInfo = cicResult.data;
                            window.currentCicInfo = cicInfo;
                        }
                    } catch (err) {
                        console.warn('Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin CIC:', err);
                    }
                }
                
                // T√≠nh LTV (Loan-to-Value)
                const ltv = soTienVay > 0 && giaTriTaiSanThamDinh > 0 
                    ? (soTienVay / giaTriTaiSanThamDinh) * 100 
                    : 0;

                // ===== THU·∫¨T TO√ÅN T√çNH ƒêI·ªÇM R·ª¶I RO C·∫¢I TI·∫æN (0-100) =====
                // Bao g·ªìm: CIC (40ƒë), LTV (30ƒë), Gi√° tr·ªã t√†i s·∫£n (20ƒë), Thu nh·∫≠p (10ƒë)
                
                let tongDiem = 0;
                let mucDoRuiRo = '';
                let xepHang = '';
                let kienNghi = '';

                // 1. ƒê√°nh gi√° LTV - Ch·ªâ s·ªë quan tr·ªçng (30 ƒëi·ªÉm)
                let diemLTV = 0;
                if (ltv <= 30) {
                    diemLTV = 0; // Xu·∫•t s·∫Øc
                } else if (ltv <= 50) {
                    diemLTV = 5; // R·∫•t t·ªët
                } else if (ltv <= 70) {
                    diemLTV = 10; // T·ªët (chu·∫©n ng√¢n h√†ng)
                } else if (ltv <= 80) {
                    diemLTV = 18; // Ch·∫•p nh·∫≠n ƒë∆∞·ª£c
                } else if (ltv <= 100) {
                    diemLTV = 25; // Cao
                } else {
                    diemLTV = 30; // R·∫•t cao - v∆∞·ª£t gi√° tr·ªã t√†i s·∫£n
                }

                // 2. ƒê√°nh gi√° CIC - Y·∫øu t·ªë quan tr·ªçng nh·∫•t (40 ƒëi·ªÉm)
                let diemCIC = 20; // M·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ CIC
                let cicNhanXet = '';
                
                if (cicInfo) {
                    const diemTinDungCIC = cicInfo.diemTinDungCic || 0;
                    const soLanNoXau = cicInfo.soLanNoXauCic || 0;
                    const soKhoanVayNoXau = cicInfo.soKhoanVayNoXauCic || 0;
                    const soLanQuaHan = cicInfo.soLanQuaHanCic || 0;
                    const tyLeTraNoDungHan = cicInfo.tyLeTraNoDungHanCic || 0;
                    const khuyenNghiCIC = cicInfo.khuyenNghiChoVay || '';
                    
                    // ƒêi·ªÉm CIC (0-1000) -> Chuy·ªÉn ƒë·ªïi th√†nh ƒëi·ªÉm r·ªßi ro
                    // ƒêi·ªÉm CIC cao = r·ªßi ro th·∫•p, ƒêi·ªÉm CIC th·∫•p = r·ªßi ro cao
                    if (diemTinDungCIC >= 800) {
                        diemCIC = 0; // Xu·∫•t s·∫Øc
                        cicNhanXet = 'ƒêi·ªÉm CIC xu·∫•t s·∫Øc (‚â•800)';
                    } else if (diemTinDungCIC >= 700) {
                        diemCIC = 6; // R·∫•t t·ªët
                        cicNhanXet = 'ƒêi·ªÉm CIC r·∫•t t·ªët (700-799)';
                    } else if (diemTinDungCIC >= 600) {
                        diemCIC = 12; // T·ªët
                        cicNhanXet = 'ƒêi·ªÉm CIC t·ªët (600-699)';
                    } else if (diemTinDungCIC >= 500) {
                        diemCIC = 20; // Trung b√¨nh
                        cicNhanXet = 'ƒêi·ªÉm CIC trung b√¨nh (500-599)';
                    } else if (diemTinDungCIC >= 400) {
                        diemCIC = 28; // Y·∫øu
                        cicNhanXet = 'ƒêi·ªÉm CIC y·∫øu (400-499)';
                    } else if (diemTinDungCIC > 0) {
                        diemCIC = 35; // K√©m
                        cicNhanXet = 'ƒêi·ªÉm CIC k√©m (<400)';
                    }
                    
                    // C·ªông th√™m ƒëi·ªÉm r·ªßi ro n·∫øu c√≥ n·ª£ x·∫•u
                    if (soKhoanVayNoXau > 0 || soLanNoXau > 0) {
                        diemCIC = Math.min(40, diemCIC + 12); // C·ªông th√™m 12 ƒëi·ªÉm r·ªßi ro
                        cicNhanXet += ' - ‚ö†Ô∏è C√ì N·ª¢ X·∫§U';
                    }
                    
                    // ƒêi·ªÅu ch·ªânh theo khuy·∫øn ngh·ªã t·ª´ CIC
                    if (khuyenNghiCIC === 'KhongChoVay') {
                        diemCIC = 40; // T·ªëi ƒëa
                        cicNhanXet += ' - CIC KHUY·∫æN NGH·ªä KH√îNG CHO VAY';
                    } else if (khuyenNghiCIC === 'CanThanTrong') {
                        diemCIC = Math.max(25, diemCIC);
                    }
                    
                    // ƒêi·ªÅu ch·ªânh theo t·ª∑ l·ªá tr·∫£ n·ª£ ƒë√∫ng h·∫°n
                    if (tyLeTraNoDungHan < 70) {
                        diemCIC = Math.min(40, diemCIC + 6);
                    } else if (tyLeTraNoDungHan >= 95) {
                        diemCIC = Math.max(0, diemCIC - 4);
                    }
                } else {
                    cicNhanXet = 'Kh√¥ng c√≥ th√¥ng tin CIC - C·∫ßn x√°c minh th√™m';
                }

                // 3. ƒê√°nh gi√° thu nh·∫≠p DTI (10 ƒëi·ªÉm)
                let diemThuNhap = 5; // M·∫∑c ƒë·ªãnh
                let dti = 0;
                if (thuNhap > 0) {
                    const kyHanVay = parseInt($('#detailKyHan').text()) || 12;
                    const traHangThang = soTienVay / kyHanVay;
                    dti = (traHangThang / thuNhap) * 100;
                    
                    if (dti <= 30) {
                        diemThuNhap = 0; // Xu·∫•t s·∫Øc
                    } else if (dti <= 40) {
                        diemThuNhap = 2; // T·ªët
                    } else if (dti <= 50) {
                        diemThuNhap = 4; // Ch·∫•p nh·∫≠n
                    } else if (dti <= 60) {
                        diemThuNhap = 6; // CƒÉng th·∫≥ng
                    } else if (dti <= 80) {
                        diemThuNhap = 8; // Cao
                    } else {
                        diemThuNhap = 10; // R·∫•t cao
                    }
                }

                // 4. ƒê√°nh gi√° gi√° tr·ªã t√†i s·∫£n (20 ƒëi·ªÉm)
                let diemGiaTriTaiSan = 10; // M·∫∑c ƒë·ªãnh
                if (giaTriTaiSanThamDinh > 5000000000) {
                    diemGiaTriTaiSan = 0; // > 5 t·ª∑
                } else if (giaTriTaiSanThamDinh > 2000000000) {
                    diemGiaTriTaiSan = 4; // > 2 t·ª∑
                } else if (giaTriTaiSanThamDinh > 1000000000) {
                    diemGiaTriTaiSan = 8; // > 1 t·ª∑
                } else if (giaTriTaiSanThamDinh > 500000000) {
                    diemGiaTriTaiSan = 14; // > 500tr
                } else {
                    diemGiaTriTaiSan = 20; // <= 500tr
                }

                // T·ªïng ƒëi·ªÉm r·ªßi ro
                tongDiem = diemLTV + diemCIC + diemThuNhap + diemGiaTriTaiSan;

                // X√°c ƒë·ªãnh m·ª©c ƒë·ªô r·ªßi ro v√† x·∫øp h·∫°ng
                if (tongDiem < 20) {
                    mucDoRuiRo = 'Th·∫•p';
                    xepHang = 'AAA';
                    kienNghi = 'Ch·∫•p thu·∫≠n';
                } else if (tongDiem < 30) {
                    mucDoRuiRo = 'Th·∫•p';
                    xepHang = 'AA';
                    kienNghi = 'Ch·∫•p thu·∫≠n';
                } else if (tongDiem < 40) {
                    mucDoRuiRo = 'Trung b√¨nh';
                    xepHang = 'A';
                    kienNghi = 'Ch·∫•p thu·∫≠n';
                } else if (tongDiem < 50) {
                    mucDoRuiRo = 'Trung b√¨nh';
                    xepHang = 'BBB';
                    kienNghi = 'C√¢n nh·∫Øc';
                } else if (tongDiem < 60) {
                    mucDoRuiRo = 'Cao';
                    xepHang = 'BB';
                    kienNghi = 'C√¢n nh·∫Øc';
                } else if (tongDiem < 70) {
                    mucDoRuiRo = 'Cao';
                    xepHang = 'B';
                    kienNghi = 'T·ª´ ch·ªëi';
                } else if (tongDiem < 85) {
                    mucDoRuiRo = 'R·∫•t cao';
                    xepHang = 'C';
                    kienNghi = 'T·ª´ ch·ªëi';
                } else {
                    mucDoRuiRo = 'R·∫•t cao';
                    xepHang = 'D';
                    kienNghi = 'T·ª´ ch·ªëi';
                }

                // N·∫øu CIC khuy·∫øn ngh·ªã kh√¥ng cho vay - b·∫Øt bu·ªôc t·ª´ ch·ªëi
                if (cicInfo && cicInfo.khuyenNghiChoVay === 'KhongChoVay') {
                    kienNghi = 'T·ª´ ch·ªëi';
                    if (tongDiem < 60) {
                        tongDiem = 60;
                        mucDoRuiRo = 'Cao';
                        xepHang = 'B';
                    }
                }

                // T·∫°o nh·∫≠n x√©t chi ti·∫øt (r√∫t g·ªçn ƒë·ªÉ v·ª´a 1000 k√Ω t·ª±)
                let nhanXet = 'DIEM RUI RO:\n';
                nhanXet += `CIC:${diemCIC}/40 | LTV:${diemLTV}/30 | TS:${diemGiaTriTaiSan}/20 | TN:${diemThuNhap}/10\n`;
                nhanXet += `TONG: ${tongDiem}/100\n\n`;
                
                // Th√¥ng tin CIC ng·∫Øn g·ªçn
                if (cicInfo) {
                    nhanXet += `CIC: ${cicInfo.diemTinDungCic || 'N/A'} - ${cicInfo.xepHangTinDungCic || 'N/A'}`;
                    if (cicInfo.soKhoanVayNoXauCic > 0) {
                        nhanXet += ` - CO NO XAU`;
                    }
                    nhanXet += '\n';
                }
                
                // Ch·ªâ s·ªë t√†i ch√≠nh ng·∫Øn g·ªçn
                nhanXet += `LTV: ${ltv.toFixed(0)}%`;
                if (thuNhap > 0) {
                    nhanXet += ` | DTI: ${dti.toFixed(0)}%`;
                }
                nhanXet += '\n';
                
                // K·∫øt lu·∫≠n
                nhanXet += `KET LUAN: ${mucDoRuiRo} - ${xepHang} - ${kienNghi}`;
                
                if (cicInfo && cicInfo.soKhoanVayNoXauCic > 0) {
                    nhanXet += ' - CANH BAO NO XAU';
                }
                if (ltv > 100) {
                    nhanXet += ' - VUOT GIA TRI TS';
                }

                // ƒêi·ªÅn v√†o form
                $('#assessTongDiem').val(tongDiem.toFixed(1));
                $('#assessMucDoRuiRo').val(mucDoRuiRo);
                $('#assessXepHang').val(xepHang);
                $('#assessKienNghi').val(kienNghi);
                $('#assessNhanXet').val(nhanXet);

                console.log('ƒê√£ t√≠nh to√°n v√† ƒëi·ªÅn ƒë·ªÅ xu·∫•t ƒë√°nh gi√° r·ªßi ro (c√≥ CIC):', {
                    tongDiem: tongDiem,
                    diemLTV: diemLTV,
                    diemCIC: diemCIC,
                    diemThuNhap: diemThuNhap,
                    diemGiaTriTaiSan: diemGiaTriTaiSan,
                    ltv: ltv,
                    mucDoRuiRo: mucDoRuiRo,
                    xepHang: xepHang,
                    kienNghi: kienNghi,
                    cicInfo: cicInfo ? 'C√≥' : 'Kh√¥ng'
                });

            } catch (error) {
                console.error('L·ªói khi t√≠nh to√°n ƒë√°nh gi√° r·ªßi ro:', error);
            }
        }

        function closeThamDinhModal() {
            $('#thamDinhModal').fadeOut(300, function() {
                $(this).remove();
            });
        }

        // H√†m ch·ªânh s·ª≠a tr∆∞·ªùng s·ªë (gi√° tr·ªã ƒë·ªãnh gi√°, t·ª∑ l·ªá th·∫ø ch·∫•p)
        async function editField(maLienKet, fieldName, currentValue) {
            const fieldLabel = fieldName === 'giaTriDinhGia' ? 'Gi√° tr·ªã ƒë·ªãnh gi√° (VNƒê)' : 'T·ª∑ l·ªá th·∫ø ch·∫•p (%)';
            const step = fieldName === 'giaTriDinhGia' ? '1000000' : '0.01';
            
            const newValue = prompt(`Nh·∫≠p ${fieldLabel}:`, currentValue || '');
            
            if (newValue === null || newValue === '') return;
            
            const parsedValue = parseFloat(newValue);
            if (isNaN(parsedValue) || parsedValue < 0) {
                showNotification('Gi√° tr·ªã kh√¥ng h·ª£p l·ªá!', 'warning');
                return;
            }
            
            // Chu·∫©n b·ªã d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t
            const updateData = {
                maLienKet: maLienKet,
                giaTriDinhGia: fieldName === 'giaTriDinhGia' ? parsedValue : null,
                tyLeTheChap: fieldName === 'tyLeTheChap' ? parsedValue : null,
                ngayTheChap: null,
                ghiChu: null
            };
            
            try {
                const response = await fetch('/QuanLyRuiRo/UpdateTaiSanThamDinh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
                    const displayValue = fieldName === 'giaTriDinhGia' 
                        ? formatCurrency(parsedValue) 
                        : parsedValue + '%';
                    $(`.value.editable[data-field="${fieldName}"][data-ma-lien-ket="${maLienKet}"]`).text(displayValue);
                    
                    // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                    showNotification('ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
                } else {
                    showNotification('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t'), 'error');
                }
            } catch (error) {
                console.error('L·ªói khi c·∫≠p nh·∫≠t:', error);
                showNotification('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t!', 'error');
            }
        }
        
        // H√†m ch·ªânh s·ª≠a tr∆∞·ªùng ng√†y
        async function editFieldDate(maLienKet, fieldName, currentValue) {
            // Chuy·ªÉn ƒë·ªïi currentValue sang ƒë·ªãnh d·∫°ng yyyy-MM-dd cho input type="date"
            let dateValue = '';
            if (currentValue) {
                const date = new Date(currentValue);
                dateValue = date.toISOString().split('T')[0];
            }
            
            const inputHtml = `
                <div id="dateEditDialog" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10000;">
                    <h4>Ch·ªçn ng√†y th·∫ø ch·∫•p</h4>
                    <input type="date" id="dateInput" class="form-control" value="${dateValue}" />
                    <div class="mt-3" style="text-align: right;">
                        <button class="btn btn-secondary" onclick="closeDateEditDialog()">H·ªßy</button>
                        <button class="btn btn-primary" onclick="saveDateEdit(${maLienKet}, '${fieldName}')">L∆∞u</button>
                    </div>
                </div>
                <div id="dateEditOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                     background: rgba(0,0,0,0.5); z-index: 9999;" onclick="closeDateEditDialog()"></div>
            `;
            
            $('body').append(inputHtml);
        }
        
        function closeDateEditDialog() {
            $('#dateEditDialog, #dateEditOverlay').remove();
        }
        
        async function saveDateEdit(maLienKet, fieldName) {
            const dateValue = $('#dateInput').val();
            
            if (!dateValue) {
                showAlertModal('Vui l√≤ng ch·ªçn ng√†y!', 'warning');
                return;
            }
            
            const updateData = {
                maLienKet: maLienKet,
                giaTriDinhGia: null,
                tyLeTheChap: null,
                ngayTheChap: dateValue,
                ghiChu: null
            };
            
            try {
                const response = await fetch('/QuanLyRuiRo/UpdateTaiSanThamDinh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
                    const displayValue = new Date(dateValue).toLocaleDateString('vi-VN');
                    $(`.value.editable[data-field="${fieldName}"][data-ma-lien-ket="${maLienKet}"]`).text(displayValue);
                    
                    closeDateEditDialog();
                    showNotification('ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
                } else {
                    showAlertModal('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t'), 'error');
                }
            } catch (error) {
                console.error('L·ªói khi c·∫≠p nh·∫≠t:', error);
                showAlertModal('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t!', 'error');
            }
        }
        
        // H√†m hi·ªÉn th·ªã th√¥ng b√°o toast
        function showNotification(message, type = 'info') {
            const colors = {
                'success': '#10b981',
                'error': '#ef4444',
                'info': '#3b82f6'
            };
            
            const notification = $(`
                <div style="position: fixed; top: 20px; right: 20px; padding: 15px 20px; 
                     background: ${colors[type]}; color: white; border-radius: 8px; 
                     box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10001; animation: slideIn 0.3s;">
                    ${message}
                </div>
            `);
            
            $('body').append(notification);
            
            setTimeout(() => {
                notification.fadeOut(300, function() {
                    $(this).remove();
                });
            }, 3000);
        }

        // H√†m hi·ªÉn th·ªã modal th√¥ng b√°o (thay th·∫ø alert)
        function showAlertModal(message, type = 'info', onClose = null) {
            const icons = {
                'success': '<i class="fas fa-check-circle" style="color: #10b981; font-size: 48px;"></i>',
                'error': '<i class="fas fa-times-circle" style="color: #ef4444; font-size: 48px;"></i>',
                'warning': '<i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 48px;"></i>',
                'info': '<i class="fas fa-info-circle" style="color: #3b82f6; font-size: 48px;"></i>'
            };

            const titles = {
                'success': 'Th√†nh c√¥ng',
                'error': 'L·ªói',
                'warning': 'C·∫£nh b√°o',
                'info': 'Th√¥ng b√°o'
            };

            // X√≥a modal c≈© n·∫øu c√≥
            $('.custom-alert-modal-overlay').remove();

            const modalHtml = `
                <div class="custom-alert-modal-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 20000;
                    animation: fadeIn 0.2s ease;
                ">
                    <div class="custom-alert-modal" style="
                        background: white;
                        border-radius: 16px;
                        padding: 30px;
                        max-width: 400px;
                        width: 90%;
                        text-align: center;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        animation: scaleIn 0.3s ease;
                    ">
                        <div style="margin-bottom: 20px;">
                            ${icons[type] || icons['info']}
                        </div>
                        <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 20px; font-weight: 600;">
                            ${titles[type] || titles['info']}
                        </h4>
                        <p style="margin: 0 0 25px 0; color: #6b7280; font-size: 15px; line-height: 1.6;">
                            ${message}
                        </p>
                        <button onclick="closeAlertModal()" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            padding: 12px 40px;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)';"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';">
                            ƒê√£ hi·ªÉu
                        </button>
                    </div>
                </div>
                <style>
                    @@keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @@keyframes scaleIn {
                        from { transform: scale(0.8); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                </style>
            `;

            $('body').append(modalHtml);
            window.alertModalCallback = onClose;
        }

        function closeAlertModal() {
            const overlay = $('.custom-alert-modal-overlay');
            overlay.fadeOut(200, function() {
                $(this).remove();
                if (window.alertModalCallback) {
                    window.alertModalCallback();
                    window.alertModalCallback = null;
                }
            });
        }

        // H√†m hi·ªÉn th·ªã modal x√°c nh·∫≠n (thay th·∫ø confirm)
        function showConfirmModal(message, onConfirm, onCancel = null) {
            // X√≥a modal c≈© n·∫øu c√≥
            $('.custom-confirm-modal-overlay').remove();

            const modalHtml = `
                <div class="custom-confirm-modal-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 20000;
                    animation: fadeIn 0.2s ease;
                ">
                    <div class="custom-confirm-modal" style="
                        background: white;
                        border-radius: 16px;
                        padding: 30px;
                        max-width: 420px;
                        width: 90%;
                        text-align: center;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        animation: scaleIn 0.3s ease;
                    ">
                        <div style="margin-bottom: 20px;">
                            <i class="fas fa-question-circle" style="color: #3b82f6; font-size: 48px;"></i>
                        </div>
                        <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 20px; font-weight: 600;">
                            X√°c nh·∫≠n
                        </h4>
                        <p style="margin: 0 0 25px 0; color: #6b7280; font-size: 15px; line-height: 1.6;">
                            ${message}
                        </p>
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button onclick="closeConfirmModal(false)" style="
                                background: #f3f4f6;
                                color: #374151;
                                border: 1px solid #d1d5db;
                                padding: 12px 30px;
                                border-radius: 8px;
                                font-size: 15px;
                                font-weight: 500;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='#e5e7eb';"
                               onmouseout="this.style.background='#f3f4f6';">
                                <i class="fas fa-times mr-2"></i> H·ªßy
                            </button>
                            <button onclick="closeConfirmModal(true)" style="
                                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                color: white;
                                border: none;
                                padding: 12px 30px;
                                border-radius: 8px;
                                font-size: 15px;
                                font-weight: 500;
                                cursor: pointer;
                                transition: all 0.2s ease;
                                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.5)';"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.4)';">
                                <i class="fas fa-check mr-2"></i> X√°c nh·∫≠n
                            </button>
                        </div>
                    </div>
                </div>
            `;

            $('body').append(modalHtml);
            window.confirmModalCallbackConfirm = onConfirm;
            window.confirmModalCallbackCancel = onCancel;
        }

        function closeConfirmModal(confirmed) {
            const overlay = $('.custom-confirm-modal-overlay');
            overlay.fadeOut(200, function() {
                $(this).remove();
                if (confirmed && window.confirmModalCallbackConfirm) {
                    window.confirmModalCallbackConfirm();
                } else if (!confirmed && window.confirmModalCallbackCancel) {
                    window.confirmModalCallbackCancel();
                }
                window.confirmModalCallbackConfirm = null;
                window.confirmModalCallbackCancel = null;
            });
        }

        function closeAssessmentModal() {
            $('#assessmentModal').fadeOut(300);
        }

        function saveDraftAssessment() {
            saveAssessment('ƒêang ƒë√°nh gi√°');
        }

        function saveAssessment(trangThai) {
            const tongDiemStr = $('#assessTongDiem').val();
            const tongDiem = tongDiemStr ? parseFloat(tongDiemStr.replace(',', '.')) : null;
            
            // L·∫•y nh·∫≠n x√©t v√† c·∫Øt ng·∫Øn n·∫øu qu√° d√†i (gi·ªõi h·∫°n 1000 k√Ω t·ª± trong database)
            let nhanXet = $('#assessNhanXet').val() || '';
            if (nhanXet && nhanXet.length > 900) {
                nhanXet = nhanXet.substring(0, 900);
            }
            
            const data = {
                maKhoanVay: parseInt($('#assessMaKhoanVay').val()),
                tongDiem: tongDiem,
                mucDoRuiRo: $('#assessMucDoRuiRo').val() || null,
                xepHangRuiRo: $('#assessXepHang').val() || null,
                kienNghi: $('#assessKienNghi').val() || null,
                nhanXet: nhanXet || null,
                trangThai: trangThai
            };

            console.log('D·ªØ li·ªáu g·ª≠i ƒëi:', data);

            // S·ª≠ d·ª•ng jQuery AJAX v·ªõi c·∫•u h√¨nh t·ªëi ∆∞u ƒë·ªÉ tr√°nh l·ªói HTTP/2
            $.ajax({
                url: '@Url.Action("SaveDanhGiaRuiRoForm", "QuanLyRuiRo")',
                type: 'POST',
                data: data,
                dataType: 'json',
                timeout: 30000,
                success: function(response) {
                    console.log('Response t·ª´ server:', response);
                    if (response.success) {
                        showNotification(response.message || 'L∆∞u ƒë√°nh gi√° th√†nh c√¥ng!', 'success');
                        closeAssessmentModal();
                        loadKhoanVayData();
                    } else {
                        showNotification('L·ªói: ' + (response.message || 'Kh√¥ng th·ªÉ l∆∞u ƒë√°nh gi√°'), 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('AJAX Error:', status, error);
                    // N·∫øu c√≥ l·ªói HTTP/2, th·ª≠ fallback v·ªõi form submit th·ª±c s·ª±
                    if (status === 'error' || status === 'timeout') {
                        console.log('Th·ª≠ g·ª≠i b·∫±ng form submit th·ª±c...');
                        submitViaRealForm(data);
                    } else {
                        showNotification('L·ªói k·∫øt n·ªëi: ' + (error || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'), 'error');
                    }
                }
            });
        }
        
        // Fallback: g·ª≠i d·ªØ li·ªáu qua form submit th·ª±c s·ª± (kh√¥ng d√πng fetch/ajax)
        function submitViaRealForm(data) {
            // T·∫°o form ·∫©n v√† submit th·ª±c s·ª±
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("SaveDanhGiaRuiRoFormRedirect", "QuanLyRuiRo")';
            form.style.display = 'none';
            
            for (const key in data) {
                if (data[key] !== null && data[key] !== undefined) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = data[key];
                    form.appendChild(input);
                }
            }
            
            document.body.appendChild(form);
            form.submit(); // Submit th·ª±c s·ª±, s·∫Ω redirect
        }

        // H√†m xem th√¥ng tin CIC
        async function xemThongTinCIC() {
            const maKhoanVay = $('#assessMaKhoanVay').val();
            if (!maKhoanVay) {
                showNotification('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c kho·∫£n vay!', 'warning');
                return;
            }

            try {
                const response = await fetch(`/QuanLyRuiRo/GetThongTinCic?maKhoanVay=${maKhoanVay}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    displayCicInfo(result.data);
                    $('#cicInfoSection').slideDown();
                    
                    // T·ª± ƒë·ªông ƒëi·ªÅn ƒë√°nh gi√° r·ªßi ro d·ª±a tr√™n CIC cho kho·∫£n vay kh√¥ng c√≥ t√†i s·∫£n ƒë·∫£m b·∫£o
                    // (v√≠ d·ª•: vay sinh vi√™n, vay t√≠n ch·∫•p doanh nghi·ªáp)
                    autoFillRiskAssessmentFromCIC(result.data);
                } else {
                    $('#cicInfoContent').html(`
                        <div class="text-warning">
                            <strong>‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y th√¥ng tin CIC</strong>
                            <p class="mb-0 mt-2">${result.message || 'Kh√°ch h√†ng ch∆∞a c√≥ l·ªãch s·ª≠ t√≠n d·ª•ng trong h·ªá th·ªëng CIC.'}</p>
                        </div>
                    `);
                    $('#cicInfoSection').slideDown();
                }
            } catch (error) {
                console.error('L·ªói khi l·∫•y th√¥ng tin CIC:', error);
                showAlertModal('C√≥ l·ªói x·∫£y ra khi l·∫•y th√¥ng tin CIC: ' + error.message, 'error');
            }
        }

        // H√†m t·ª± ƒë·ªông ƒëi·ªÅn ƒë√°nh gi√° r·ªßi ro d·ª±a tr√™n CIC cho kho·∫£n vay kh√¥ng c√≥ t√†i s·∫£n ƒë·∫£m b·∫£o
        function autoFillRiskAssessmentFromCIC(cic) {
            // Ki·ªÉm tra xem kho·∫£n vay c√≥ t√†i s·∫£n ƒë·∫£m b·∫£o kh√¥ng
            const loanInfo = window.currentLoanInfo;
            if (!loanInfo) return;

            // Ch·ªâ t·ª± ƒë·ªông ƒëi·ªÅn cho c√°c kho·∫£n vay:
            // 1. Kh√¥ng c√≥ t√†i s·∫£n ƒë·∫£m b·∫£o (vay t√≠n ch·∫•p)
            // 2. Ho·∫∑c l√† lo·∫°i vay sinh vi√™n
            const loaiVay = (loanInfo.loaiVay || '').toLowerCase();
            const isVaySinhVien = loaiVay.includes('sinh vi√™n') || loaiVay.includes('sinh vien');
            const isVayTinChap = loaiVay.includes('t√≠n ch·∫•p') || loaiVay.includes('tin chap');
            const khongCoTaiSan = !loanInfo.coTaiSanDamBao;

            if (!isVaySinhVien && !isVayTinChap && !khongCoTaiSan) {
                // C√≥ t√†i s·∫£n ƒë·∫£m b·∫£o v√† kh√¥ng ph·∫£i vay sinh vi√™n/t√≠n ch·∫•p -> kh√¥ng t·ª± ƒë·ªông ƒëi·ªÅn
                return;
            }

            // T√≠nh to√°n ƒë√°nh gi√° r·ªßi ro d·ª±a tr√™n ƒëi·ªÉm CIC
            const diemCIC = cic.diemTinDungCic || 0;
            const tyLeTraNoDungHan = cic.tyLeTraNoDungHanCic || 0;
            const soKhoanVayQuaHan = cic.soKhoanVayQuaHanCic || 0;
            const soKhoanVayNoXau = cic.soKhoanVayNoXauCic || 0;
            const khuyenNghiCIC = cic.khuyenNghiChoVay || '';

            // Thu·∫≠t to√°n t√≠nh ƒëi·ªÉm r·ªßi ro d·ª±a tr√™n CIC (thang 0-100, ƒëi·ªÉm c√†ng th·∫•p c√†ng t·ªët)
            let tongDiemRuiRo = 0;
            let mucDoRuiRo = '';
            let xepHang = '';
            let kienNghi = '';
            let nhanXet = '';

            // 1. ƒêi·ªÉm CIC (chi·∫øm 50% tr·ªçng s·ªë) - ƒëi·ªÉm CIC t·ª´ 0-1000
            // ƒêi·ªÉm CIC cao = r·ªßi ro th·∫•p
            const diemTuCIC = Math.max(0, 50 - (diemCIC / 1000 * 50)); // 0-50 ƒëi·ªÉm

            // 2. T·ª∑ l·ªá tr·∫£ n·ª£ ƒë√∫ng h·∫°n (chi·∫øm 25% tr·ªçng s·ªë)
            // T·ª∑ l·ªá cao = r·ªßi ro th·∫•p
            const diemTuTyLe = Math.max(0, 25 - (tyLeTraNoDungHan / 100 * 25)); // 0-25 ƒëi·ªÉm

            // 3. S·ªë kho·∫£n vay qu√° h·∫°n v√† n·ª£ x·∫•u (chi·∫øm 25% tr·ªçng s·ªë)
            const diemTuQuaHan = Math.min(25, soKhoanVayQuaHan * 5 + soKhoanVayNoXau * 10); // 0-25 ƒëi·ªÉm

            tongDiemRuiRo = Math.round((diemTuCIC + diemTuTyLe + diemTuQuaHan) * 10) / 10;

            // X√°c ƒë·ªãnh m·ª©c ƒë·ªô r·ªßi ro v√† x·∫øp h·∫°ng
            if (diemCIC >= 800 && tyLeTraNoDungHan >= 95 && soKhoanVayNoXau === 0) {
                mucDoRuiRo = 'Th·∫•p';
                xepHang = 'AAA';
                kienNghi = 'Ch·∫•p thu·∫≠n';
            } else if (diemCIC >= 700 && tyLeTraNoDungHan >= 85 && soKhoanVayNoXau === 0) {
                mucDoRuiRo = 'Th·∫•p';
                xepHang = 'AA';
                kienNghi = 'Ch·∫•p thu·∫≠n';
            } else if (diemCIC >= 600 && tyLeTraNoDungHan >= 75 && soKhoanVayNoXau <= 1) {
                mucDoRuiRo = 'Trung b√¨nh';
                xepHang = 'A';
                kienNghi = 'Ch·∫•p thu·∫≠n';
            } else if (diemCIC >= 500 && tyLeTraNoDungHan >= 65) {
                mucDoRuiRo = 'Trung b√¨nh';
                xepHang = 'BBB';
                kienNghi = 'C√¢n nh·∫Øc';
            } else if (diemCIC >= 400 && tyLeTraNoDungHan >= 50) {
                mucDoRuiRo = 'Cao';
                xepHang = 'BB';
                kienNghi = 'C√¢n nh·∫Øc';
            } else if (diemCIC >= 300) {
                mucDoRuiRo = 'Cao';
                xepHang = 'B';
                kienNghi = 'T·ª´ ch·ªëi';
            } else if (diemCIC >= 200) {
                mucDoRuiRo = 'R·∫•t cao';
                xepHang = 'C';
                kienNghi = 'T·ª´ ch·ªëi';
            } else {
                mucDoRuiRo = 'R·∫•t cao';
                xepHang = 'D';
                kienNghi = 'T·ª´ ch·ªëi';
            }

            // ƒêi·ªÅu ch·ªânh theo khuy·∫øn ngh·ªã CIC
            if (khuyenNghiCIC === 'KhongChoVay' && kienNghi !== 'T·ª´ ch·ªëi') {
                kienNghi = 'C√¢n nh·∫Øc';
            }

            // T·∫°o nh·∫≠n x√©t t·ª± ƒë·ªông
            nhanXet = `üìä ƒê√ÅNH GI√Å R·ª¶I RO D·ª∞A TR√äN ƒêI·ªÇM CIC (T·ª± ƒë·ªông)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìå LO·∫†I KHO·∫¢N VAY: ${loanInfo.loaiVay || 'N/A'}
${khongCoTaiSan ? '‚ö†Ô∏è ƒê√¢y l√† kho·∫£n vay KH√îNG C√ì T√ÄI S·∫¢N ƒê·∫¢M B·∫¢O\n' : ''}
üìà TH√îNG TIN CIC:
‚Ä¢ ƒêi·ªÉm t√≠n d·ª•ng CIC: ${diemCIC}/1000
‚Ä¢ X·∫øp h·∫°ng t√≠n d·ª•ng CIC: ${cic.xepHangTinDungCic || 'N/A'}
‚Ä¢ T·ª∑ l·ªá tr·∫£ n·ª£ ƒë√∫ng h·∫°n: ${tyLeTraNoDungHan}%
‚Ä¢ S·ªë kho·∫£n vay qu√° h·∫°n: ${soKhoanVayQuaHan}
‚Ä¢ S·ªë kho·∫£n vay n·ª£ x·∫•u: ${soKhoanVayNoXau}
‚Ä¢ T·ªïng d∆∞ n·ª£ hi·ªán t·∫°i: ${formatCurrency(cic.tongDuNoCic || 0)}

üîç PH√ÇN T√çCH:
‚Ä¢ ƒêi·ªÉm t·ª´ CIC: ${diemTuCIC.toFixed(1)}/50
‚Ä¢ ƒêi·ªÉm t·ª´ t·ª∑ l·ªá tr·∫£ n·ª£: ${diemTuTyLe.toFixed(1)}/25  
‚Ä¢ ƒêi·ªÉm t·ª´ n·ª£ qu√° h·∫°n: ${diemTuQuaHan.toFixed(1)}/25
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä T·ªîNG ƒêI·ªÇM R·ª¶I RO: ${tongDiemRuiRo}/100

üí° KHUY·∫æN NGH·ªä T·ª™ CIC: ${khuyenNghiCIC === 'ChoVay' ? '‚úÖ Cho vay' : khuyenNghiCIC === 'KhongChoVay' ? '‚ùå Kh√¥ng cho vay' : '‚ö†Ô∏è C·∫ßn th·∫≠n tr·ªçng'}
${cic.lyDoKhuyenNghi ? `L√Ω do: ${cic.lyDoKhuyenNghi}` : ''}`;

            // ƒêi·ªÅn v√†o form
            $('#assessTongDiem').val(tongDiemRuiRo);
            $('#assessMucDoRuiRo').val(mucDoRuiRo);
            $('#assessXepHang').val(xepHang);
            $('#assessKienNghi').val(kienNghi);
            $('#assessNhanXet').val(nhanXet);

            // Hi·ªÉn th·ªã th√¥ng b√°o
            showNotification(`‚úÖ ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn ƒë√°nh gi√° r·ªßi ro d·ª±a tr√™n ƒëi·ªÉm CIC (${diemCIC} ƒëi·ªÉm)`, 'success');
        }

        function displayCicInfo(cic) {
            // L∆∞u th√¥ng tin CIC v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ s·ª≠ d·ª•ng trong t√≠nh to√°n
            window.currentCicInfo = cic;
            
            const diemTinDung = cic.diemTinDungCic || 'N/A';
            const xepHang = cic.xepHangTinDungCic || 'N/A';
            const mucDoRuiRo = cic.mucDoRuiRo || 'N/A';
            const khaNangTraNo = cic.khaNangTraNo || 'N/A';
            const khuyenNghi = cic.khuyenNghiChoVay || 'N/A';
            
            // X√°c ƒë·ªãnh m√†u s·∫Øc d·ª±a tr√™n m·ª©c ƒë·ªô r·ªßi ro
            let riskColor = 'text-success';
            if (cic.mucDoRuiRo === 'Cao' || cic.mucDoRuiRo === 'R·∫•t cao') {
                riskColor = 'text-danger';
            } else if (cic.mucDoRuiRo === 'Trung b√¨nh') {
                riskColor = 'text-warning';
            }

            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm table-bordered mb-0">
                            <tr>
                                <th width="50%">M√£ CIC:</th>
                                <td><span class="code-badge">${cic.maCicCode}</span></td>
                            </tr>
                            <tr>
                                <th>H·ªç t√™n:</th>
                                <td>${cic.hoTen || 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>ƒêi·ªÉm t√≠n d·ª•ng CIC:</th>
                                <td><strong class="${riskColor}" style="font-size: 1.2em;">${diemTinDung}</strong>/1000</td>
                            </tr>
                            <tr>
                                <th>X·∫øp h·∫°ng t√≠n d·ª•ng:</th>
                                <td><span class="rating-badge">${xepHang}</span></td>
                            </tr>
                            <tr>
                                <th>M·ª©c ƒë·ªô r·ªßi ro:</th>
                                <td><span class="${riskColor}">${mucDoRuiRo}</span></td>
                            </tr>
                            <tr>
                                <th>Kh·∫£ nƒÉng tr·∫£ n·ª£:</th>
                                <td>${khaNangTraNo}</td>
                            </tr>
                            <tr>
                                <th>Khuy·∫øn ngh·ªã cho vay:</th>
                                <td><strong class="${khuyenNghi === 'ChoVay' ? 'text-success' : khuyenNghi === 'KhongChoVay' ? 'text-danger' : 'text-warning'}">${
                                    khuyenNghi === 'ChoVay' ? '‚úÖ Cho vay' : 
                                    khuyenNghi === 'KhongChoVay' ? '‚ùå Kh√¥ng cho vay' : 
                                    '‚ö†Ô∏è C·∫ßn th·∫≠n tr·ªçng'
                                }</strong></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm table-bordered mb-0">
                            <tr>
                                <th width="50%">T·ªïng s·ªë kho·∫£n vay:</th>
                                <td>${cic.tongSoKhoanVayCic}</td>
                            </tr>
                            <tr>
                                <th>Kho·∫£n vay ƒëang vay:</th>
                                <td>${cic.soKhoanVayDangVayCic}</td>
                            </tr>
                            <tr>
                                <th>Kho·∫£n vay ƒë√£ tr·∫£ xong:</th>
                                <td>${cic.soKhoanVayDaTraXongCic}</td>
                            </tr>
                            <tr>
                                <th>Kho·∫£n vay qu√° h·∫°n:</th>
                                <td class="${cic.soKhoanVayQuaHanCic > 0 ? 'text-danger' : ''}">${cic.soKhoanVayQuaHanCic}</td>
                            </tr>
                            <tr>
                                <th>Kho·∫£n vay n·ª£ x·∫•u:</th>
                                <td class="${cic.soKhoanVayNoXauCic > 0 ? 'text-danger font-weight-bold' : ''}">${cic.soKhoanVayNoXauCic}</td>
                            </tr>
                            <tr>
                                <th>T·ªïng d∆∞ n·ª£ hi·ªán t·∫°i:</th>
                                <td>${formatCurrency(cic.tongDuNoCic)}</td>
                            </tr>
                            <tr>
                                <th>D∆∞ n·ª£ n·ª£ x·∫•u:</th>
                                <td class="${cic.duNoNoXauCic > 0 ? 'text-danger' : ''}">${formatCurrency(cic.duNoNoXauCic)}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <table class="table table-sm table-bordered mb-0">
                            <tr>
                                <th width="25%">S·ªë l·∫ßn qu√° h·∫°n:</th>
                                <td width="25%" class="${cic.soLanQuaHanCic > 0 ? 'text-warning' : ''}">${cic.soLanQuaHanCic} l·∫ßn</td>
                                <th width="25%">S·ªë l·∫ßn n·ª£ x·∫•u:</th>
                                <td width="25%" class="${cic.soLanNoXauCic > 0 ? 'text-danger' : ''}">${cic.soLanNoXauCic} l·∫ßn</td>
                            </tr>
                            <tr>
                                <th>S·ªë ng√†y qu√° h·∫°n t·ªëi ƒëa:</th>
                                <td class="${cic.soNgayQuaHanToiDaCic > 30 ? 'text-danger' : ''}">${cic.soNgayQuaHanToiDaCic} ng√†y</td>
                                <th>T·ª∑ l·ªá tr·∫£ n·ª£ ƒë√∫ng h·∫°n:</th>
                                <td class="${cic.tyLeTraNoDungHanCic >= 90 ? 'text-success' : cic.tyLeTraNoDungHanCic >= 70 ? 'text-warning' : 'text-danger'}">${cic.tyLeTraNoDungHanCic}%</td>
                            </tr>
                        </table>
                    </div>
                </div>
                ${cic.danhGiaTongQuat ? `
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="alert alert-secondary mb-0 py-2">
                            <strong>ƒê√°nh gi√° t·ªïng quan:</strong> ${cic.danhGiaTongQuat}
                        </div>
                    </div>
                </div>
                ` : ''}
                ${cic.lyDoKhuyenNghi ? `
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="alert ${khuyenNghi === 'ChoVay' ? 'alert-success' : khuyenNghi === 'KhongChoVay' ? 'alert-danger' : 'alert-warning'} mb-0 py-2">
                            <strong>L√Ω do khuy·∫øn ngh·ªã:</strong> ${cic.lyDoKhuyenNghi}
                        </div>
                    </div>
                </div>
                ` : ''}
                <div class="row mt-2">
                    <div class="col-12 text-right">
                        <small class="text-muted">Ng√†y tra c·ª©u cu·ªëi: ${cic.ngayTraCuuCuoi ? new Date(cic.ngayTraCuuCuoi).toLocaleDateString('vi-VN') : 'N/A'}</small>
                    </div>
                </div>
            `;
            
            $('#cicInfoContent').html(html);
        }

        // X·ª≠ l√Ω submit form
        $(document).ready(function() {
            $('#formDanhGia').submit(function(e) {
                e.preventDefault();
                
                // Validate
                if (!$('#assessTongDiem').val() || !$('#assessMucDoRuiRo').val() || 
                    !$('#assessXepHang').val() || !$('#assessKienNghi').val()) {
                    showAlertModal('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc!', 'warning');
                    return;
                }

                showConfirmModal('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ho√†n th√†nh ƒë√°nh gi√° n√†y?', function() {
                    saveAssessment('ƒê√£ ƒë√°nh gi√°');
                });
            });

            // ƒê√≥ng modal khi click b√™n ngo√†i
            $('#assessmentModal').click(function(e) {
                if (e.target.id === 'assessmentModal') {
                    closeAssessmentModal();
                }
            });
        });
    </script>
}

